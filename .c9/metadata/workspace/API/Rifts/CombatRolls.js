{"filter":false,"title":"CombatRolls.js","tooltip":"/API/Rifts/CombatRolls.js","undoManager":{"mark":35,"position":35,"stack":[[{"start":{"row":0,"column":0},"end":{"row":285,"column":0},"action":"insert","lines":["//!attack --[[1d20]] --[[3d6]] --saying! --ammotype","/*global OuterDiv PlaySound TopBar iPart MidBar BottBar MakeRollNum log on findObjs randomInteger RollRight _ sendChat bShadow font getObj"," */","on('chat:message', function(msg) {","\tif (msg.type != \"api\") return;","\t//log(msg.content);","\tvar msgTxt = msg.content;","\tvar command = msgTxt.split(\" \", 1);","\tvar cWho = findObjs({_type: 'character',name: msg.who})[0];","\tif (cWho == undefined && msg.who.indexOf(\"(GM)\") == -1) {","\t\tcWho = RollRight(msg.playerid);","\t\tmsg.who = cWho.get(\"name\");","\t}","","/*-----------CHECK API-----------*/","\tif (command == \"!attack\") {","/*-----------BOXES-----------*/","\t\tvar Main;","\t\tvar PlayerBGColor = getObj(\"player\", msg.playerid).get(\"color\");","\t\tvar PRGB = hexToRgbP(PlayerBGColor);","        var PlayerBarColor = \"background-image: -webkit-linear-gradient(left, rgba(0,0,0,0.8),\"+PRGB+\",\"+PRGB+\",rgba(0,0,0,0.8));\";","\t\tvar MIDBAR = MakeMid(MidBar,PlayerBGColor,PlayerBarColor);","\t\tvar RollColor = \"background-image:-webkit-linear-gradient(left, #000000,#820101,#000000);\";","\t\tvar topimg = \"https://s3.amazonaws.com/files.staging.d20.io/images/181118/cN5ui3MXx87UBgVUgzwYTQ/med.jpg?141868063\";","\t\tvar TextShadow = \"-1px -1px #444, 1px -1px #444, -1px 1px #444, 1px 1px #444\";","\t\tvar SayParts = \"<div style='text-shadow: 1px 1px #000, -1px -1px #000, -1px 1px #000, 1px -1px #000; margin: 0em 0em 0em 0em;; font-size:8pt; display:inline-block; text-align: center; vertical-align:middle; padding: 0px 6px 0px 6px; border: 1px solid #000; border-radius: 3px; color: #FFF; background-image: url(\" + topimg + \");'>\";","\t\tvar RollDiv = \"<div style='margin: 0em 0.1em 0.1em 0em; font-size: 10pt; text-shadow: \" + TextShadow + \"; width: 15px; height: 15px; line-height: 15px; display:inline-block; text-align:center; padding: 0px 1px 0px 0px; border: 1px solid #000; border-radius: 3px; color: #FFF;\";","\t\tvar MainSayDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family:\" + font + \"; font-size: x-small; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-top: 2px solid #000; border-radius: 0px; background-color:#CEC7B6; color: #000;'>\";","\t\tvar MainEvenDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #CEC7B6; color: #000;'>\";","\t\tvar MainOddDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #C0B9A8; color: #000;'>\";","\t\tvar AmmoDiv =  \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; font-family: \" + font + \"; font-size: 8pt; text-align: center; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; color: #000;\";","/*---------------------------*/","\t\tvar who = msg.who;","\t\tmsg.content = MakeRollNum(msg.content, msg.inlinerolls);","//check rolls---------------------","\t\tvar AttackRolls = msg.inlinerolls[0];","\t\tvar DamageRolls = msg.inlinerolls[1];","//define var----------------------","\t\tif (AttackRolls === undefined || DamageRolls === undefined) {","\t\t\tsendChat('', \"/direct <B><I>bad macro!\");","\t\t\treturn;","\t\t}","\t\tmsgFormula = msgTxt.split(\" --\");","\t\tvar Lucky = 20;","\t\tvar failRange = 1;","\t\tvar DamageRollRaw = \"\";","\t\tvar BottomText = \"\";","\t\tvar fumble = 0;","\t\tvar miss = 0;","\t\tvar crit_img = \"http:\\\\//media.giphy.com/media/3KqZp8MBaf1Ty/giphy.gif\";","\t\tvar fail_img = \"http:\\\\//fc06.deviantart.net/fs70/f/2013/076/5/2/_tutorial__creating_an_animated_light_pulse_in_ps_by_d_k0d3-d5ybir4.gif\";","\t\tif (msg.who == \"GM (GM)\") {","\t\t\twho = \"NPC\";","\t\t}","/*-----------START-----------*/","//Check for GUN","\t\tif (who !== \"NPC\") {","\t\t\tif (msgFormula[4] === undefined) msgFormula[4] = msgFormula[3];","\t\t\tif (msgFormula[4] !== undefined) {","\t\t\t\tvar gunleng = msgFormula[4].length - 1;","\t\t\t\tvar ammo = parseInt(msgFormula[4].substr(gunleng), 10);","\t\t\t\tif (!isNaN(ammo)) {","\t\t\t\t\tgunleng = msgFormula[4].length - 2;","\t\t\t\t\tvar gun = msgFormula[4].substr(0, gunleng);","\t\t\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (FindGun == undefined) {","\t\t\t\t\t\tsendChat('Error', \"/desc \" + msg.who + \" You do not own a  \" + gun);","\t\t\t\t\t\treturn;","\t\t\t\t\t}","\t\t\t\t\tvar GunName = FindGun.get(\"name\");","\t\t\t\t\tvar leng = GunName.length - 5;","\t\t\t\t\tleng = GunName.substr(0, leng);","\t\t\t\t\tvar ammo0 = findObjs({name: leng + \"_WEAPpay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (ammo0 == undefined) {","\t\t\t\t\t\tammo0 = FindGun;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t}","/*-----------ATTACK PARTS-----------*/","//--Attack Modifier","\t\tvar AttackBonus;","\t\tvar AttackRollText;","\t\tif (AttackRolls.results.rolls[1] === undefined) AttackBonus = \"\";","\t\telse AttackBonus = (AttackRolls.results.rolls[1].expr);","\t\tvar AttackRollRaw = AttackRolls.results.rolls[0].results[0]['v'];","//Attack total and type","\t\tvar AttackTotal = (AttackRolls.results.total);","\t\tvar Atype = \"<a style='color:RED'>\" + AttackRolls.expression + \"</a>\";","//--Set Miss","\t\tif (AttackRollRaw <= 3) {","\t\t\tAttackRollText = RollDiv + \"background-color:#A80000;'>\" + AttackRollRaw + \"</div>\";","\t\t\tBottomText = BottomText + \" \" + 'MISS';","\t\t\tvar miss = 1;","\t\t}","\t\telse AttackRollText = RollDiv + \"background-color:#696969;'>\" + AttackRollRaw + \"</div>\";","/*-----------DAMAGE PARTS-----------*/","//--Damage modifier","\t\tvar DamageBonus;","\t\tif (DamageRolls.results.rolls[1] === undefined) DamageBonus = \"\";","\t\telse DamageBonus = (DamageRolls.results.rolls[1].expr);","\t\t//--Set damage total","\t\tvar DamageTotal = DamageRolls.results.total;","//--Make damage text for all rolls","\t\tvar dam = DamageRolls.results.rolls[0];","\t\tvar i = 0;","\t\twhile (dam.results[i] !== undefined) {","\t\t\tvar dNum = dam.results[i]['v'];","\t\t\tvar num;","\t\t\tvar ddimg = \"http://image.blingee.com.s3.amazonaws.com/images19/content/output/000/000/000/061/788808721_1076628.gif?4\";","\t\t\tvar bg_max = \"background-position:center; background-image: url(\" + ddimg + \");\";","\t\t\tif (dNum == 1) num = RollDiv + \"background-color:#A80000;'>\" + dNum + \"</div></b></a>\";","\t\t\telse if (dNum == DamageRolls.results.rolls[0].sides) num = RollDiv + \"background-color:#00A120;\" + bg_max + \"'><b>\" + dNum + \"</b></div></b></a>\";","\t\t\telse num = RollDiv + \"background-color:#696969;'>\" + dNum + \"</div>\";","\t\t\tDamageRollRaw = DamageRollRaw + \"\" + (num);","\t\t\ti++;","\t\t}","\t\tvar Dtype = \"<a style='color:RED;'>\" + DamageRolls.expression + \"</a>\";","\t\tDamageRollRaw = DamageRollRaw + \"<b>\" + DamageBonus + \"</b>\";","\t\tvar DTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a>\";","\t\tif (miss == 1)  DTOTALS = \"\";","//--Set Double Damage","\t\tif (AttackRollRaw >= 20) {","\t\t    var CritCheer = '<div style=\"border: 1px solid #666666; border-radius: 20px; width: 99%; height: 40px; overflow: hidden; position: relative;\"><img src=\"https://media.giphy.com/media/11sBLVxNs7v6WA/giphy.gif\" style=\"position: absolute; top:-35px; left:0px;\"/></div>';","\t\t\tDamageTotal = \"<a style='color:RED'><strong>\" + DamageTotal * 2 + \"!</strong></a>\";","\t\t\tvar DTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a><br>\"+CritCheer;","\t\t\tAttackTotal = \"<a style='color:RED'><strong>\" + AttackTotal + \"!</strong></a>\";","\t\t\tBottomText = BottomText + \" \" + '<b>DOUBLE DAMAGE!</b><BR><b>(NATURAL 20!)</b><br>';","\t\t\tRollColor = \"background-position:center; background-image: url(\" + crit_img + \");\";","\t\t\tPlaySound('Critical', 9000);","\t\t}","//set motto","\t\tif (msgFormula[3] !== undefined) {","\t\t\tvar WarCryleng = msgFormula[3].length - 1;","\t\t\tvar sayingCheck = parseInt(msgFormula[3].substr(WarCryleng), 10);","\t\t\tif (isNaN(sayingCheck)) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t}","\t\t\telse if (msgFormula[3] !== undefined && msgFormula[4] == undefined) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t\tWarCryleng = msgFormula[3].length - 2;","\t\t\t\tvar WarCry = msgFormula[3].substr(0, WarCryleng).toUpperCase();","\t\t\t}","\t\t}","\t\telse {","\t\t\tWarCry = \"ATTACK!\";","\t\t}","//CHATBOX PARTS----------------","\t\tMain = MainSayDiv + SayParts + \"<b><i><marquee><img src='logo.jpg'></marquee> ●\" + WarCry + \"●</i></b></div></div>\";","\t\tMain = Main + MainOddDiv + Atype + \" <b>To Hit: </b>\" + AttackRollText + \"<b>\" + AttackBonus + \" = <a style='color:BLUE'>\" + AttackTotal + \"</b></a></div>\";","\t\tMain = Main + MainEvenDiv + DTOTALS + \"</div>\";","//--Lucky roll","\t\tvar IsLucky = randomInteger(Lucky);","\t\tif (IsLucky >= Lucky && AttackRollRaw > 4) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><b>Lucky Shot!: \" + aLoc[Math.floor(Math.random() * aLoc.length)] + \"</b></div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(http:\\\\//i.imgur.com/cFiEs5R.gif);\";","\t\t\tBottomText = BottomText + \" \" + SayParts + \"<b><i>●LUCKY SHOT●</i></b></div></div>\";","","//Fumble roll","\t\t}","\t\tif (AttackRollRaw <= failRange) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><strong style='font-size: 130%;'><b>Fumble!: \" + aFum[Math.floor(Math.random() * aFum.length)] + \"</div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(\" + fail_img + \");\";","\t\t\tBottomText = BottomText + \" \" + 'FUMBLE';","\t\t\tfumble = 1;","\t\t}","/*-----------","AMMO PARTS","-----------*/","\t\tif (FindGun !== undefined && who !== \"NPC\" && ammo0 !== undefined) {","\t\t\tvar ammoleng = msgFormula[4].length - 1;","\t\t\tvar ammo = parseInt(msgFormula[4].substr(ammoleng));","\t\t\tvar ammoC = parseInt(ammo);","\t\t\tif (ammoC === undefined || isNaN(ammoC)) ammoC = 1;","\t\t\tvar cAmmo = parseInt(ammo0.get(\"current\"));","\t\t\tvar mAmmo = parseInt(ammo0.get(\"max\"));","\t\t\tif (isNaN(cAmmo) || isNaN(mAmmo)) {","\t\t\t\tsendChat('Error', \"/desc Set ammo for  \" + gun);","\t\t\t\treturn;","\t\t\t}","\t\t\tvar per = (cAmmo / mAmmo) * 100;","\t\t\tif (mAmmo == 0) {}","\t\t\telse if (cAmmo <= 0 || cAmmo < ammoC) {","\t\t\t\tcAmmo = \"0\";","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tMain = AmmoDiv + \"background-color:RED;'><b><i>Not Enough \" + gun + \" ammo left in clip.</div>\";","\t\t\t}","\t\t\telse if (cAmmo <= 3 || cAmmo < ammoC) {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 3px;\"><div style=\"background-color: red; width: ' + per + '%; height: 5px; border-radius: 10px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#B82A2A;'><b><i>\" + cAmmo + \" \" + gun + \" ammo left in clip.</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t\telse {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 1px;\"><div style=\"background-color: orange; width: ' + per + '%; height: 3px; border-radius: 10px; margins: 0px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#A8A191;'><b><i>\" + cAmmo + \" of \" + mAmmo + \" \" + gun + \" ammo left</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t}","/*-----------SEND CHAT-----------*/","        var pad = \"\";","        if(BottomText == \"\") var pad = \"padding: 5px 1px;\";","\t\tvar MsgBox = TopBar + RollColor +\";'></div>\"+ MIDBAR +\"<b>\" + who + \"  Attacks</b></div>\"+Main+\"</div>\"+BottBar + pad + RollColor +\";'><b>\" + BottomText + \"</b></div>\";","\t\tvar SendT = MsgBox;","\t\tif (AttackRollRaw <= 3 && fumble != 1) {","\t\t\tSendT = \"<div style='opacity: 0.6;'><strong style='font-size: 90%;'>\" + SendT + \"</strong></div>\";","\t\t}","\t\tif (AttackRollRaw >= 20) {","\t\t\tSendT = \"<strong style='font-size: 130%;'>\" + SendT + \"</strong>\";","\t\t}","\t\tsendChat(who, '/direct ' + SendT);","\t\tPlaySound('dice', 9000);","\t\treturn;","\t}","//----------------------------","//RELOAD----------------","//----------------------------","\tif (command == \"!reload\") {","\t\tif (cWho !== undefined) {","\t\t\tvar msgFormula = msgTxt.split(\" --\");","\t\t\tvar gun = msgFormula[1];","\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (FindGun == undefined) {","\t\t\t\tsendChat('', '/desc ' + msg.who + ': <b>ammo not found</b>');","\t\t\t\treturn;","\t\t\t}","\t\t\tClips = 0;","\t\t\tvar attName = FindGun.get(\"name\");","\t\t\tvar Ammo0 = findObjs({name: attName + \"pay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Ammo1 = findObjs({name: attName + \"Rounds\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Clipsc = findObjs({name: attName + \"clip\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (Clipsc != undefined) {","\t\t\t\tvar Clips = parseInt(Clipsc.get(\"current\"), 10);","\t\t\t}","\t\t\tvar cWep = parseInt(Ammo0.get(\"current\"), 10);","\t\t\tvar mWep = parseInt(Ammo0.get(\"max\"), 10 );","\t\t\tvar cAmmo = parseInt(Ammo1.get(\"current\"), 10);","\t\t\tif (cAmmo <= 0) {","\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' NO AMMO TO RELOAD!</div>';","\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t}","\t\t\telse {","\t\t\t\tvar needed = mWep - cWep;","\t\t\t\tif (needed >= cAmmo) {","\t\t\t\t\tneeded = cAmmo;","\t\t\t\t}","\t\t\t\tif (Clips == 10) {","\t\t\t\t\tneeded = 1;","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = cAmmo;","\t\t\t\t\tAmmo0.set('current', mWep);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' is reloading: ' + needed + \" clips on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + 'Clips)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t\telse {","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = Math.round((cAmmo / mWep) * 10) / 10;","\t\t\t\t\tAmmo0.set('current', cWep + needed);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>\" + msg.who + ' is reloading ' + needed + \" Ammo on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + ' reloads)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t}","\t\t}","\t}","});","//---AUTO LOCATION ROLLS","var aLoc = [\"Head\", \"Left Arm\", \"Right Arm\", \"Left Leg\", \"Right Leg\", \"..Dangly Bits! (Main Body)\", \"FREE ATTACK!\"];","//---FUMBLE ROLLS","var aFum = [","\t\"Hit a totally different friendly target in general direction of aimed target (if possible)\",","\t\"Ungracefully fumbled the attack!, lose next attack\",","\t\"Got something in eye, lose this attack\",","\t\"Missed so badly, it makes the enemy see you and an easy target!\",","\t\"Total gun jam/broke weapon(or limb!).. useless this fight. Must get fixed.\",","\t\"Tripped!, next attack to get up\",","\t\"Miss and weapon jam! (GUN) jams, (MELEE) Missed and stuck in Wall/Floor/Tree/Off Balance/etc loose next attack\",","\t\"Missed, and draws sole aggression of the target\",","\t\"Somehow hit a Flying Squirrel!\",","\t\"Failed so badly nearest ally falls back to help.\"","];",""],"id":1}],[{"start":{"row":0,"column":0},"end":{"row":285,"column":0},"action":"remove","lines":["//!attack --[[1d20]] --[[3d6]] --saying! --ammotype","/*global OuterDiv PlaySound TopBar iPart MidBar BottBar MakeRollNum log on findObjs randomInteger RollRight _ sendChat bShadow font getObj"," */","on('chat:message', function(msg) {","\tif (msg.type != \"api\") return;","\t//log(msg.content);","\tvar msgTxt = msg.content;","\tvar command = msgTxt.split(\" \", 1);","\tvar cWho = findObjs({_type: 'character',name: msg.who})[0];","\tif (cWho == undefined && msg.who.indexOf(\"(GM)\") == -1) {","\t\tcWho = RollRight(msg.playerid);","\t\tmsg.who = cWho.get(\"name\");","\t}","","/*-----------CHECK API-----------*/","\tif (command == \"!attack\") {","/*-----------BOXES-----------*/","\t\tvar Main;","\t\tvar PlayerBGColor = getObj(\"player\", msg.playerid).get(\"color\");","\t\tvar PRGB = hexToRgbP(PlayerBGColor);","        var PlayerBarColor = \"background-image: -webkit-linear-gradient(left, rgba(0,0,0,0.8),\"+PRGB+\",\"+PRGB+\",rgba(0,0,0,0.8));\";","\t\tvar MIDBAR = MakeMid(MidBar,PlayerBGColor,PlayerBarColor);","\t\tvar RollColor = \"background-image:-webkit-linear-gradient(left, #000000,#820101,#000000);\";","\t\tvar topimg = \"https://s3.amazonaws.com/files.staging.d20.io/images/181118/cN5ui3MXx87UBgVUgzwYTQ/med.jpg?141868063\";","\t\tvar TextShadow = \"-1px -1px #444, 1px -1px #444, -1px 1px #444, 1px 1px #444\";","\t\tvar SayParts = \"<div style='text-shadow: 1px 1px #000, -1px -1px #000, -1px 1px #000, 1px -1px #000; margin: 0em 0em 0em 0em;; font-size:8pt; display:inline-block; text-align: center; vertical-align:middle; padding: 0px 6px 0px 6px; border: 1px solid #000; border-radius: 3px; color: #FFF; background-image: url(\" + topimg + \");'>\";","\t\tvar RollDiv = \"<div style='margin: 0em 0.1em 0.1em 0em; font-size: 10pt; text-shadow: \" + TextShadow + \"; width: 15px; height: 15px; line-height: 15px; display:inline-block; text-align:center; padding: 0px 1px 0px 0px; border: 1px solid #000; border-radius: 3px; color: #FFF;\";","\t\tvar MainSayDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family:\" + font + \"; font-size: x-small; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-top: 2px solid #000; border-radius: 0px; background-color:#CEC7B6; color: #000;'>\";","\t\tvar MainEvenDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #CEC7B6; color: #000;'>\";","\t\tvar MainOddDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #C0B9A8; color: #000;'>\";","\t\tvar AmmoDiv =  \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; font-family: \" + font + \"; font-size: 8pt; text-align: center; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; color: #000;\";","/*---------------------------*/","\t\tvar who = msg.who;","\t\tmsg.content = MakeRollNum(msg.content, msg.inlinerolls);","//check rolls---------------------","\t\tvar AttackRolls = msg.inlinerolls[0];","\t\tvar DamageRolls = msg.inlinerolls[1];","//define var----------------------","\t\tif (AttackRolls === undefined || DamageRolls === undefined) {","\t\t\tsendChat('', \"/direct <B><I>bad macro!\");","\t\t\treturn;","\t\t}","\t\tmsgFormula = msgTxt.split(\" --\");","\t\tvar Lucky = 20;","\t\tvar failRange = 1;","\t\tvar DamageRollRaw = \"\";","\t\tvar BottomText = \"\";","\t\tvar fumble = 0;","\t\tvar miss = 0;","\t\tvar crit_img = \"http:\\\\//media.giphy.com/media/3KqZp8MBaf1Ty/giphy.gif\";","\t\tvar fail_img = \"http:\\\\//fc06.deviantart.net/fs70/f/2013/076/5/2/_tutorial__creating_an_animated_light_pulse_in_ps_by_d_k0d3-d5ybir4.gif\";","\t\tif (msg.who == \"GM (GM)\") {","\t\t\twho = \"NPC\";","\t\t}","/*-----------START-----------*/","//Check for GUN","\t\tif (who !== \"NPC\") {","\t\t\tif (msgFormula[4] === undefined) msgFormula[4] = msgFormula[3];","\t\t\tif (msgFormula[4] !== undefined) {","\t\t\t\tvar gunleng = msgFormula[4].length - 1;","\t\t\t\tvar ammo = parseInt(msgFormula[4].substr(gunleng), 10);","\t\t\t\tif (!isNaN(ammo)) {","\t\t\t\t\tgunleng = msgFormula[4].length - 2;","\t\t\t\t\tvar gun = msgFormula[4].substr(0, gunleng);","\t\t\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (FindGun == undefined) {","\t\t\t\t\t\tsendChat('Error', \"/desc \" + msg.who + \" You do not own a  \" + gun);","\t\t\t\t\t\treturn;","\t\t\t\t\t}","\t\t\t\t\tvar GunName = FindGun.get(\"name\");","\t\t\t\t\tvar leng = GunName.length - 5;","\t\t\t\t\tleng = GunName.substr(0, leng);","\t\t\t\t\tvar ammo0 = findObjs({name: leng + \"_WEAPpay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (ammo0 == undefined) {","\t\t\t\t\t\tammo0 = FindGun;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t}","/*-----------ATTACK PARTS-----------*/","//--Attack Modifier","\t\tvar AttackBonus;","\t\tvar AttackRollText;","\t\tif (AttackRolls.results.rolls[1] === undefined) AttackBonus = \"\";","\t\telse AttackBonus = (AttackRolls.results.rolls[1].expr);","\t\tvar AttackRollRaw = AttackRolls.results.rolls[0].results[0]['v'];","//Attack total and type","\t\tvar AttackTotal = (AttackRolls.results.total);","\t\tvar Atype = \"<a style='color:RED'>\" + AttackRolls.expression + \"</a>\";","//--Set Miss","\t\tif (AttackRollRaw <= 3) {","\t\t\tAttackRollText = RollDiv + \"background-color:#A80000;'>\" + AttackRollRaw + \"</div>\";","\t\t\tBottomText = BottomText + \" \" + 'MISS';","\t\t\tvar miss = 1;","\t\t}","\t\telse AttackRollText = RollDiv + \"background-color:#696969;'>\" + AttackRollRaw + \"</div>\";","/*-----------DAMAGE PARTS-----------*/","//--Damage modifier","\t\tvar DamageBonus;","\t\tif (DamageRolls.results.rolls[1] === undefined) DamageBonus = \"\";","\t\telse DamageBonus = (DamageRolls.results.rolls[1].expr);","\t\t//--Set damage total","\t\tvar DamageTotal = DamageRolls.results.total;","//--Make damage text for all rolls","\t\tvar dam = DamageRolls.results.rolls[0];","\t\tvar i = 0;","\t\twhile (dam.results[i] !== undefined) {","\t\t\tvar dNum = dam.results[i]['v'];","\t\t\tvar num;","\t\t\tvar ddimg = \"http://image.blingee.com.s3.amazonaws.com/images19/content/output/000/000/000/061/788808721_1076628.gif?4\";","\t\t\tvar bg_max = \"background-position:center; background-image: url(\" + ddimg + \");\";","\t\t\tif (dNum == 1) num = RollDiv + \"background-color:#A80000;'>\" + dNum + \"</div></b></a>\";","\t\t\telse if (dNum == DamageRolls.results.rolls[0].sides) num = RollDiv + \"background-color:#00A120;\" + bg_max + \"'><b>\" + dNum + \"</b></div></b></a>\";","\t\t\telse num = RollDiv + \"background-color:#696969;'>\" + dNum + \"</div>\";","\t\t\tDamageRollRaw = DamageRollRaw + \"\" + (num);","\t\t\ti++;","\t\t}","\t\tvar Dtype = \"<a style='color:RED;'>\" + DamageRolls.expression + \"</a>\";","\t\tDamageRollRaw = DamageRollRaw + \"<b>\" + DamageBonus + \"</b>\";","\t\tvar DTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a>\";","\t\tif (miss == 1)  DTOTALS = \"\";","//--Set Double Damage","\t\tif (AttackRollRaw >= 20) {","\t\t    var CritCheer = '<div style=\"border: 1px solid #666666; border-radius: 20px; width: 99%; height: 40px; overflow: hidden; position: relative;\"><img src=\"https://media.giphy.com/media/11sBLVxNs7v6WA/giphy.gif\" style=\"position: absolute; top:-35px; left:0px;\"/></div>';","\t\t\tDamageTotal = \"<a style='color:RED'><strong>\" + DamageTotal * 2 + \"!</strong></a>\";","\t\t\tvar DTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a><br>\"+CritCheer;","\t\t\tAttackTotal = \"<a style='color:RED'><strong>\" + AttackTotal + \"!</strong></a>\";","\t\t\tBottomText = BottomText + \" \" + '<b>DOUBLE DAMAGE!</b><BR><b>(NATURAL 20!)</b><br>';","\t\t\tRollColor = \"background-position:center; background-image: url(\" + crit_img + \");\";","\t\t\tPlaySound('Critical', 9000);","\t\t}","//set motto","\t\tif (msgFormula[3] !== undefined) {","\t\t\tvar WarCryleng = msgFormula[3].length - 1;","\t\t\tvar sayingCheck = parseInt(msgFormula[3].substr(WarCryleng), 10);","\t\t\tif (isNaN(sayingCheck)) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t}","\t\t\telse if (msgFormula[3] !== undefined && msgFormula[4] == undefined) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t\tWarCryleng = msgFormula[3].length - 2;","\t\t\t\tvar WarCry = msgFormula[3].substr(0, WarCryleng).toUpperCase();","\t\t\t}","\t\t}","\t\telse {","\t\t\tWarCry = \"ATTACK!\";","\t\t}","//CHATBOX PARTS----------------","\t\tMain = MainSayDiv + SayParts + \"<b><i><marquee><img src='logo.jpg'></marquee> ●\" + WarCry + \"●</i></b></div></div>\";","\t\tMain = Main + MainOddDiv + Atype + \" <b>To Hit: </b>\" + AttackRollText + \"<b>\" + AttackBonus + \" = <a style='color:BLUE'>\" + AttackTotal + \"</b></a></div>\";","\t\tMain = Main + MainEvenDiv + DTOTALS + \"</div>\";","//--Lucky roll","\t\tvar IsLucky = randomInteger(Lucky);","\t\tif (IsLucky >= Lucky && AttackRollRaw > 4) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><b>Lucky Shot!: \" + aLoc[Math.floor(Math.random() * aLoc.length)] + \"</b></div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(http:\\\\//i.imgur.com/cFiEs5R.gif);\";","\t\t\tBottomText = BottomText + \" \" + SayParts + \"<b><i>●LUCKY SHOT●</i></b></div></div>\";","","//Fumble roll","\t\t}","\t\tif (AttackRollRaw <= failRange) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><strong style='font-size: 130%;'><b>Fumble!: \" + aFum[Math.floor(Math.random() * aFum.length)] + \"</div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(\" + fail_img + \");\";","\t\t\tBottomText = BottomText + \" \" + 'FUMBLE';","\t\t\tfumble = 1;","\t\t}","/*-----------","AMMO PARTS","-----------*/","\t\tif (FindGun !== undefined && who !== \"NPC\" && ammo0 !== undefined) {","\t\t\tvar ammoleng = msgFormula[4].length - 1;","\t\t\tvar ammo = parseInt(msgFormula[4].substr(ammoleng));","\t\t\tvar ammoC = parseInt(ammo);","\t\t\tif (ammoC === undefined || isNaN(ammoC)) ammoC = 1;","\t\t\tvar cAmmo = parseInt(ammo0.get(\"current\"));","\t\t\tvar mAmmo = parseInt(ammo0.get(\"max\"));","\t\t\tif (isNaN(cAmmo) || isNaN(mAmmo)) {","\t\t\t\tsendChat('Error', \"/desc Set ammo for  \" + gun);","\t\t\t\treturn;","\t\t\t}","\t\t\tvar per = (cAmmo / mAmmo) * 100;","\t\t\tif (mAmmo == 0) {}","\t\t\telse if (cAmmo <= 0 || cAmmo < ammoC) {","\t\t\t\tcAmmo = \"0\";","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tMain = AmmoDiv + \"background-color:RED;'><b><i>Not Enough \" + gun + \" ammo left in clip.</div>\";","\t\t\t}","\t\t\telse if (cAmmo <= 3 || cAmmo < ammoC) {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 3px;\"><div style=\"background-color: red; width: ' + per + '%; height: 5px; border-radius: 10px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#B82A2A;'><b><i>\" + cAmmo + \" \" + gun + \" ammo left in clip.</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t\telse {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 1px;\"><div style=\"background-color: orange; width: ' + per + '%; height: 3px; border-radius: 10px; margins: 0px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#A8A191;'><b><i>\" + cAmmo + \" of \" + mAmmo + \" \" + gun + \" ammo left</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t}","/*-----------SEND CHAT-----------*/","        var pad = \"\";","        if(BottomText == \"\") var pad = \"padding: 5px 1px;\";","\t\tvar MsgBox = TopBar + RollColor +\";'></div>\"+ MIDBAR +\"<b>\" + who + \"  Attacks</b></div>\"+Main+\"</div>\"+BottBar + pad + RollColor +\";'><b>\" + BottomText + \"</b></div>\";","\t\tvar SendT = MsgBox;","\t\tif (AttackRollRaw <= 3 && fumble != 1) {","\t\t\tSendT = \"<div style='opacity: 0.6;'><strong style='font-size: 90%;'>\" + SendT + \"</strong></div>\";","\t\t}","\t\tif (AttackRollRaw >= 20) {","\t\t\tSendT = \"<strong style='font-size: 130%;'>\" + SendT + \"</strong>\";","\t\t}","\t\tsendChat(who, '/direct ' + SendT);","\t\tPlaySound('dice', 9000);","\t\treturn;","\t}","//----------------------------","//RELOAD----------------","//----------------------------","\tif (command == \"!reload\") {","\t\tif (cWho !== undefined) {","\t\t\tvar msgFormula = msgTxt.split(\" --\");","\t\t\tvar gun = msgFormula[1];","\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (FindGun == undefined) {","\t\t\t\tsendChat('', '/desc ' + msg.who + ': <b>ammo not found</b>');","\t\t\t\treturn;","\t\t\t}","\t\t\tClips = 0;","\t\t\tvar attName = FindGun.get(\"name\");","\t\t\tvar Ammo0 = findObjs({name: attName + \"pay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Ammo1 = findObjs({name: attName + \"Rounds\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Clipsc = findObjs({name: attName + \"clip\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (Clipsc != undefined) {","\t\t\t\tvar Clips = parseInt(Clipsc.get(\"current\"), 10);","\t\t\t}","\t\t\tvar cWep = parseInt(Ammo0.get(\"current\"), 10);","\t\t\tvar mWep = parseInt(Ammo0.get(\"max\"), 10 );","\t\t\tvar cAmmo = parseInt(Ammo1.get(\"current\"), 10);","\t\t\tif (cAmmo <= 0) {","\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' NO AMMO TO RELOAD!</div>';","\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t}","\t\t\telse {","\t\t\t\tvar needed = mWep - cWep;","\t\t\t\tif (needed >= cAmmo) {","\t\t\t\t\tneeded = cAmmo;","\t\t\t\t}","\t\t\t\tif (Clips == 10) {","\t\t\t\t\tneeded = 1;","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = cAmmo;","\t\t\t\t\tAmmo0.set('current', mWep);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' is reloading: ' + needed + \" clips on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + 'Clips)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t\telse {","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = Math.round((cAmmo / mWep) * 10) / 10;","\t\t\t\t\tAmmo0.set('current', cWep + needed);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>\" + msg.who + ' is reloading ' + needed + \" Ammo on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + ' reloads)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t}","\t\t}","\t}","});","//---AUTO LOCATION ROLLS","var aLoc = [\"Head\", \"Left Arm\", \"Right Arm\", \"Left Leg\", \"Right Leg\", \"..Dangly Bits! (Main Body)\", \"FREE ATTACK!\"];","//---FUMBLE ROLLS","var aFum = [","\t\"Hit a totally different friendly target in general direction of aimed target (if possible)\",","\t\"Ungracefully fumbled the attack!, lose next attack\",","\t\"Got something in eye, lose this attack\",","\t\"Missed so badly, it makes the enemy see you and an easy target!\",","\t\"Total gun jam/broke weapon(or limb!).. useless this fight. Must get fixed.\",","\t\"Tripped!, next attack to get up\",","\t\"Miss and weapon jam! (GUN) jams, (MELEE) Missed and stuck in Wall/Floor/Tree/Off Balance/etc loose next attack\",","\t\"Missed, and draws sole aggression of the target\",","\t\"Somehow hit a Flying Squirrel!\",","\t\"Failed so badly nearest ally falls back to help.\"","];",""],"id":2},{"start":{"row":0,"column":0},"end":{"row":284,"column":0},"action":"insert","lines":["//!attack --[[1d20]] --[[3d6]] --saying! --ammotype","/*global OuterDiv PlaySound TopBar iPart MidBar BottBar MakeRollNum log on findObjs randomInteger RollRight _ sendChat bShadow font getObj"," */","on('chat:message', function(msg) {","\tif (msg.type != \"api\") return;","\t//log(msg.content);","\tvar msgTxt = msg.content;","\tvar command = msgTxt.split(\" \", 1);","\tvar cWho = findObjs({_type: 'character',name: msg.who})[0];","\tif (cWho == undefined && msg.who.indexOf(\"(GM)\") == -1) {","\t\tcWho = RollRight(msg.playerid);","\t\tmsg.who = cWho.get(\"name\");","\t}","/*-----------CHECK API-----------*/","\tif (command == \"!attack\") {","/*-----------BOXES-----------*/","\t\tvar Main;","\t\tvar PlayerBGColor = getObj(\"player\", msg.playerid).get(\"color\");","\t\tvar PRGB = hexToRgbP(PlayerBGColor);","        var PlayerBarColor = \"background-image: -webkit-linear-gradient(left, rgba(0,0,0,0.8),\"+PRGB+\",\"+PRGB+\",rgba(0,0,0,0.8));\";","\t\tvar MIDBAR = MakeMid(MidBar,PlayerBGColor,PlayerBarColor);","\t\tvar RollColor = \"background-image:-webkit-linear-gradient(left, #000000,#820101,#000000);\";","\t\tvar topimg = \"https://s3.amazonaws.com/files.staging.d20.io/images/181118/cN5ui3MXx87UBgVUgzwYTQ/med.jpg?141868063\";","\t\tvar TextShadow = \"-1px -1px #444, 1px -1px #444, -1px 1px #444, 1px 1px #444\";","\t\tvar SayParts = \"<div style='text-shadow: 1px 1px #000, -1px -1px #000, -1px 1px #000, 1px -1px #000; margin: 0em 0em 0em 0em;; font-size:8pt; display:inline-block; text-align: center; vertical-align:middle; padding: 0px 6px 0px 6px; border: 1px solid #000; border-radius: 3px; color: #FFF; background-image: url(\" + topimg + \");'>\";","\t\tvar RollDiv = \"<div style='margin: 0em 0.1em 0.1em 0em; font-size: 10pt; text-shadow: \" + TextShadow + \"; width: 15px; height: 15px; line-height: 15px; display:inline-block; text-align:center; padding: 0px 1px 0px 0px; border: 1px solid #000; border-radius: 3px; color: #FFF;\";","\t\tvar MainSayDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family:\" + font + \"; font-size: x-small; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-top: 2px solid #000; border-radius: 0px; background-color:#CEC7B6; color: #000;'>\";","\t\tvar MainEvenDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #CEC7B6; color: #000;'>\";","\t\tvar MainOddDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #C0B9A8; color: #000;'>\";","\t\tvar AmmoDiv =  \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; font-family: \" + font + \"; font-size: 8pt; text-align: center; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; color: #000;\";","/*---------------------------*/","\t\tvar who = msg.who;","\t\tmsg.content = MakeRollNum(msg.content, msg.inlinerolls);","//check rolls---------------------","\t\tvar AttackRolls = msg.inlinerolls[0];","\t\tvar DamageRolls = msg.inlinerolls[1];","//define var----------------------","\t\tif (AttackRolls === undefined || DamageRolls === undefined) {","\t\t\tsendChat('', \"/direct <B><I>bad macro!\");","\t\t\treturn;","\t\t}","\t\tmsgFormula = msgTxt.split(\" --\");","\t\tvar Lucky = 20;","\t\tvar failRange = 1;","\t\tvar DamageRollRaw = \"\";","\t\tvar BottomText = \"\";","\t\tvar fumble = 0;","\t\tvar miss = 0;","\t\tvar crit_img = \"http:\\\\//media.giphy.com/media/3KqZp8MBaf1Ty/giphy.gif\";","\t\tvar fail_img = \"http:\\\\//fc06.deviantart.net/fs70/f/2013/076/5/2/_tutorial__creating_an_animated_light_pulse_in_ps_by_d_k0d3-d5ybir4.gif\";","\t\tif (msg.who == \"GM (GM)\") {","\t\t\twho = \"NPC\";","\t\t}","/*-----------START-----------*/","//Check for GUN","\t\tif (who !== \"NPC\") {","\t\t\tif (msgFormula[4] === undefined) msgFormula[4] = msgFormula[3];","\t\t\tif (msgFormula[4] !== undefined) {","\t\t\t\tvar gunleng = msgFormula[4].length - 1;","\t\t\t\tvar ammo = parseInt(msgFormula[4].substr(gunleng), 10);","\t\t\t\tif (!isNaN(ammo)) {","\t\t\t\t\tgunleng = msgFormula[4].length - 2;","\t\t\t\t\tvar gun = msgFormula[4].substr(0, gunleng);","\t\t\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (FindGun == undefined) {","\t\t\t\t\t\tsendChat('Error', \"/desc \" + msg.who + \" You do not own a  \" + gun);","\t\t\t\t\t\treturn;","\t\t\t\t\t}","\t\t\t\t\tvar GunName = FindGun.get(\"name\");","\t\t\t\t\tvar leng = GunName.length - 5;","\t\t\t\t\tleng = GunName.substr(0, leng);","\t\t\t\t\tvar ammo0 = findObjs({name: leng + \"_WEAPpay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (ammo0 == undefined) {","\t\t\t\t\t\tammo0 = FindGun;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t}","/*-----------ATTACK PARTS-----------*/","//--Attack Modifier","\t\tvar AttackBonus;","\t\tvar AttackRollText;","\t\tif (AttackRolls.results.rolls[1] === undefined) AttackBonus = \"\";","\t\telse AttackBonus = (AttackRolls.results.rolls[1].expr);","\t\tvar AttackRollRaw = AttackRolls.results.rolls[0].results[0]['v'];","//Attack total and type","\t\tvar AttackTotal = (AttackRolls.results.total);","\t\tvar Atype = \"<a style='color:RED'>\" + AttackRolls.expression + \"</a>\";","//--Set Miss","\t\tif (AttackRollRaw <= 3) {","\t\t\tAttackRollText = RollDiv + \"background-color:#A80000;'>\" + AttackRollRaw + \"</div>\";","\t\t\tBottomText = BottomText + \" \" + 'MISS';","\t\t\tvar miss = 1;","\t\t}","\t\telse AttackRollText = RollDiv + \"background-color:#696969;'>\" + AttackRollRaw + \"</div>\";","/*-----------DAMAGE PARTS-----------*/","//--Damage modifier","\t\tvar DamageBonus;","\t\tif (DamageRolls.results.rolls[1] === undefined) DamageBonus = \"\";","\t\telse DamageBonus = (DamageRolls.results.rolls[1].expr);","\t\t//--Set damage total","\t\tvar DamageTotal = DamageRolls.results.total;","//--Make damage text for all rolls","\t\tvar dam = DamageRolls.results.rolls[0];","\t\tvar i = 0;","\t\twhile (dam.results[i] !== undefined) {","\t\t\tvar dNum = dam.results[i]['v'];","\t\t\tvar num;","\t\t\tvar ddimg = \"http://image.blingee.com.s3.amazonaws.com/images19/content/output/000/000/000/061/788808721_1076628.gif?4\";","\t\t\tvar bg_max = \"background-position:center; background-image: url(\" + ddimg + \");\";","\t\t\tif (dNum == 1) num = RollDiv + \"background-color:#A80000;'>\" + dNum + \"</div></b></a>\";","\t\t\telse if (dNum == DamageRolls.results.rolls[0].sides) num = RollDiv + \"background-color:#00A120;\" + bg_max + \"'><b>\" + dNum + \"</b></div></b></a>\";","\t\t\telse num = RollDiv + \"background-color:#696969;'>\" + dNum + \"</div>\";","\t\t\tDamageRollRaw = DamageRollRaw + \"\" + (num);","\t\t\ti++;","\t\t}","\t\tvar Dtype = \"<a style='color:RED;'>\" + DamageRolls.expression + \"</a>\";","\t\tDamageRollRaw = DamageRollRaw + \"<b>\" + DamageBonus + \"</b>\";","\t\tvar DTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a>\";","\t\tif (miss == 1)  DTOTALS = \"\";","//--Set Double Damage","\t\tif (AttackRollRaw >= 20) {","\t\t    var CritCheer = '<div style=\"border: 1px solid #666666; border-radius: 20px; width: 99%; height: 40px; overflow: hidden; position: relative;\"><img src=\"https://media.giphy.com/media/11sBLVxNs7v6WA/giphy.gif\" style=\"position: absolute; top:-35px; left:0px;\"/></div>';","\t\t\tDamageTotal = \"<a style='color:RED'><strong>\" + DamageTotal * 2 + \"!</strong></a>\";","\t\t\tvar DTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a><br>\"+CritCheer;","\t\t\tAttackTotal = \"<a style='color:RED'><strong>\" + AttackTotal + \"!</strong></a>\";","\t\t\tBottomText = BottomText + \" \" + '<b>DOUBLE DAMAGE!</b><BR><b>(NATURAL 20!)</b><br>';","\t\t\tRollColor = \"background-position:center; background-image: url(\" + crit_img + \");\";","\t\t\tPlaySound('Critical', 9000);","\t\t}","//set motto","\t\tif (msgFormula[3] !== undefined) {","\t\t\tvar WarCryleng = msgFormula[3].length - 1;","\t\t\tvar sayingCheck = parseInt(msgFormula[3].substr(WarCryleng), 10);","\t\t\tif (isNaN(sayingCheck)) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t}","\t\t\telse if (msgFormula[3] !== undefined && msgFormula[4] == undefined) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t\tWarCryleng = msgFormula[3].length - 2;","\t\t\t\tvar WarCry = msgFormula[3].substr(0, WarCryleng).toUpperCase();","\t\t\t}","\t\t}","\t\telse {","\t\t\tWarCry = \"ATTACK!\";","\t\t}","//CHATBOX PARTS----------------","\t\tMain = MainSayDiv + SayParts + \"<b><i><marquee><img src='logo.jpg'></marquee> ●\" + WarCry + \"●</i></b></div></div>\";","\t\tMain = Main + MainOddDiv + Atype + \" <b>To Hit: </b>\" + AttackRollText + \"<b>\" + AttackBonus + \" = <a style='color:BLUE'>\" + AttackTotal + \"</b></a></div>\";","\t\tMain = Main + MainEvenDiv + DTOTALS + \"</div>\";","//--Lucky roll","\t\tvar IsLucky = randomInteger(Lucky);","\t\tif (IsLucky >= Lucky && AttackRollRaw > 4) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><b>Lucky Shot!: \" + aLoc[Math.floor(Math.random() * aLoc.length)] + \"</b></div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(http:\\\\//i.imgur.com/cFiEs5R.gif);\";","\t\t\tBottomText = BottomText + \" \" + SayParts + \"<b><i>●LUCKY SHOT●</i></b></div></div>\";","","//Fumble roll","\t\t}","\t\tif (AttackRollRaw <= failRange) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><strong style='font-size: 130%;'><b>Fumble!: \" + aFum[Math.floor(Math.random() * aFum.length)] + \"</div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(\" + fail_img + \");\";","\t\t\tBottomText = BottomText + \" \" + 'FUMBLE';","\t\t\tfumble = 1;","\t\t}","/*-----------","AMMO PARTS","-----------*/","\t\tif (FindGun !== undefined && who !== \"NPC\" && ammo0 !== undefined) {","\t\t\tvar ammoleng = msgFormula[4].length - 1;","\t\t\tvar ammo = parseInt(msgFormula[4].substr(ammoleng));","\t\t\tvar ammoC = parseInt(ammo);","\t\t\tif (ammoC === undefined || isNaN(ammoC)) ammoC = 1;","\t\t\tvar cAmmo = parseInt(ammo0.get(\"current\"));","\t\t\tvar mAmmo = parseInt(ammo0.get(\"max\"));","\t\t\tif (isNaN(cAmmo) || isNaN(mAmmo)) {","\t\t\t\tsendChat('Error', \"/desc Set ammo for  \" + gun);","\t\t\t\treturn;","\t\t\t}","\t\t\tvar per = (cAmmo / mAmmo) * 100;","\t\t\tif (mAmmo == 0) {}","\t\t\telse if (cAmmo <= 0 || cAmmo < ammoC) {","\t\t\t\tcAmmo = \"0\";","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tMain = AmmoDiv + \"background-color:RED;'><b><i>Not Enough \" + gun + \" ammo left in clip.</div>\";","\t\t\t}","\t\t\telse if (cAmmo <= 3 || cAmmo < ammoC) {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 3px;\"><div style=\"background-color: red; width: ' + per + '%; height: 5px; border-radius: 10px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#B82A2A;'><b><i>\" + cAmmo + \" \" + gun + \" ammo left in clip.</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t\telse {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 1px;\"><div style=\"background-color: orange; width: ' + per + '%; height: 3px; border-radius: 10px; margins: 0px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#A8A191;'><b><i>\" + cAmmo + \" of \" + mAmmo + \" \" + gun + \" ammo left</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t}","/*-----------SEND CHAT-----------*/","        var pad = \"\";","        if(BottomText == \"\") var pad = \"padding: 5px 1px;\";","\t\tvar MsgBox = TopBar + RollColor +\";'></div>\"+ MIDBAR +\"<b>\" + who + \"  Attacks</b></div>\"+Main+\"</div>\"+BottBar + pad + RollColor +\";'><b>\" + BottomText + \"</b></div>\";","\t\tvar SendT = MsgBox;","\t\tif (AttackRollRaw <= 3 && fumble != 1) {","\t\t\tSendT = \"<div style='opacity: 0.6;'><strong style='font-size: 90%;'>\" + SendT + \"</strong></div>\";","\t\t}","\t\tif (AttackRollRaw >= 20) {","\t\t\tSendT = \"<strong style='font-size: 130%;'>\" + SendT + \"</strong>\";","\t\t}","\t\tsendChat(who, '/direct ' + SendT);","\t\tPlaySound('dice', 9000);","\t\treturn;","\t}","//----------------------------","//RELOAD----------------","//----------------------------","\tif (command == \"!reload\") {","\t\tif (cWho !== undefined) {","\t\t\tvar msgFormula = msgTxt.split(\" --\");","\t\t\tvar gun = msgFormula[1];","\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (FindGun == undefined) {","\t\t\t\tsendChat('', '/desc ' + msg.who + ': <b>ammo not found</b>');","\t\t\t\treturn;","\t\t\t}","\t\t\tClips = 0;","\t\t\tvar attName = FindGun.get(\"name\");","\t\t\tvar Ammo0 = findObjs({name: attName + \"pay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Ammo1 = findObjs({name: attName + \"Rounds\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Clipsc = findObjs({name: attName + \"clip\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (Clipsc != undefined) {","\t\t\t\tvar Clips = parseInt(Clipsc.get(\"current\"), 10);","\t\t\t}","\t\t\tvar cWep = parseInt(Ammo0.get(\"current\"), 10);","\t\t\tvar mWep = parseInt(Ammo0.get(\"max\"), 10 );","\t\t\tvar cAmmo = parseInt(Ammo1.get(\"current\"), 10);","\t\t\tif (cAmmo <= 0) {","\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' NO AMMO TO RELOAD!</div>';","\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t}","\t\t\telse {","\t\t\t\tvar needed = mWep - cWep;","\t\t\t\tif (needed >= cAmmo) {","\t\t\t\t\tneeded = cAmmo;","\t\t\t\t}","\t\t\t\tif (Clips == 10) {","\t\t\t\t\tneeded = 1;","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = cAmmo;","\t\t\t\t\tAmmo0.set('current', mWep);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' is reloading: ' + needed + \" clips on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + 'Clips)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t\telse {","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = Math.round((cAmmo / mWep) * 10) / 10;","\t\t\t\t\tAmmo0.set('current', cWep + needed);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>\" + msg.who + ' is reloading ' + needed + \" Ammo on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + ' reloads)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t}","\t\t}","\t}","});","//---AUTO LOCATION ROLLS","var aLoc = [\"Head\", \"Left Arm\", \"Right Arm\", \"Left Leg\", \"Right Leg\", \"..Dangly Bits! (Main Body)\", \"FREE ATTACK!\"];","//---FUMBLE ROLLS","var aFum = [","\t\"Hit a totally different friendly target in general direction of aimed target (if possible)\",","\t\"Ungracefully fumbled the attack!, lose next attack\",","\t\"Got something in eye, lose this attack\",","\t\"Missed so badly, it makes the enemy see you and an easy target!\",","\t\"Total gun jam/broke weapon(or limb!).. useless this fight. Must get fixed.\",","\t\"Tripped!, next attack to get up\",","\t\"Miss and weapon jam! (GUN) jams, (MELEE) Missed and stuck in Wall/Floor/Tree/Off Balance/etc loose next attack\",","\t\"Missed, and draws sole aggression of the target\",","\t\"Somehow hit a Flying Squirrel!\",","\t\"Failed so badly nearest ally falls back to help.\"","];",""]}],[{"start":{"row":0,"column":51},"end":{"row":0,"column":52},"action":"insert","lines":[" "],"id":3}],[{"start":{"row":1,"column":56},"end":{"row":1,"column":65},"action":"insert","lines":["hexToRgbP"],"id":5}],[{"start":{"row":1,"column":65},"end":{"row":1,"column":66},"action":"insert","lines":[" "],"id":6}],[{"start":{"row":1,"column":56},"end":{"row":1,"column":63},"action":"insert","lines":["MakeMid"],"id":7}],[{"start":{"row":1,"column":63},"end":{"row":1,"column":64},"action":"insert","lines":[" "],"id":8}],[{"start":{"row":92,"column":3},"end":{"row":92,"column":4},"action":"remove","lines":["v"],"id":9}],[{"start":{"row":92,"column":3},"end":{"row":92,"column":4},"action":"remove","lines":["a"],"id":10}],[{"start":{"row":92,"column":3},"end":{"row":92,"column":4},"action":"remove","lines":["r"],"id":11}],[{"start":{"row":92,"column":3},"end":{"row":92,"column":4},"action":"remove","lines":[" "],"id":12}],[{"start":{"row":124,"column":3},"end":{"row":124,"column":6},"action":"remove","lines":["var"],"id":13}],[{"start":{"row":124,"column":3},"end":{"row":124,"column":4},"action":"remove","lines":[" "],"id":14}],[{"start":{"row":50,"column":28},"end":{"row":50,"column":29},"action":"remove","lines":["{"],"id":15}],[{"start":{"row":50,"column":28},"end":{"row":51,"column":0},"action":"remove","lines":["",""],"id":16}],[{"start":{"row":50,"column":28},"end":{"row":50,"column":29},"action":"remove","lines":["\t"],"id":17}],[{"start":{"row":50,"column":28},"end":{"row":50,"column":29},"action":"remove","lines":["\t"],"id":18}],[{"start":{"row":50,"column":28},"end":{"row":50,"column":29},"action":"remove","lines":["\t"],"id":19}],[{"start":{"row":50,"column":40},"end":{"row":51,"column":3},"action":"remove","lines":["","\t\t}"],"id":20}],[{"start":{"row":274,"column":47},"end":{"row":274,"column":49},"action":"remove","lines":["nd"],"id":21},{"start":{"row":274,"column":47},"end":{"row":274,"column":48},"action":"insert","lines":["s"]}],[{"start":{"row":0,"column":51},"end":{"row":0,"column":52},"action":"remove","lines":[" "],"id":22}],[{"start":{"row":277,"column":7},"end":{"row":277,"column":21},"action":"remove","lines":["and weapon jam"],"id":23}],[{"start":{"row":277,"column":6},"end":{"row":277,"column":7},"action":"remove","lines":[" "],"id":24}],[{"start":{"row":231,"column":28},"end":{"row":231,"column":29},"action":"remove","lines":["{"],"id":25}],[{"start":{"row":231,"column":28},"end":{"row":232,"column":0},"action":"remove","lines":["",""],"id":26}],[{"start":{"row":231,"column":28},"end":{"row":231,"column":29},"action":"remove","lines":["\t"],"id":27}],[{"start":{"row":231,"column":28},"end":{"row":231,"column":29},"action":"remove","lines":["\t"],"id":28}],[{"start":{"row":231,"column":28},"end":{"row":231,"column":29},"action":"remove","lines":["\t"],"id":29}],[{"start":{"row":231,"column":28},"end":{"row":231,"column":29},"action":"remove","lines":["\t"],"id":30}],[{"start":{"row":232,"column":0},"end":{"row":232,"column":4},"action":"remove","lines":["\t\t\t}"],"id":31}],[{"start":{"row":231,"column":76},"end":{"row":232,"column":0},"action":"remove","lines":["",""],"id":32}],[{"start":{"row":154,"column":0},"end":{"row":155,"column":0},"action":"remove","lines":["",""],"id":33}],[{"start":{"row":148,"column":3},"end":{"row":148,"column":4},"action":"remove","lines":["-"],"id":34}],[{"start":{"row":148,"column":2},"end":{"row":148,"column":3},"action":"remove","lines":["-"],"id":35}],[{"start":{"row":148,"column":2},"end":{"row":148,"column":4},"action":"insert","lines":["--"],"id":36},{"start":{"row":153,"column":87},"end":{"row":154,"column":0},"action":"insert","lines":["",""]},{"start":{"row":231,"column":28},"end":{"row":232,"column":4},"action":"insert","lines":["{","\t\t\t\t"]},{"start":{"row":232,"column":52},"end":{"row":233,"column":4},"action":"insert","lines":["","\t\t\t}"]},{"start":{"row":277,"column":6},"end":{"row":277,"column":21},"action":"insert","lines":[" and weapon jam"]}],[{"start":{"row":0,"column":0},"end":{"row":282,"column":0},"action":"remove","lines":["//!attack --[[1d20]] --[[3d6]] --saying! --ammotype","/*global OuterDiv PlaySound TopBar iPart MidBar BottBar MakeMid hexToRgbP MakeRollNum log on findObjs randomInteger RollRight _ sendChat bShadow font getObj"," */","on('chat:message', function(msg) {","\tif (msg.type != \"api\") return;","\t//log(msg.content);","\tvar msgTxt = msg.content;","\tvar command = msgTxt.split(\" \", 1);","\tvar cWho = findObjs({_type: 'character',name: msg.who})[0];","\tif (cWho == undefined && msg.who.indexOf(\"(GM)\") == -1) {","\t\tcWho = RollRight(msg.playerid);","\t\tmsg.who = cWho.get(\"name\");","\t}","/*-----------CHECK API-----------*/","\tif (command == \"!attack\") {","/*-----------BOXES-----------*/","\t\tvar Main;","\t\tvar PlayerBGColor = getObj(\"player\", msg.playerid).get(\"color\");","\t\tvar PRGB = hexToRgbP(PlayerBGColor);","        var PlayerBarColor = \"background-image: -webkit-linear-gradient(left, rgba(0,0,0,0.8),\"+PRGB+\",\"+PRGB+\",rgba(0,0,0,0.8));\";","\t\tvar MIDBAR = MakeMid(MidBar,PlayerBGColor,PlayerBarColor);","\t\tvar RollColor = \"background-image:-webkit-linear-gradient(left, #000000,#820101,#000000);\";","\t\tvar topimg = \"https://s3.amazonaws.com/files.staging.d20.io/images/181118/cN5ui3MXx87UBgVUgzwYTQ/med.jpg?141868063\";","\t\tvar TextShadow = \"-1px -1px #444, 1px -1px #444, -1px 1px #444, 1px 1px #444\";","\t\tvar SayParts = \"<div style='text-shadow: 1px 1px #000, -1px -1px #000, -1px 1px #000, 1px -1px #000; margin: 0em 0em 0em 0em;; font-size:8pt; display:inline-block; text-align: center; vertical-align:middle; padding: 0px 6px 0px 6px; border: 1px solid #000; border-radius: 3px; color: #FFF; background-image: url(\" + topimg + \");'>\";","\t\tvar RollDiv = \"<div style='margin: 0em 0.1em 0.1em 0em; font-size: 10pt; text-shadow: \" + TextShadow + \"; width: 15px; height: 15px; line-height: 15px; display:inline-block; text-align:center; padding: 0px 1px 0px 0px; border: 1px solid #000; border-radius: 3px; color: #FFF;\";","\t\tvar MainSayDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family:\" + font + \"; font-size: x-small; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-top: 2px solid #000; border-radius: 0px; background-color:#CEC7B6; color: #000;'>\";","\t\tvar MainEvenDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #CEC7B6; color: #000;'>\";","\t\tvar MainOddDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #C0B9A8; color: #000;'>\";","\t\tvar AmmoDiv =  \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; font-family: \" + font + \"; font-size: 8pt; text-align: center; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; color: #000;\";","/*---------------------------*/","\t\tvar who = msg.who;","\t\tmsg.content = MakeRollNum(msg.content, msg.inlinerolls);","//check rolls---------------------","\t\tvar AttackRolls = msg.inlinerolls[0];","\t\tvar DamageRolls = msg.inlinerolls[1];","//define var----------------------","\t\tif (AttackRolls === undefined || DamageRolls === undefined) {","\t\t\tsendChat('', \"/direct <B><I>bad macro!\");","\t\t\treturn;","\t\t}","\t\tmsgFormula = msgTxt.split(\" --\");","\t\tvar Lucky = 20;","\t\tvar failRange = 1;","\t\tvar DamageRollRaw = \"\";","\t\tvar BottomText = \"\";","\t\tvar fumble = 0;","\t\tvar miss = 0;","\t\tvar crit_img = \"http:\\\\//media.giphy.com/media/3KqZp8MBaf1Ty/giphy.gif\";","\t\tvar fail_img = \"http:\\\\//fc06.deviantart.net/fs70/f/2013/076/5/2/_tutorial__creating_an_animated_light_pulse_in_ps_by_d_k0d3-d5ybir4.gif\";","\t\tif (msg.who == \"GM (GM)\") who = \"NPC\";","/*-----------START-----------*/","//Check for GUN","\t\tif (who !== \"NPC\") {","\t\t\tif (msgFormula[4] === undefined) msgFormula[4] = msgFormula[3];","\t\t\tif (msgFormula[4] !== undefined) {","\t\t\t\tvar gunleng = msgFormula[4].length - 1;","\t\t\t\tvar ammo = parseInt(msgFormula[4].substr(gunleng), 10);","\t\t\t\tif (!isNaN(ammo)) {","\t\t\t\t\tgunleng = msgFormula[4].length - 2;","\t\t\t\t\tvar gun = msgFormula[4].substr(0, gunleng);","\t\t\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (FindGun == undefined) {","\t\t\t\t\t\tsendChat('Error', \"/desc \" + msg.who + \" You do not own a  \" + gun);","\t\t\t\t\t\treturn;","\t\t\t\t\t}","\t\t\t\t\tvar GunName = FindGun.get(\"name\");","\t\t\t\t\tvar leng = GunName.length - 5;","\t\t\t\t\tleng = GunName.substr(0, leng);","\t\t\t\t\tvar ammo0 = findObjs({name: leng + \"_WEAPpay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (ammo0 == undefined) {","\t\t\t\t\t\tammo0 = FindGun;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t}","/*-----------ATTACK PARTS-----------*/","//--Attack Modifier","\t\tvar AttackBonus;","\t\tvar AttackRollText;","\t\tif (AttackRolls.results.rolls[1] === undefined) AttackBonus = \"\";","\t\telse AttackBonus = (AttackRolls.results.rolls[1].expr);","\t\tvar AttackRollRaw = AttackRolls.results.rolls[0].results[0]['v'];","//Attack total and type","\t\tvar AttackTotal = (AttackRolls.results.total);","\t\tvar Atype = \"<a style='color:RED'>\" + AttackRolls.expression + \"</a>\";","//--Set Miss","\t\tif (AttackRollRaw <= 3) {","\t\t\tAttackRollText = RollDiv + \"background-color:#A80000;'>\" + AttackRollRaw + \"</div>\";","\t\t\tBottomText = BottomText + \" \" + 'MISS';","\t\t\tmiss = 1;","\t\t}","\t\telse AttackRollText = RollDiv + \"background-color:#696969;'>\" + AttackRollRaw + \"</div>\";","/*-----------DAMAGE PARTS-----------*/","//--Damage modifier","\t\tvar DamageBonus;","\t\tif (DamageRolls.results.rolls[1] === undefined) DamageBonus = \"\";","\t\telse DamageBonus = (DamageRolls.results.rolls[1].expr);","\t\t//--Set damage total","\t\tvar DamageTotal = DamageRolls.results.total;","//--Make damage text for all rolls","\t\tvar dam = DamageRolls.results.rolls[0];","\t\tvar i = 0;","\t\twhile (dam.results[i] !== undefined) {","\t\t\tvar dNum = dam.results[i]['v'];","\t\t\tvar num;","\t\t\tvar ddimg = \"http://image.blingee.com.s3.amazonaws.com/images19/content/output/000/000/000/061/788808721_1076628.gif?4\";","\t\t\tvar bg_max = \"background-position:center; background-image: url(\" + ddimg + \");\";","\t\t\tif (dNum == 1) num = RollDiv + \"background-color:#A80000;'>\" + dNum + \"</div></b></a>\";","\t\t\telse if (dNum == DamageRolls.results.rolls[0].sides) num = RollDiv + \"background-color:#00A120;\" + bg_max + \"'><b>\" + dNum + \"</b></div></b></a>\";","\t\t\telse num = RollDiv + \"background-color:#696969;'>\" + dNum + \"</div>\";","\t\t\tDamageRollRaw = DamageRollRaw + \"\" + (num);","\t\t\ti++;","\t\t}","\t\tvar Dtype = \"<a style='color:RED;'>\" + DamageRolls.expression + \"</a>\";","\t\tDamageRollRaw = DamageRollRaw + \"<b>\" + DamageBonus + \"</b>\";","\t\tvar DTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a>\";","\t\tif (miss == 1)  DTOTALS = \"\";","//--Set Double Damage","\t\tif (AttackRollRaw >= 20) {","\t\t    var CritCheer = '<div style=\"border: 1px solid #666666; border-radius: 20px; width: 99%; height: 40px; overflow: hidden; position: relative;\"><img src=\"https://media.giphy.com/media/11sBLVxNs7v6WA/giphy.gif\" style=\"position: absolute; top:-35px; left:0px;\"/></div>';","\t\t\tDamageTotal = \"<a style='color:RED'><strong>\" + DamageTotal * 2 + \"!</strong></a>\";","\t\t\tDTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a><br>\"+CritCheer;","\t\t\tAttackTotal = \"<a style='color:RED'><strong>\" + AttackTotal + \"!</strong></a>\";","\t\t\tBottomText = BottomText + \" \" + '<b>DOUBLE DAMAGE!</b><BR><b>(NATURAL 20!)</b><br>';","\t\t\tRollColor = \"background-position:center; background-image: url(\" + crit_img + \");\";","\t\t\tPlaySound('Critical', 9000);","\t\t}","//set motto","\t\tif (msgFormula[3] !== undefined) {","\t\t\tvar WarCryleng = msgFormula[3].length - 1;","\t\t\tvar sayingCheck = parseInt(msgFormula[3].substr(WarCryleng), 10);","\t\t\tif (isNaN(sayingCheck)) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t}","\t\t\telse if (msgFormula[3] !== undefined && msgFormula[4] == undefined) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t\tWarCryleng = msgFormula[3].length - 2;","\t\t\t\tvar WarCry = msgFormula[3].substr(0, WarCryleng).toUpperCase();","\t\t\t}","\t\t}","\t\telse {","\t\t\tWarCry = \"ATTACK!\";","\t\t}","//CHATBOX PARTS----------------","\t\tMain = MainSayDiv + SayParts + \"<b><i><marquee><img src='logo.jpg'></marquee> ●\" + WarCry + \"●</i></b></div></div>\";","\t\tMain = Main + MainOddDiv + Atype + \" <b>To Hit: </b>\" + AttackRollText + \"<b>\" + AttackBonus + \" = <a style='color:BLUE'>\" + AttackTotal + \"</b></a></div>\";","\t\tMain = Main + MainEvenDiv + DTOTALS + \"</div>\";","//--Lucky roll","\t\tvar IsLucky = randomInteger(Lucky);","\t\tif (IsLucky >= Lucky && AttackRollRaw > 4) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><b>Lucky Shot!: \" + aLoc[Math.floor(Math.random() * aLoc.length)] + \"</b></div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(http:\\\\//i.imgur.com/cFiEs5R.gif);\";","\t\t\tBottomText = BottomText + \" \" + SayParts + \"<b><i>●LUCKY SHOT●</i></b></div></div>\";","","//Fumble roll","\t\t}","\t\tif (AttackRollRaw <= failRange) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><strong style='font-size: 130%;'><b>Fumble!: \" + aFum[Math.floor(Math.random() * aFum.length)] + \"</div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(\" + fail_img + \");\";","\t\t\tBottomText = BottomText + \" \" + 'FUMBLE';","\t\t\tfumble = 1;","\t\t}","/*-----------","AMMO PARTS","-----------*/","\t\tif (FindGun !== undefined && who !== \"NPC\" && ammo0 !== undefined) {","\t\t\tvar ammoleng = msgFormula[4].length - 1;","\t\t\tvar ammo = parseInt(msgFormula[4].substr(ammoleng));","\t\t\tvar ammoC = parseInt(ammo);","\t\t\tif (ammoC === undefined || isNaN(ammoC)) ammoC = 1;","\t\t\tvar cAmmo = parseInt(ammo0.get(\"current\"));","\t\t\tvar mAmmo = parseInt(ammo0.get(\"max\"));","\t\t\tif (isNaN(cAmmo) || isNaN(mAmmo)) {","\t\t\t\tsendChat('Error', \"/desc Set ammo for  \" + gun);","\t\t\t\treturn;","\t\t\t}","\t\t\tvar per = (cAmmo / mAmmo) * 100;","\t\t\tif (mAmmo == 0) {}","\t\t\telse if (cAmmo <= 0 || cAmmo < ammoC) {","\t\t\t\tcAmmo = \"0\";","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tMain = AmmoDiv + \"background-color:RED;'><b><i>Not Enough \" + gun + \" ammo left in clip.</div>\";","\t\t\t}","\t\t\telse if (cAmmo <= 3 || cAmmo < ammoC) {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 3px;\"><div style=\"background-color: red; width: ' + per + '%; height: 5px; border-radius: 10px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#B82A2A;'><b><i>\" + cAmmo + \" \" + gun + \" ammo left in clip.</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t\telse {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 1px;\"><div style=\"background-color: orange; width: ' + per + '%; height: 3px; border-radius: 10px; margins: 0px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#A8A191;'><b><i>\" + cAmmo + \" of \" + mAmmo + \" \" + gun + \" ammo left</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t}","/*-----------SEND CHAT-----------*/","        var pad = \"\";","        if(BottomText == \"\") var pad = \"padding: 5px 1px;\";","\t\tvar MsgBox = TopBar + RollColor +\";'></div>\"+ MIDBAR +\"<b>\" + who + \"  Attacks</b></div>\"+Main+\"</div>\"+BottBar + pad + RollColor +\";'><b>\" + BottomText + \"</b></div>\";","\t\tvar SendT = MsgBox;","\t\tif (AttackRollRaw <= 3 && fumble != 1) {","\t\t\tSendT = \"<div style='opacity: 0.6;'><strong style='font-size: 90%;'>\" + SendT + \"</strong></div>\";","\t\t}","\t\tif (AttackRollRaw >= 20) {","\t\t\tSendT = \"<strong style='font-size: 130%;'>\" + SendT + \"</strong>\";","\t\t}","\t\tsendChat(who, '/direct ' + SendT);","\t\tPlaySound('dice', 9000);","\t\treturn;","\t}","//----------------------------","//RELOAD----------------","//----------------------------","\tif (command == \"!reload\") {","\t\tif (cWho !== undefined) {","\t\t\tvar msgFormula = msgTxt.split(\" --\");","\t\t\tvar gun = msgFormula[1];","\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (FindGun == undefined) {","\t\t\t\tsendChat('', '/desc ' + msg.who + ': <b>ammo not found</b>');","\t\t\t\treturn;","\t\t\t}","\t\t\tClips = 0;","\t\t\tvar attName = FindGun.get(\"name\");","\t\t\tvar Ammo0 = findObjs({name: attName + \"pay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Ammo1 = findObjs({name: attName + \"Rounds\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Clipsc = findObjs({name: attName + \"clip\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (Clipsc != undefined) {","\t\t\t\tvar Clips = parseInt(Clipsc.get(\"current\"), 10);","\t\t\t}","\t\t\tvar cWep = parseInt(Ammo0.get(\"current\"), 10);","\t\t\tvar mWep = parseInt(Ammo0.get(\"max\"), 10 );","\t\t\tvar cAmmo = parseInt(Ammo1.get(\"current\"), 10);","\t\t\tif (cAmmo <= 0) {","\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' NO AMMO TO RELOAD!</div>';","\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t}","\t\t\telse {","\t\t\t\tvar needed = mWep - cWep;","\t\t\t\tif (needed >= cAmmo) {","\t\t\t\t\tneeded = cAmmo;","\t\t\t\t}","\t\t\t\tif (Clips == 10) {","\t\t\t\t\tneeded = 1;","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = cAmmo;","\t\t\t\t\tAmmo0.set('current', mWep);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' is reloading: ' + needed + \" clips on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + 'Clips)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t\telse {","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = Math.round((cAmmo / mWep) * 10) / 10;","\t\t\t\t\tAmmo0.set('current', cWep + needed);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>\" + msg.who + ' is reloading ' + needed + \" Ammo on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + ' reloads)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t}","\t\t}","\t}","});","//---AUTO LOCATION ROLLS","var aLoc = [\"Head\", \"Left Arm\", \"Right Arm\", \"Left Leg\", \"Right Leg\", \"..Dangly Bits! (Main Body)\", \"FREE ATTACK!\"];","//---FUMBLE ROLLS","var aFum = [","\t\"Hit a totally different friendly target in general direction of aimed target (if possible)\",","\t\"Ungracefully fumbled the attack!, lose next attack\",","\t\"Got something in eye, lose this attack\",","\t\"Missed so badly, it makes the enemy see you as an easy target!\",","\t\"Total gun jam/broke weapon(or limb!).. useless this fight. Must get fixed.\",","\t\"Tripped!, next attack to get up\",","\t\"Miss and weapon jam! (GUN) jams, (MELEE) Missed and stuck in Wall/Floor/Tree/Off Balance/etc loose next attack\",","\t\"Missed, and draws sole aggression of the target\",","\t\"Somehow hit a Flying Squirrel!\",","\t\"Failed so badly nearest ally falls back to help.\"","];",""],"id":37},{"start":{"row":0,"column":0},"end":{"row":285,"column":0},"action":"insert","lines":["//!attack --[[1d20]] --[[3d6]] --saying! --ammotype","/*global OuterDiv PlaySound TopBar iPart MidBar BottBar MakeRollNum log on findObjs randomInteger RollRight _ sendChat bShadow font getObj"," */","on('chat:message', function(msg) {","\tif (msg.type != \"api\") return;","\t//log(msg.content);","\tvar msgTxt = msg.content;","\tvar command = msgTxt.split(\" \", 1);","\tvar cWho = findObjs({_type: 'character',name: msg.who})[0];","\tif (cWho == undefined && msg.who.indexOf(\"(GM)\") == -1) {","\t\tcWho = RollRight(msg.playerid);","\t\tmsg.who = cWho.get(\"name\");","\t}","","/*-----------CHECK API-----------*/","\tif (command == \"!attack\") {","/*-----------BOXES-----------*/","\t\tvar Main;","\t\tvar PlayerBGColor = getObj(\"player\", msg.playerid).get(\"color\");","\t\tvar PRGB = hexToRgbP(PlayerBGColor);","        var PlayerBarColor = \"background-image: -webkit-linear-gradient(left, rgba(0,0,0,0.8),\"+PRGB+\",\"+PRGB+\",rgba(0,0,0,0.8));\";","\t\tvar MIDBAR = MakeMid(MidBar,PlayerBGColor,PlayerBarColor);","\t\tvar RollColor = \"background-image:-webkit-linear-gradient(left, #000000,#820101,#000000);\";","\t\tvar topimg = \"https://s3.amazonaws.com/files.staging.d20.io/images/181118/cN5ui3MXx87UBgVUgzwYTQ/med.jpg?141868063\";","\t\tvar TextShadow = \"-1px -1px #444, 1px -1px #444, -1px 1px #444, 1px 1px #444\";","\t\tvar SayParts = \"<div style='text-shadow: 1px 1px #000, -1px -1px #000, -1px 1px #000, 1px -1px #000; margin: 0em 0em 0em 0em;; font-size:8pt; display:inline-block; text-align: center; vertical-align:middle; padding: 0px 6px 0px 6px; border: 1px solid #000; border-radius: 3px; color: #FFF; background-image: url(\" + topimg + \");'>\";","\t\tvar RollDiv = \"<div style='margin: 0em 0.1em 0.1em 0em; font-size: 10pt; text-shadow: \" + TextShadow + \"; width: 15px; height: 15px; line-height: 15px; display:inline-block; text-align:center; padding: 0px 1px 0px 0px; border: 1px solid #000; border-radius: 3px; color: #FFF;\";","\t\tvar MainSayDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family:\" + font + \"; font-size: x-small; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-top: 2px solid #000; border-radius: 0px; background-color:#CEC7B6; color: #000;'>\";","\t\tvar MainEvenDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #CEC7B6; color: #000;'>\";","\t\tvar MainOddDiv = \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #C0B9A8; color: #000;'>\";","\t\tvar AmmoDiv =  \"<div style='width: 95%; margin: 0px auto; box-shadow: \" + bShadow + \"; font-family: \" + font + \"; font-size: 8pt; text-align: center; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; color: #000;\";","/*---------------------------*/","\t\tvar who = msg.who;","\t\tmsg.content = MakeRollNum(msg.content, msg.inlinerolls);","//check rolls---------------------","\t\tvar AttackRolls = msg.inlinerolls[0];","\t\tvar DamageRolls = msg.inlinerolls[1];","//define var----------------------","\t\tif (AttackRolls === undefined || DamageRolls === undefined) {","\t\t\tsendChat('', \"/direct <B><I>bad macro!\");","\t\t\treturn;","\t\t}","\t\tmsgFormula = msgTxt.split(\" --\");","\t\tvar Lucky = 20;","\t\tvar failRange = 1;","\t\tvar DamageRollRaw = \"\";","\t\tvar BottomText = \"\";","\t\tvar fumble = 0;","\t\tvar miss = 0;","\t\tvar crit_img = \"http:\\\\//media.giphy.com/media/3KqZp8MBaf1Ty/giphy.gif\";","\t\tvar fail_img = \"http:\\\\//fc06.deviantart.net/fs70/f/2013/076/5/2/_tutorial__creating_an_animated_light_pulse_in_ps_by_d_k0d3-d5ybir4.gif\";","\t\tif (msg.who == \"GM (GM)\") {","\t\t\twho = \"NPC\";","\t\t}","/*-----------START-----------*/","//Check for GUN","\t\tif (who !== \"NPC\") {","\t\t\tif (msgFormula[4] === undefined) msgFormula[4] = msgFormula[3];","\t\t\tif (msgFormula[4] !== undefined) {","\t\t\t\tvar gunleng = msgFormula[4].length - 1;","\t\t\t\tvar ammo = parseInt(msgFormula[4].substr(gunleng), 10);","\t\t\t\tif (!isNaN(ammo)) {","\t\t\t\t\tgunleng = msgFormula[4].length - 2;","\t\t\t\t\tvar gun = msgFormula[4].substr(0, gunleng);","\t\t\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (FindGun == undefined) {","\t\t\t\t\t\tsendChat('Error', \"/desc \" + msg.who + \" You do not own a  \" + gun);","\t\t\t\t\t\treturn;","\t\t\t\t\t}","\t\t\t\t\tvar GunName = FindGun.get(\"name\");","\t\t\t\t\tvar leng = GunName.length - 5;","\t\t\t\t\tleng = GunName.substr(0, leng);","\t\t\t\t\tvar ammo0 = findObjs({name: leng + \"_WEAPpay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t\tif (ammo0 == undefined) {","\t\t\t\t\t\tammo0 = FindGun;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t}","/*-----------ATTACK PARTS-----------*/","//--Attack Modifier","\t\tvar AttackBonus;","\t\tvar AttackRollText;","\t\tif (AttackRolls.results.rolls[1] === undefined) AttackBonus = \"\";","\t\telse AttackBonus = (AttackRolls.results.rolls[1].expr);","\t\tvar AttackRollRaw = AttackRolls.results.rolls[0].results[0]['v'];","//Attack total and type","\t\tvar AttackTotal = (AttackRolls.results.total);","\t\tvar Atype = \"<a style='color:RED'>\" + AttackRolls.expression + \"</a>\";","//--Set Miss","\t\tif (AttackRollRaw <= 3) {","\t\t\tAttackRollText = RollDiv + \"background-color:#A80000;'>\" + AttackRollRaw + \"</div>\";","\t\t\tBottomText = BottomText + \" \" + 'MISS';","\t\t\tvar miss = 1;","\t\t}","\t\telse AttackRollText = RollDiv + \"background-color:#696969;'>\" + AttackRollRaw + \"</div>\";","/*-----------DAMAGE PARTS-----------*/","//--Damage modifier","\t\tvar DamageBonus;","\t\tif (DamageRolls.results.rolls[1] === undefined) DamageBonus = \"\";","\t\telse DamageBonus = (DamageRolls.results.rolls[1].expr);","\t\t//--Set damage total","\t\tvar DamageTotal = DamageRolls.results.total;","//--Make damage text for all rolls","\t\tvar dam = DamageRolls.results.rolls[0];","\t\tvar i = 0;","\t\twhile (dam.results[i] !== undefined) {","\t\t\tvar dNum = dam.results[i]['v'];","\t\t\tvar num;","\t\t\tvar ddimg = \"http://image.blingee.com.s3.amazonaws.com/images19/content/output/000/000/000/061/788808721_1076628.gif?4\";","\t\t\tvar bg_max = \"background-position:center; background-image: url(\" + ddimg + \");\";","\t\t\tif (dNum == 1) num = RollDiv + \"background-color:#A80000;'>\" + dNum + \"</div></b></a>\";","\t\t\telse if (dNum == DamageRolls.results.rolls[0].sides) num = RollDiv + \"background-color:#00A120;\" + bg_max + \"'><b>\" + dNum + \"</b></div></b></a>\";","\t\t\telse num = RollDiv + \"background-color:#696969;'>\" + dNum + \"</div>\";","\t\t\tDamageRollRaw = DamageRollRaw + \"\" + (num);","\t\t\ti++;","\t\t}","\t\tvar Dtype = \"<a style='color:RED;'>\" + DamageRolls.expression + \"</a>\";","\t\tDamageRollRaw = DamageRollRaw + \"<b>\" + DamageBonus + \"</b>\";","\t\tvar DTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a>\";","\t\tif (miss == 1)  DTOTALS = \"\";","//--Set Double Damage","\t\tif (AttackRollRaw >= 20) {","\t\t    var CritCheer = '<div style=\"border: 1px solid #666666; border-radius: 20px; width: 99%; height: 40px; overflow: hidden; position: relative;\"><img src=\"https://media.giphy.com/media/11sBLVxNs7v6WA/giphy.gif\" style=\"position: absolute; top:-35px; left:0px;\"/></div>';","\t\t\tDamageTotal = \"<a style='color:RED'><strong>\" + DamageTotal * 2 + \"!</strong></a>\";","\t\t\tvar DTOTALS = Dtype + \"<b> Damage:<br></b>\" + DamageRollRaw + \"<b> = <a style='color:BLUE'>\" + DamageTotal + \"</b></a><br>\"+CritCheer;","\t\t\tAttackTotal = \"<a style='color:RED'><strong>\" + AttackTotal + \"!</strong></a>\";","\t\t\tBottomText = BottomText + \" \" + '<b>DOUBLE DAMAGE!</b><BR><b>(NATURAL 20!)</b><br>';","\t\t\tRollColor = \"background-position:center; background-image: url(\" + crit_img + \");\";","\t\t\tPlaySound('Critical', 9000);","\t\t}","//set motto","\t\tif (msgFormula[3] !== undefined) {","\t\t\tvar WarCryleng = msgFormula[3].length - 1;","\t\t\tvar sayingCheck = parseInt(msgFormula[3].substr(WarCryleng), 10);","\t\t\tif (isNaN(sayingCheck)) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t}","\t\t\telse if (msgFormula[3] !== undefined && msgFormula[4] == undefined) {","\t\t\t\tWarCry = msgFormula[3].toUpperCase();","\t\t\t\tWarCryleng = msgFormula[3].length - 2;","\t\t\t\tvar WarCry = msgFormula[3].substr(0, WarCryleng).toUpperCase();","\t\t\t}","\t\t}","\t\telse {","\t\t\tWarCry = \"ATTACK!\";","\t\t}","//CHATBOX PARTS----------------","\t\tMain = MainSayDiv + SayParts + \"<b><i><marquee><img src='logo.jpg'></marquee> ●\" + WarCry + \"●</i></b></div></div>\";","\t\tMain = Main + MainOddDiv + Atype + \" <b>To Hit: </b>\" + AttackRollText + \"<b>\" + AttackBonus + \" = <a style='color:BLUE'>\" + AttackTotal + \"</b></a></div>\";","\t\tMain = Main + MainEvenDiv + DTOTALS + \"</div>\";","//--Lucky roll","\t\tvar IsLucky = randomInteger(Lucky);","\t\tif (IsLucky >= Lucky && AttackRollRaw > 4) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><b>Lucky Shot!: \" + aLoc[Math.floor(Math.random() * aLoc.length)] + \"</b></div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(http:\\\\//i.imgur.com/cFiEs5R.gif);\";","\t\t\tBottomText = BottomText + \" \" + SayParts + \"<b><i>●LUCKY SHOT●</i></b></div></div>\";","","//Fumble roll","\t\t}","\t\tif (AttackRollRaw <= failRange) {","\t\t\tMain = Main + MainOddDiv + \"<a style = 'color:PURPLE'><strong style='font-size: 130%;'><b>Fumble!: \" + aFum[Math.floor(Math.random() * aFum.length)] + \"</div>\";","\t\t\tRollColor = \"background-position:50% 54%; background-image: url(\" + fail_img + \");\";","\t\t\tBottomText = BottomText + \" \" + 'FUMBLE';","\t\t\tfumble = 1;","\t\t}","/*-----------","AMMO PARTS","-----------*/","\t\tif (FindGun !== undefined && who !== \"NPC\" && ammo0 !== undefined) {","\t\t\tvar ammoleng = msgFormula[4].length - 1;","\t\t\tvar ammo = parseInt(msgFormula[4].substr(ammoleng));","\t\t\tvar ammoC = parseInt(ammo);","\t\t\tif (ammoC === undefined || isNaN(ammoC)) ammoC = 1;","\t\t\tvar cAmmo = parseInt(ammo0.get(\"current\"));","\t\t\tvar mAmmo = parseInt(ammo0.get(\"max\"));","\t\t\tif (isNaN(cAmmo) || isNaN(mAmmo)) {","\t\t\t\tsendChat('Error', \"/desc Set ammo for  \" + gun);","\t\t\t\treturn;","\t\t\t}","\t\t\tvar per = (cAmmo / mAmmo) * 100;","\t\t\tif (mAmmo == 0) {}","\t\t\telse if (cAmmo <= 0 || cAmmo < ammoC) {","\t\t\t\tcAmmo = \"0\";","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tMain = AmmoDiv + \"background-color:RED;'><b><i>Not Enough \" + gun + \" ammo left in clip.</div>\";","\t\t\t}","\t\t\telse if (cAmmo <= 3 || cAmmo < ammoC) {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 3px;\"><div style=\"background-color: red; width: ' + per + '%; height: 5px; border-radius: 10px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#B82A2A;'><b><i>\" + cAmmo + \" \" + gun + \" ammo left in clip.</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t\telse {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 1px;\"><div style=\"background-color: orange; width: ' + per + '%; height: 3px; border-radius: 10px; margins: 0px;\"></div></div>';","\t\t\t\tammoT = AmmoDiv + \"background-color:#A8A191;'><b><i>\" + cAmmo + \" of \" + mAmmo + \" \" + gun + \" ammo left</b></i>\" + ammoT + \"</div>\";","\t\t\t\tMain = Main + ammoT;","\t\t\t}","\t\t}","/*-----------SEND CHAT-----------*/","        var pad = \"\";","        if(BottomText == \"\") var pad = \"padding: 5px 1px;\";","\t\tvar MsgBox = TopBar + RollColor +\";'></div>\"+ MIDBAR +\"<b>\" + who + \"  Attacks</b></div>\"+Main+\"</div>\"+BottBar + pad + RollColor +\";'><b>\" + BottomText + \"</b></div>\";","\t\tvar SendT = MsgBox;","\t\tif (AttackRollRaw <= 3 && fumble != 1) {","\t\t\tSendT = \"<div style='opacity: 0.6;'><strong style='font-size: 90%;'>\" + SendT + \"</strong></div>\";","\t\t}","\t\tif (AttackRollRaw >= 20) {","\t\t\tSendT = \"<strong style='font-size: 130%;'>\" + SendT + \"</strong>\";","\t\t}","\t\tsendChat(who, '/direct ' + SendT);","\t\tPlaySound('dice', 9000);","\t\treturn;","\t}","//----------------------------","//RELOAD----------------","//----------------------------","\tif (command == \"!reload\") {","\t\tif (cWho !== undefined) {","\t\t\tvar msgFormula = msgTxt.split(\" --\");","\t\t\tvar gun = msgFormula[1];","\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (FindGun == undefined) {","\t\t\t\tsendChat('', '/desc ' + msg.who + ': <b>ammo not found</b>');","\t\t\t\treturn;","\t\t\t}","\t\t\tClips = 0;","\t\t\tvar attName = FindGun.get(\"name\");","\t\t\tvar Ammo0 = findObjs({name: attName + \"pay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Ammo1 = findObjs({name: attName + \"Rounds\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tvar Clipsc = findObjs({name: attName + \"clip\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\tif (Clipsc != undefined) {","\t\t\t\tvar Clips = parseInt(Clipsc.get(\"current\"), 10);","\t\t\t}","\t\t\tvar cWep = parseInt(Ammo0.get(\"current\"), 10);","\t\t\tvar mWep = parseInt(Ammo0.get(\"max\"), 10 );","\t\t\tvar cAmmo = parseInt(Ammo1.get(\"current\"), 10);","\t\t\tif (cAmmo <= 0) {","\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' NO AMMO TO RELOAD!</div>';","\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t}","\t\t\telse {","\t\t\t\tvar needed = mWep - cWep;","\t\t\t\tif (needed >= cAmmo) {","\t\t\t\t\tneeded = cAmmo;","\t\t\t\t}","\t\t\t\tif (Clips == 10) {","\t\t\t\t\tneeded = 1;","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = cAmmo;","\t\t\t\t\tAmmo0.set('current', mWep);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' is reloading: ' + needed + \" clips on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + 'Clips)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t\telse {","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = Math.round((cAmmo / mWep) * 10) / 10;","\t\t\t\t\tAmmo0.set('current', cWep + needed);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>\" + msg.who + ' is reloading ' + needed + \" Ammo on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + ' reloads)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t}","\t\t}","\t}","});","//---AUTO LOCATION ROLLS","var aLoc = [\"Head\", \"Left Arm\", \"Right Arm\", \"Left Leg\", \"Right Leg\", \"..Dangly Bits! (Main Body)\", \"FREE ATTACK!\"];","//---FUMBLE ROLLS","var aFum = [","\t\"Hit a totally different friendly target in general direction of aimed target (if possible)\",","\t\"Ungracefully fumbled the attack!, lose next attack\",","\t\"Got something in eye, lose this attack\",","\t\"Missed so badly, it makes the enemy see you and an easy target!\",","\t\"Total gun jam/broke weapon(or limb!).. useless this fight. Must get fixed.\",","\t\"Tripped!, next attack to get up\",","\t\"Miss and weapon jam! (GUN) jams, (MELEE) Missed and stuck in Wall/Floor/Tree/Off Balance/etc loose next attack\",","\t\"Missed, and draws sole aggression of the target\",","\t\"Somehow hit a Flying Squirrel!\",","\t\"Failed so badly nearest ally falls back to help.\"","];",""]}]]},"ace":{"folds":[],"scrolltop":3195,"scrollleft":0,"selection":{"start":{"row":285,"column":0},"end":{"row":285,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":227,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1489192014003,"hash":"70739e3313ad712e3171e43fdf21a998143f8184"}