{"filter":false,"title":"Turns.js","tooltip":"/API/Rifts/Turns.js","undoManager":{"mark":0,"position":0,"stack":[[{"start":{"row":0,"column":0},"end":{"row":222,"column":2},"action":"remove","lines":["/*global gmC state on obj getObj iPart _ playerIsGM brPart RollRight formatNumber findObjs sendChat CONFIG lPart fPart gm_img gPart greenC redC grayC OuterDiv Campaign randomFromTo createObj fixNO toFront randomInteger*/","var WillTurnOrder = {};","var TurnData = {};","var BestRoll = 0;","var intChat = '';","/*------------------","API CHAT COMMANDS","------------------*/","on('chat:message', function(msg) {","    /*--TURNS-SET--*/","    if(msg.type == 'api' && msg.content.indexOf('!Turns') !== -1) {","\t\tvar turnorder;","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tsort(turnorder); /*--SORT TURNS--*/","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tSetPurple(turnorder, false);","\t\tfor(var i in turnorder) {","\t\t\tcAttacks = 5; /*-DEFAULT ATTACKS-*/","\t\t\tname = turnorder[i].id; /*-TURN ORDER WHO-*/","\t\t\tid1 = getObj(\"graphic\", turnorder[i].id); /*-GET TOKEN-*/","\t\t\tpColor = '#636363';","\t\t\tif(id1 != undefined) {","\t\t\t\toCharacter = getObj(\"character\", id1.get(\"represents\"));","\t\t\t\tiName = id1.get(\"name\");","\t\t\t\tif(oCharacter != undefined) {","\t\t\t\t\tiName = oCharacter.get(\"name\");","\t\t\t\t\toAttacks = findObjs({","\t\t\t\t\t\t_type: \"attribute\",","\t\t\t\t\t\tname: \"ATT\",","\t\t\t\t\t\t_characterid: oCharacter.id","\t\t\t\t\t})[0];","\t\t\t\t\tif(oAttacks != undefined) cAttacks = parseInt(oAttacks.get(\"current\"));","\t\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\t\tif(type == 'Player') {","\t\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t\t}","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined && id1.get(\"gmnotes\") != \"\") {","\t\t\t\t\tcAttacks = id1.get(\"gmnotes\");","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined) {","\t\t\t\t\tsetbars(id1);","\t\t\t\t}","\t\t\t\tvar init = parseInt(turnorder[i].pr);","\t\t\t\tif(init < cAttacks) {","\t\t\t\t\tinit = cAttacks;","\t\t\t\t\tturnorder[i].pr = cAttacks;","\t\t\t\t}","\t\t\t\taddPlayer(name, parseInt(init), parseInt(cAttacks));","\t\t\t}","\t\t}","\t\tvar sTurns = createOrder();","\t\tsort(sTurns); /*--SORT TURNS--*/","\t\tvar aFirst = JSON.parse(Campaign().get(\"turnorder\"));","\t\tvar iName2 = getObj(\"graphic\", aFirst[1].id).get(\"name\");","\t\tif(getObj(\"graphic\", aFirst[1].id).get(\"layer\") == 'gmlayer') iName2 = \"UNKNOWN\";","\t\tvar C = fPart + \" background-color:#A80000;'><b>● ROUND STARTS ●</b></div>\";","\t\tvar R = fPart + \" background-color:#A80000;'><b>\" + iName2 + \"</b> goes first!</div>\";","\t\tsendChat('TurnTracker', \"/direct \" + C + R + \"<br>\" + intChat);","\t\treset();","\t}","\t/*--RESET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Reset') !== -1) {","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\t\tCampaign().set(\"turnorder\", '');","\t\tsendChat('', '/desc Turns Reset!');","\t}","});","/*------------------","HIGHLIGHT TURNS","------------------*/","on(\"change:campaign:turnorder\", function(obj, prev) {","\tif(!Campaign().get(\"turnorder\")) return;","\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\tif(!turn_order.length) return;","\tif(!turn_order[0].id == -1) {","\t\tSetPurple(turn_order, true);","\t\treturn;","\t}","\tvar current_token = getObj(\"graphic\", turn_order[0].id);","\tif(current_token != undefined) {","\t\tif(turn_order[0].pr == turn_order[0].pr) {","\t\t\tvar iName2 = getObj(\"graphic\", current_token.id).get(\"name\");","\t\t\toCharacter = getObj(\"character\", current_token.get(\"represents\"));","\t\t\tpColor = '#ff0000';","\t\t\tif(getObj(\"graphic\", current_token.id).get(\"layer\") == 'gmlayer') pColor = '#3D3D3D';","\t\t\tif(oCharacter != undefined) {","\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\tif(type == 'Player') {","\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t\tdieName = 'StartRound';","\t\t\tvar to = JSON.parse(obj.get('turnorder'));","\t\t\tloc = _.find(to, function(e) {","\t\t\t\treturn dieName === e.custom;","\t\t\t});","\t\t\tif(loc !== undefined) {","\t\t\t\tmovemarker(current_token, pColor, iName2);","\t\t\t} else SetPurple(turn_order, 1);","\t\t}","\t}","});","/*------------------","FUNCTIONS","------------------*/","//--MOVE TURN MARKER","function movemarker(current_token, pColor, iName2) {","\tif(current_token.get(\"layer\") == \"gmlayer\") {","        piclink = 'http://www.clker.com/cliparts/i/X/D/N/j/p/icon-with-question-mark-hi.png';","\t\tiName2 = \"UNKNOWN\";","\t} else {","        var piclink = current_token.get(\"imgsrc\");","        var size = current_token.get(\"height\");","        var HITS = {","            \"angle\": 0,","        \t\"angleRandom\": 180,","        \t\"duration\": 10,","        \t\"emissionRate\": 100,","        \t\"endColour\": [255, 255, 255, 0],","        \t\"endColourRandom\": [0, 0, 0, 0],","        \t\"gravity\": {\"x\":0, \"y\":0},","        \t\"lifeSpan\": 10,","        \t\"lifeSpanRandom\": 30,","        \t\"maxParticles\": 100,","        \t\"size\": size/2,","        \t\"sizeRandom\": 15,","        \t\"speed\": 0.0*(size/30),","        \t\"speedRandom\": 0.0*(size/30),","        \t\"startColour\": [50, 50, 150, 0.1],","        \t\"startColourRandom\": [0, 0, 0, 0.1]","        };","    spawnFxWithDefinition(current_token.get(\"left\"),current_token.get(\"top\"), HITS, current_token.get(\"_pageid\"));","\t}","\tvar picbox = \"<div style= 'background-color:#ffffff; display: inline-block; border: 1px solid #000; margin: 0.2em; border-radius: 10px 10px 10px 10px; align:'center''><img src=\" + piclink + \" style=height:30px; width:30px;'></div>\";","\tvar table = '<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"20%\">' + picbox + '</td><td width=\"90%\"><b>Turn: ' + iName2 + '</b></td></tr></table>';","\tvar R = iPart2 + \" background-color:#\" + pColor + \";'>\" + table + \"</div>\";","\tsendChat('', \"/direct \" + R);","};","//--SET BARS","function setbars(id1) {","\tif(id1.get(\"bar1_value\") == \"\" || id1.get(\"bar2_value\") == \"\") {","\t\tid1.set('bar1_value', 100);","\t\tid1.set('bar1_max', 100);","\t\tid1.set('bar2_value', 100);","\t\tid1.set('bar2_max', 100);","\t}","};","","function SetPurple(turn_order, toggle) {","\ti = 0;","\t_.each(turn_order, function(obj) {","\t\tvar tokens = getObj('graphic', turn_order[i].id);","\t\tif(tokens == undefined) return;","\t\ttokens.set(\"status_purple\", toggle);","\t\ti++;","\t});","};","//--SORT LIST","function sort(order) {","\tvar nOrd = order.sortByProp('pr');","\tCampaign().set(\"turnorder\", JSON.stringify(nOrd));","};","Array.prototype.sortByProp = function(p) {","\treturn this.sort(function(a, b) {","\t\treturn(parseInt(a[p], 10) < parseInt(b[p], 10)) ? 1 : (parseInt(a[p], 10) > parseInt(b[p], 10)) ? -1 : 0;","\t});","};","//--ADDPLAYER","function addPlayer(id, Roll, Attack) {","\tvar inc = Roll / Attack;","\tinc = Math.round(inc * 100) / 100;","\tvar init = Roll;","\tif(Roll > BestRoll) {","\t\tBestRoll = Roll;","\t}","\tvar table = [];","\tfor(var i = 0; i < Attack; i++) {","\t\tif(init >= 0) {","\t\t\tif(init == 0) init = 1;","\t\t\ttable.push(parseInt(init));","\t\t\tinit = (init - inc);","\t\t}","\t}","\toutput = pColor;","\tiName = iName.toUpperCase();","\tturnNums = table.toString();","\tif(id1.get(\"layer\") == 'gmlayer') iName = \"UNKNOWN\";","\tChatSay = iPart + \"background-color:\" + output + \";'>\" + \"<b>\" + iName + \"</b> (Att:\" + Attack + \") (Roll:\" + Roll + \")<br></b><b>\" + turnNums + \"</b></div>\";","\tif(iName == \"UNKNOWN\") ChatSay = \"\";","\tintChat1 = ChatSay;","\tintChat += intChat1;","\tTurnData[id] = {\"Roll\": Roll,\"Attack\": Attack,\"Table\": table};","};","//--CREATE ORDER","function createOrder() {","\tvar order = [];","\tfor(i = (BestRoll + 1); i > 0; i--) {","\t\t_.each(TurnData, function(value, key) {","\t\t\tif(value.Table.indexOf(i) != -1) {","\t\t\t\torder.push({\"id\": key,\"pr\": i,\"custom\": \"\"});","\t\t\t}","\t\t});","\t}","\torder.unshift({\"id\": '-1',\"pr\": 100,\"custom\": \"StartRound\"});","\treturn order;","};","//--RESET TURNS","function reset() {","\tTurnData = {};","\tBestRoll = 0;","\tintChat = '';","};"],"id":2},{"start":{"row":0,"column":0},"end":{"row":222,"column":2},"action":"insert","lines":["/*global gmC state on obj getObj iPart _ playerIsGM brPart RollRight formatNumber findObjs sendChat CONFIG lPart fPart gm_img gPart greenC redC grayC OuterDiv Campaign randomFromTo createObj fixNO toFront randomInteger*/","var WillTurnOrder = {};","var TurnData = {};","var BestRoll = 0;","var intChat = '';","/*------------------","API CHAT COMMANDS","------------------*/","on('chat:message', function(msg) {","    /*--TURNS-SET--*/","    if(msg.type == 'api' && msg.content.indexOf('!Turns') !== -1) {","\t\tvar turnorder;","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tsort(turnorder); /*--SORT TURNS--*/","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tSetPurple(turnorder, false);","\t\tfor(var i in turnorder) {","\t\t\tcAttacks = 5; /*-DEFAULT ATTACKS-*/","\t\t\tname = turnorder[i].id; /*-TURN ORDER WHO-*/","\t\t\tid1 = getObj(\"graphic\", turnorder[i].id); /*-GET TOKEN-*/","\t\t\tpColor = '#636363';","\t\t\tif(id1 != undefined) {","\t\t\t\toCharacter = getObj(\"character\", id1.get(\"represents\"));","\t\t\t\tiName = id1.get(\"name\");","\t\t\t\tif(oCharacter != undefined) {","\t\t\t\t\tiName = oCharacter.get(\"name\");","\t\t\t\t\toAttacks = findObjs({","\t\t\t\t\t\t_type: \"attribute\",","\t\t\t\t\t\tname: \"ATT\",","\t\t\t\t\t\t_characterid: oCharacter.id","\t\t\t\t\t})[0];","\t\t\t\t\tif(oAttacks != undefined) cAttacks = parseInt(oAttacks.get(\"current\"));","\t\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\t\tif(type == 'Player') {","\t\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t\t}","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined && id1.get(\"gmnotes\") != \"\") {","\t\t\t\t\tcAttacks = id1.get(\"gmnotes\");","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined) {","\t\t\t\t\tsetbars(id1);","\t\t\t\t}","\t\t\t\tvar init = parseInt(turnorder[i].pr);","\t\t\t\tif(init < cAttacks) {","\t\t\t\t\tinit = cAttacks;","\t\t\t\t\tturnorder[i].pr = cAttacks;","\t\t\t\t}","\t\t\t\taddPlayer(name, parseInt(init), parseInt(cAttacks));","\t\t\t}","\t\t}","\t\tvar sTurns = createOrder();","\t\tsort(sTurns); /*--SORT TURNS--*/","\t\tvar aFirst = JSON.parse(Campaign().get(\"turnorder\"));","\t\tvar iName2 = getObj(\"graphic\", aFirst[1].id).get(\"name\");","\t\tif(getObj(\"graphic\", aFirst[1].id).get(\"layer\") == 'gmlayer') iName2 = \"UNKNOWN\";","\t\tvar C = fPart + \" background-color:#A80000;'><b>● ROUND STARTS ●</b></div>\";","\t\tvar R = fPart + \" background-color:#A80000;'><b>\" + iName2 + \"</b> goes first!</div>\";","\t\tsendChat('TurnTracker', \"/direct \" + C + R + \"<br>\" + intChat);","\t\treset();","\t}","\t/*--RESET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Reset') !== -1) {","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\t\tCampaign().set(\"turnorder\", '');","\t\tsendChat('', '/desc Turns Reset!');","\t}","});","/*------------------","HIGHLIGHT TURNS","------------------*/","on(\"change:campaign:turnorder\", function(obj, prev) {","\tif(!Campaign().get(\"turnorder\")) return;","\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\tif(!turn_order.length) return;","\tif(!turn_order[0].id == -1) {","\t\tSetPurple(turn_order, true);","\t\treturn;","\t}","\tvar current_token = getObj(\"graphic\", turn_order[0].id);","\tif(current_token != undefined) {","\t\tif(turn_order[0].pr == turn_order[0].pr) {","\t\t\tvar iName2 = getObj(\"graphic\", current_token.id).get(\"name\");","\t\t\toCharacter = getObj(\"character\", current_token.get(\"represents\"));","\t\t\tpColor = '#ff0000';","\t\t\tif(getObj(\"graphic\", current_token.id).get(\"layer\") == 'gmlayer') pColor = '#3D3D3D';","\t\t\tif(oCharacter != undefined) {","\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\tif(type == 'Player') {","\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t\tdieName = 'StartRound';","\t\t\tvar to = JSON.parse(obj.get('turnorder'));","\t\t\tloc = _.find(to, function(e) {","\t\t\t\treturn dieName === e.custom;","\t\t\t});","\t\t\tif(loc !== undefined) {","\t\t\t\tmovemarker(current_token, pColor, iName2);","\t\t\t} else SetPurple(turn_order, 1);","\t\t}","\t}","});","/*------------------","FUNCTIONS","------------------*/","//--MOVE TURN MARKER","function movemarker(current_token, pColor, iName2) {","\tif(current_token.get(\"layer\") == \"gmlayer\") {","        piclink = 'http://www.clker.com/cliparts/i/X/D/N/j/p/icon-with-question-mark-hi.png';","\t\tiName2 = \"UNKNOWN\";","\t} else {","        var piclink = current_token.get(\"imgsrc\");","        var size = current_token.get(\"height\");","        var HITS = {","            \"angle\": 0,","        \t\"angleRandom\": 180,","        \t\"duration\": 10,","        \t\"emissionRate\": 100,","        \t\"endColour\": [255, 255, 255, 0],","        \t\"endColourRandom\": [0, 0, 0, 0],","        \t\"gravity\": {\"x\":0, \"y\":0},","        \t\"lifeSpan\": 10,","        \t\"lifeSpanRandom\": 30,","        \t\"maxParticles\": 100,","        \t\"size\": size/2,","        \t\"sizeRandom\": 15,","        \t\"speed\": 0.0*(size/30),","        \t\"speedRandom\": 0.0*(size/30),","        \t\"startColour\": [50, 50, 150, 0.1],","        \t\"startColourRandom\": [0, 0, 0, 0.1]","        };","    spawnFxWithDefinition(current_token.get(\"left\"),current_token.get(\"top\"), HITS, current_token.get(\"_pageid\"));","\t}","\tvar picbox = \"<div style= 'background-color:#ffffff; display: inline-block; border: 1px solid #000; margin: 0.2em; border-radius: 10px 10px 10px 10px; align:'center''><img src=\" + piclink + \" style=height:30px; width:30px;'></div>\";","\tvar table = '<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"20%\">' + picbox + '</td><td width=\"90%\"><b>Turn: ' + iName2 + '</b></td></tr></table>';","\tvar R = iPart2 + \" background-color:#\" + pColor + \";'>\" + table + \"</div>\";","\tsendChat('', \"/direct \" + R);","};","//--SET BARS","function setbars(id1) {","\tif(id1.get(\"bar1_value\") == \"\" || id1.get(\"bar2_value\") == \"\") {","\t\tid1.set('bar1_value', 100);","\t\tid1.set('bar1_max', 100);","\t\tid1.set('bar2_value', 100);","\t\tid1.set('bar2_max', 100);","\t}","};","","function SetPurple(turn_order, toggle) {","\ti = 0;","\t_.each(turn_order, function(obj) {","\t\tvar tokens = getObj('graphic', turn_order[i].id);","\t\tif(tokens == undefined) return;","\t\ttokens.set(\"status_purple\", toggle);","\t\ti++;","\t});","};","//--SORT LIST","function sort(order) {","\tvar nOrd = order.sortByProp('pr');","\tCampaign().set(\"turnorder\", JSON.stringify(nOrd));","};","Array.prototype.sortByProp = function(p) {","\treturn this.sort(function(a, b) {","\t\treturn(parseInt(a[p], 10) < parseInt(b[p], 10)) ? 1 : (parseInt(a[p], 10) > parseInt(b[p], 10)) ? -1 : 0;","\t});","};","//--ADDPLAYER","function addPlayer(id, Roll, Attack) {","\tvar inc = Roll / Attack;","\tinc = Math.round(inc * 100) / 100;","\tvar init = Roll;","\tif(Roll > BestRoll) {","\t\tBestRoll = Roll;","\t}","\tvar table = [];","\tfor(var i = 0; i < Attack; i++) {","\t\tif(init >= 0) {","\t\t\tif(init == 0) init = 1;","\t\t\ttable.push(parseInt(init));","\t\t\tinit = (init - inc);","\t\t}","\t}","\toutput = pColor;","\tiName = iName.toUpperCase();","\tturnNums = table.toString();","\tif(id1.get(\"layer\") == 'gmlayer') iName = \"UNKNOWN\";","\tChatSay = iPart + \"background-color:\" + output + \";'>\" + \"<b>\" + iName + \"</b> (Att:\" + Attack + \") (Roll:\" + Roll + \")<br></b><b>\" + turnNums + \"</b></div>\";","\tif(iName == \"UNKNOWN\") ChatSay = \"\";","\tintChat1 = ChatSay;","\tintChat += intChat1;","\tTurnData[id] = {\"Roll\": Roll,\"Attack\": Attack,\"Table\": table};","};","//--CREATE ORDER","function createOrder() {","\tvar order = [];","\tfor(i = (BestRoll + 1); i > 0; i--) {","\t\t_.each(TurnData, function(value, key) {","\t\t\tif(value.Table.indexOf(i) != -1) {","\t\t\t\torder.push({\"id\": key,\"pr\": i,\"custom\": \"\"});","\t\t\t}","\t\t});","\t}","\torder.unshift({\"id\": '-1',\"pr\": 100,\"custom\": \"StartRound\"});","\treturn order;","};","//--RESET TURNS","function reset() {","\tTurnData = {};","\tBestRoll = 0;","\tintChat = '';","};"]}]]},"ace":{"folds":[],"scrolltop":2329,"scrollleft":0,"selection":{"start":{"row":222,"column":2},"end":{"row":222,"column":2},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":207,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1489192103089,"hash":"5a104c50cf6fe37cdd8bd53b0433a6c90fda3c16"}