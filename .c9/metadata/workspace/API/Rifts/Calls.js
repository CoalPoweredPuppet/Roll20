{"filter":false,"title":"Calls.js","tooltip":"/API/Rifts/Calls.js","undoManager":{"mark":1,"position":1,"stack":[[{"start":{"row":0,"column":0},"end":{"row":232,"column":2},"action":"remove","lines":["/*------------------","PAGECHANGE","------------------*/","on(\"change:campaign:playerpageid\", function (obj, prev) {","    var currentPage = getObj(\"page\", Campaign().get(\"playerpageid\"));","    var pName = currentPage.get(\"name\");","    var help = OuterDiv+iPart + \"color: #B3B3B3; background-image: url(\"+page_img+\");'><b>● Page: \"+pName+\" ●</div></div>\";","\tsendChat('GM', \"/direct \" + help);","});","on('chat:message', function(whisper) {","    if(whisper.type == 'whisper') {","        var who=getObj('player',whisper.playerid);","        if (who !== undefined) sendChat(\"system\", '/w GM <b>' + whisper.who + ' to ' + whisper.target_name + '-<br>' + TopBar+\";'>\"+whisper.content+\"</div>\");","    };","});","/*------------------","READY","------------------*/","on('ready',function(){","    'use strict';","    var Ca = hexToRgbA('fbafff')","    var currentPage = getObj(\"page\", Campaign().get(\"playerpageid\"));","    if(state.bloodlist == undefined) state.bloodlist = [];","    var currentTime = new Date();","    var timestamp = (new Date(currentTime));","    sendChat('API', \"/w GM &{template:RIFTS} {{name=API STARTED}} {{<small>Time:=<small>\" + timestamp + \"}}\");","    //var tables = findObjs({_type: \"rollabletable\"});","    //----------------","    var getCleanImgsrc = function (imgsrc) {","       var parts = imgsrc.match(/(.*\\/images\\/.*)(thumb|med|original|max)(.*)$/);","       if(parts) {","          return parts[1]+'thumb'+parts[3];","       }","       return;","    };","    _.chain(findObjs({type:'character'}))","        .filter( c=>''===c.get('avatar'))","        .each( c=>{","            c.get('defaulttoken',(dt)=>{","                let deftoken=JSON.parse(dt);","                if(deftoken && _.has(deftoken,'imgsrc')){","                    let imgsrc=getCleanImgsrc(deftoken.imgsrc);","                    if(imgsrc){","                        c.set('avatar',imgsrc);","                        sendChat('',`/w gm <div><img src=\"${imgsrc}\" style=\"max-width: 3em;max-height: 3em;border:1px solid #333; background-color: #999; border-radius: .2em;\"><code>Updated ${c.get('name')}</code></div>`);","                    }","                }","            });","        });","});","/*","var Gradients = Gradients || (function() {","   var COLOR = '#ffee33',","         GRAD = (arg)=>`background-image:-webkit-linear-gradient(left,#000000,${arg||COLOR},#000000);`;","   return {","     COLOR, GRAD","   };","}());","on('ready',function(){","    log(Gradients.GRAD());","    log(Gradients.GRAD('#003399'));","});","*/","/*------------------","DIVS","------------------*/","var font = 'Arial';","var greenC = \"#438032\";","var gmC = \"#22571F\";","var redC = \"#A34645\";","var grayC = \"#666666\";","var bShadow =\"3px 3px 1px #707070\";","var tshadow = \"-1px -1px #000, 1px -1px #000, -1px 1px #000, 1px 1px #000 , 2px 2px #222;\";","//---ImgLinks","var page_img = \"http:\\\\//1.bp.blogspot.com/-7AhozEGVBBA/T6aqzDZcVOI/AAAAAAAAAQQ/TBH76givpIs/s1600/TEXleatherthree.png\";","//---START BOXES CODE","var fPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\"; text-align: center; vertical-align: middle; padding: 1px 1px; margin-top: 0.1em; border: 1px solid #000; border-radius: 0px 0px 10px 10px; color: #FFF;\";","var lPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\"; font-size: 9pt;  text-align: left; vertical-align: middle; background-position:center; padding: 1px 1px; margin-top: 0.2em; border: 2px solid #000; border-radius: 8px 8px 8px 8px; color: #FFF;\";","var hPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; font-size: 7pt; text-align: left; vertical-align: middle; background-position:center; padding: 1px 1px; margin-top: 0.2em; border: 2px solid #000; border-radius: 8px 8px 8px 8px; color: #000;\";","var iPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\";  text-align: center; vertical-align: middle; padding: 0px; margin-top: 0.1em; border: 1px solid #000; border-radius: 10px 10px 10px 10px; color: #FFF;\";","var iPart2 = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\";font-size: 10pt; text-align: left; vertical-align: middle; padding: 0px; margin-top: 0.1em; border: 1px solid #000; border-radius: 10px 10px 10px 10px; color: #FFF;\";","var gPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\"; text-align: center; vertical-align: middle; padding: 2px 2px; margin-top: 0.2em; border: 1px solid #919191; border-radius: 8px 8px 8px 8px; color: #FFF;\";","var ePart = \"<div style='box-shadow: \"+bShadow+\"; text-align: center; vertical-align: middle; padding: 2px 2px; margin-top: 0.2em; border: 1px solid #000; border-radius: 8px 8px 8px 8px; color: #000;\";","var brPart = \"<div style='font-family: \"+font+\"; text-shadow: \"+tshadow+\"; text-align: center; vertical-align: middle; border: 1px solid #000; color: #FFF;\";","var OuterDiv = '<div style=\"box-shadow: '+bShadow+'; border: 2px solid black;  text-align: center; vertical-align: middle; background-color: gray; padding: 3px 3px 3px 3px; border-radius: 10px 10px 10px 10px;\">';","/*------------------","Generic Functions","------------------*/","function hexToRgbP(hex){","    var c;","    if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){","        c= hex.substring(1).split('');","        if(c.length== 3){","            c= [c[0], c[0], c[1], c[1], c[2], c[2]];","        }","        c= '0x'+c.join('');","        var RGB = 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+',1)';","        return RGB;","    }","    throw new Error('Bad Hex');","}","function MakeMid(MidBar,PlayerBGColor,PlayerBarColor){","        var BAR = MidBar + \"background-color:\"+ PlayerBGColor +\";\"+ PlayerBarColor +\";'>\";","        return BAR;","}","function hexToRgbA(hex){","    hex = hex.replace('#','');","    r = parseInt(hex.substring(0,2), 16);","    g = parseInt(hex.substring(2,4), 16);","    b = parseInt(hex.substring(4,6), 16);","    result = [r,g,b,1.0];","    return result;","}","//-------PLAYER COLOR","function GetPColor(Player){","\tvar cBy = Player.get('controlledby');","\tplayer = getObj('player', cBy);","\tpColor = player.get('color');","\treturn pColor;","}","function PlaySound(trackname, time, stop) {","    var trackname = trackname.toUpperCase()","    var track = findObjs({type: 'jukeboxtrack', title: trackname})[0];","    if(track) {","        //track.set('playing',false);","        track.set('softstop',false);","        track.set('playing',true);","    }","    else {","        log(\"No track found \"+ trackname);","    }","}","//-----","function MakeMid(MidBar,PlayerBGColor,PlayerBarColor){","        var BAR = MidBar + \"background-color:\"+ PlayerBGColor +\";\"+ PlayerBarColor +\";'>\";","        return BAR;","}","function SetStat(Player1,Atype,cost){","\tvar ammoC = parseInt(cost);","\tvar ammo0 = findObjs({_type: \"attribute\",name: Atype,_characterid: Player1.id}, {caseInsensitive: true})[0];","\tif(ammoC === undefined || isNaN(ammoC)) ammoC = 1;","\tvar cAmmo = parseInt(ammo0.get(\"current\"));","\tvar mAmmo = parseInt(ammo0.get(\"max\"));","\tvar curPageID = findObjs({_type: \"campaign\"})[0].get(\"playerpageid\");","\tvar curPage = findObjs({_type: \"page\", _id: curPageID})[0];","\tvar tokens = findObjs({_type: \"graphic\", layer:\"objects\", _pageid: curPageID, name: Player1.get(\"name\")});","\t_.each(tokens, function(id) {","\t\tvar who = getObj('character', id.get(\"_represents\"));","\t\tvar aSet = findObjs({_type: \"attribute\",name: Atype,_characterid: who.id} , {caseInsensitive: true});","\t\taSet = aSet[0].id;","\t\tid.set(\"bar3_link\", aSet);","\t\tid.set('bar3_value', cAmmo);","\t\tid.set('bar3_max', mAmmo);","\t});","\tif (cAmmo < 0 || cAmmo < ammoC) {","\t\tcAmmo = \"0\";","\t\tammo0.set('current', cAmmo);","\t}","\telse if (cAmmo <= 2 || cAmmo < ammoC) {","\t\tcAmmo = cAmmo - ammoC;","\t\tammo0.set('current', cAmmo);","\t}","\telse {","\t\tcAmmo = cAmmo - ammoC;","\t\tammo0.set('current', cAmmo);","\t}","}","//RANDOM IMAGE","function randomFromTo(from, to){","\treturn Math.floor(Math.random() * (to - from + 1) + from);","}","//make number","function formatNumber (num) {","\treturn num.toString().replace(/(\\d)(?=(\\d{3})+(?!\\d))/g, \"$1,\");","}","//set character name","function RollRight (whoPC) {","\tvar character = findObjs({type: 'character',controlledby: whoPC})[0];","\treturn character;","}","//find level","function fLevel() {","\tvar characters = findObjs({_type: \"character\"});","\tvar chat = '';","\tvar lTotal = 0;","\tvar count = 0;","\t_.each(characters, function (id) {","\t\tvar aa = id.get(\"inplayerjournals\");","\t\tvar aSet = findObjs({_type: \"attribute\",name: \"Level\",_characterid: id.id}, {caseInsensitive: true})[0];","\t\tif(aa == \"all\" && aSet !== undefined) {","\t\t    var aName = findObjs({_type: \"attribute\",name: \"Name\",_characterid: id.id}, {caseInsensitive: true})[0];","\t\t    //log(aSet.get(\"current\") + \" \" +aName.get(\"current\"));","\t\t\tvar a2 = parseInt(aSet.get(\"current\"));","\t\t\tcount = count + 1;","\t\t\tlTotal = lTotal + a2;","\t\t}","\t});","\tlTotal = Math.round(lTotal / count);","\treturn lTotal;","}","//parse loot","function myrolls(loota) {","\tfor(var i = 0; i < loota.length; i++) {","\t\tvar ii = (loota[i].indexOf(\"[[\") != -1);","\t\tif(ii == true) {","\t\t\tvar num = loota[i].replace(/[^0-9]/g, '');","\t\t\tvar res1 = num.substr(0, 1);","\t\t\tvar res2 = num.substr(1, 4);","\t\t\tvar ia = 1;","\t\t\tvar tot = 0;","\t\t\twhile(ia <= res1) {","\t\t\t\tvar tot = tot + randomInteger(res2);","\t\t\t\tia++;","\t\t\t}","\t\t\treturn tot;","\t\t}","\t}","}","function DT(text){","    sendChat('API', \"/w GM \" + text);","}","function MakeRollNum(cont, inline) {","    return _.chain(inline)","        .reduce(function (m, v, k) {","        m['$[[' + k + ']]'] = v.results.total || 0;","        return m;","    }, {})","        .reduce(function (m, v, k) {","        d20 = m.replace(k, v);","        return m.replace(k, v);","    },","        cont).value();","};"],"id":2},{"start":{"row":0,"column":0},"end":{"row":203,"column":2},"action":"insert","lines":["//PAGECHANGE","on(\"change:campaign:playerpageid\", function (obj, prev) {","    var currentPage = getObj(\"page\", Campaign().get(\"playerpageid\"));","    var pName = currentPage.get(\"name\");","    var help = OuterDiv+iPart + \"color: #B3B3B3; background-image: url(\"+page_img+\");'><b>● Page: \"+pName+\" ●</div></div>\";","\tsendChat('GM', \"/direct \" + help);","});","//LOG WHISPER","on('chat:message', function(whisper) {","    if(whisper.type == 'whisper') {","        var who=getObj('player',whisper.playerid);","        if (who !== undefined) sendChat(\"system\", '/w GM <b>' + whisper.who + ' to ' + whisper.target_name + '-<br>' + TopBar+\";'>\"+whisper.content+\"</div>\");","    };","});","/*------------------","READY","------------------*/","on('ready', function () {","    'use strict';","    var currentPage = getObj(\"page\", Campaign().get(\"playerpageid\"));","    var currentTime = new Date();","    var timestamp = (new Date(currentTime));","    sendChat('API', \"/w GM &{template:RIFTS} {{name=API STARTED}} {{<small>Time:=<small>\" + timestamp + \"}}\");","    //----------------","    var getCleanImgsrc = function (imgsrc) {","        var parts = imgsrc.match(/(.*\\/images\\/.*)(thumb|med|original|max)(.*)$/);","        if(parts) {","            return parts[1] + 'thumb' + parts[3];","        }","        return;","    };","    _.chain(findObjs({type: 'character'})).filter(c => '' === c.get('avatar')).each(c => {c.get('defaulttoken', (dt) => {","            let deftoken = JSON.parse(dt);","            if(deftoken && _.has(deftoken, 'imgsrc')) {","                let imgsrc = getCleanImgsrc(deftoken.imgsrc);","                if(imgsrc) {","                    c.set('avatar', imgsrc);","                    sendChat('', `/w gm <div><img src=\"${imgsrc}\" style=\"max-width: 3em;max-height: 3em;border:1px solid #333; background-color: #999; border-radius: .2em;\"><code>Updated ${c.get('name')}</code></div>`);","                }","            }","        });","    });","});","/*------------------","DIVS","------------------*/","var font = 'Arial';","var greenC = \"#438032\";","var gmC = \"#22571F\";","var redC = \"#A34645\";","var grayC = \"#666666\";","var bShadow =\"3px 3px 1px #707070\";","var tshadow = \"-1px -1px #000, 1px -1px #000, -1px 1px #000, 1px 1px #000 , 2px 2px #222;\";","//---ImgLinks","var page_img = \"http:\\\\//1.bp.blogspot.com/-7AhozEGVBBA/T6aqzDZcVOI/AAAAAAAAAQQ/TBH76givpIs/s1600/TEXleatherthree.png\";","//---START BOXES CODE","var fPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\"; text-align: center; vertical-align: middle; padding: 1px 1px; margin-top: 0.1em; border: 1px solid #000; border-radius: 0px 0px 10px 10px; color: #FFF;\";","var lPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\"; font-size: 9pt;  text-align: left; vertical-align: middle; background-position:center; padding: 1px 1px; margin-top: 0.2em; border: 2px solid #000; border-radius: 8px 8px 8px 8px; color: #FFF;\";","var hPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; font-size: 7pt; text-align: left; vertical-align: middle; background-position:center; padding: 1px 1px; margin-top: 0.2em; border: 2px solid #000; border-radius: 8px 8px 8px 8px; color: #000;\";","var iPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\";  text-align: center; vertical-align: middle; padding: 0px; margin-top: 0.1em; border: 1px solid #000; border-radius: 10px 10px 10px 10px; color: #FFF;\";","var iPart2 = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\";font-size: 10pt; text-align: left; vertical-align: middle; padding: 0px; margin-top: 0.1em; border: 1px solid #000; border-radius: 10px 10px 10px 10px; color: #FFF;\";","var gPart = \"<div style='box-shadow: \"+bShadow+\"; font-family: \"+font+\"; text-shadow: \"+tshadow+\"; text-align: center; vertical-align: middle; padding: 2px 2px; margin-top: 0.2em; border: 1px solid #919191; border-radius: 8px 8px 8px 8px; color: #FFF;\";","var ePart = \"<div style='box-shadow: \"+bShadow+\"; text-align: center; vertical-align: middle; padding: 2px 2px; margin-top: 0.2em; border: 1px solid #000; border-radius: 8px 8px 8px 8px; color: #000;\";","var brPart = \"<div style='font-family: \"+font+\"; text-shadow: \"+tshadow+\"; text-align: center; vertical-align: middle; border: 1px solid #000; color: #FFF;\";","var OuterDiv = '<div style=\"box-shadow: '+bShadow+'; border: 2px solid black;  text-align: center; vertical-align: middle; background-color: gray; padding: 3px 3px 3px 3px; border-radius: 10px 10px 10px 10px;\">';","/*------------------","Generic Functions","------------------*/","function hexToRgbP(hex){","    var c;","    if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){","        c= hex.substring(1).split('');","        if(c.length== 3){","            c= [c[0], c[0], c[1], c[1], c[2], c[2]];","        }","        c= '0x'+c.join('');","        var RGB = 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+',1)';","        return RGB;","    }","    throw new Error('Bad Hex');","}","function hexToRgbA(hex){","    hex = hex.replace('#','');","    r = parseInt(hex.substring(0,2), 16);","    g = parseInt(hex.substring(2,4), 16);","    b = parseInt(hex.substring(4,6), 16);","    result = [r,g,b,1.0];","    return result;","}","//-------PLAYER COLOR  ","function GetPColor(Player){","\tvar cBy = Player.get('controlledby');","\tplayer = getObj('player', cBy);","\tpColor = player.get('color');","\treturn pColor;","}","function PlaySound(trackname, time, stop) {","    var trackname = trackname.toUpperCase()","    var track = findObjs({type: 'jukeboxtrack', title: trackname})[0];","    if(track) {","        track.set('softstop',false);","        track.set('playing',true);","    }","    else {","        log(\"No track found \"+ trackname);","    }","}","//-----","function SetStat(Player1,Atype,cost){","\tvar ammoC = parseInt(cost);","\tvar ammo0 = findObjs({_type: \"attribute\",name: Atype,_characterid: Player1.id}, {caseInsensitive: true})[0];","\tif(ammoC === undefined || isNaN(ammoC)) ammoC = 1;","\tvar cAmmo = parseInt(ammo0.get(\"current\"));","\tvar mAmmo = parseInt(ammo0.get(\"max\"));","\tvar curPageID = findObjs({_type: \"campaign\"})[0].get(\"playerpageid\");","\tvar curPage = findObjs({_type: \"page\", _id: curPageID})[0];  ","\tvar tokens = findObjs({_type: \"graphic\", layer:\"objects\", _pageid: curPageID, name: Player1.get(\"name\")});","\t_.each(tokens, function(id) {","\t\tvar who = getObj('character', id.get(\"_represents\"));","\t\tvar aSet = findObjs({_type: \"attribute\",name: Atype,_characterid: who.id} , {caseInsensitive: true});","\t\taSet = aSet[0].id;","\t\tid.set(\"bar3_link\", aSet);","\t\tid.set('bar3_value', cAmmo);","\t\tid.set('bar3_max', mAmmo);","\t});","\tif (cAmmo < 0 || cAmmo < ammoC) {","\t\tcAmmo = \"0\";","\t\tammo0.set('current', cAmmo);","\t}","\telse if (cAmmo <= 2 || cAmmo < ammoC) {","\t\tcAmmo = cAmmo - ammoC;","\t\tammo0.set('current', cAmmo);","\t} ","\telse {","\t\tcAmmo = cAmmo - ammoC;","\t\tammo0.set('current', cAmmo);","\t}","}","//RANDOM IMAGE","function randomFromTo(from, to){","\treturn Math.floor(Math.random() * (to - from + 1) + from);","}","//make number","function formatNumber (num) {","\treturn num.toString().replace(/(\\d)(?=(\\d{3})+(?!\\d))/g, \"$1,\");","}","//set character name","function RollRight (whoPC) {","\tvar character = findObjs({type: 'character',controlledby: whoPC})[0];","\treturn character;","}","//find level","function fLevel() {","\tvar characters = findObjs({_type: \"character\"});","\tvar chat = '';","\tvar lTotal = 0;","\tvar count = 0;","\t_.each(characters, function (id) {","\t\tvar aa = id.get(\"inplayerjournals\");","\t\tvar aSet = findObjs({_type: \"attribute\",name: \"Level\",_characterid: id.id}, {caseInsensitive: true})[0];","\t\tif(aa == \"all\" && aSet !== undefined) {","\t\t    var aName = findObjs({_type: \"attribute\",name: \"Name\",_characterid: id.id}, {caseInsensitive: true})[0];","\t\t    //log(aSet.get(\"current\") + \" \" +aName.get(\"current\"));","\t\t\tvar a2 = parseInt(aSet.get(\"current\"));","\t\t\tcount = count + 1;","\t\t\tlTotal = lTotal + a2;","\t\t}","\t});","\tlTotal = Math.round(lTotal / count);","\treturn lTotal;","}","//parse loot","function myrolls(loota) {","\tfor(var i = 0; i < loota.length; i++) {","\t\tvar ii = (loota[i].indexOf(\"[[\") != -1);","\t\tif(ii == true) {","\t\t\tvar num = loota[i].replace(/[^0-9]/g, '');","\t\t\tvar res1 = num.substr(0, 1);  ","\t\t\tvar res2 = num.substr(1, 4);            ","\t\t\tvar ia = 1;","\t\t\tvar tot = 0;","\t\t\twhile(ia <= res1) {","\t\t\t\tvar tot = tot + randomInteger(res2);","\t\t\t\tia++;","\t\t\t}","\t\t\treturn tot;","\t\t}","\t}","}","function DT(text){","    sendChat('API', \"/w GM \" + text);","}","function MakeRollNum(cont, inline) {","    return _.chain(inline)","        .reduce(function (m, v, k) {","        m['$[[' + k + ']]'] = v.results.total || 0;        ","        return m;","    }, {})","        .reduce(function (m, v, k) {","        d20 = m.replace(k, v);","        return m.replace(k, v);        ","    },","        cont).value();","};"]}],[{"start":{"row":89,"column":21},"end":{"row":89,"column":23},"action":"remove","lines":["  "],"id":3},{"start":{"row":115,"column":60},"end":{"row":115,"column":62},"action":"remove","lines":["  "]},{"start":{"row":132,"column":2},"end":{"row":132,"column":3},"action":"remove","lines":[" "]},{"start":{"row":177,"column":31},"end":{"row":177,"column":33},"action":"remove","lines":["  "]},{"start":{"row":178,"column":31},"end":{"row":178,"column":43},"action":"remove","lines":["            "]},{"start":{"row":195,"column":51},"end":{"row":195,"column":59},"action":"remove","lines":["        "]},{"start":{"row":200,"column":31},"end":{"row":200,"column":39},"action":"remove","lines":["        "]}]]},"ace":{"folds":[],"scrolltop":2063,"scrollleft":0,"selection":{"start":{"row":203,"column":2},"end":{"row":203,"column":2},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":146,"state":"no_regex","mode":"ace/mode/javascript"}},"timestamp":1489192006912,"hash":"4d65cd22763fac3c3fc11ebbb03e803646c0af26"}