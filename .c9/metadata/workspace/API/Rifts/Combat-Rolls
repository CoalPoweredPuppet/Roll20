{"filter":false,"title":"Combat-Rolls","tooltip":"/API/Rifts/Combat-Rolls","undoManager":{"mark":0,"position":0,"stack":[[{"start":{"row":0,"column":0},"end":{"row":331,"column":0},"action":"remove","lines":["//!attack --[[1d20]] --[[3d6]] --saying! --ammotype","/*global PlaySound MakeRollNum on findObjs RollRight _ sendChat bShadow font getObj"," */","on('chat:message', function(msg) {","\tif (msg.type != \"api\") return;","\tvar msgTxt = msg.content;","\tvar command = msg.content.split(\" \", 1);","\tvar cWho = findObjs({_type: 'character',name: msg.who})[0];","\tif (cWho == undefined && msg.who.indexOf(\"(GM)\") == -1) {","\t\tcWho = RollRight(msg.playerid);","\t\tmsg.who = cWho.get(\"name\");","\t}","/*-----------START-----------*/","\tif (command == \"!attack\") {","\t\tPlaySound('dice', 9000);","\t\tvar who = msg.who;","\t\tmsg.content = MakeRollNum(msg.content, msg.inlinerolls);","//check rolls---------------------","\t\tvar ar = msg.inlinerolls[0];","\t\tvar dr = msg.inlinerolls[1];","//define var----------------------","\t\tif (ar === undefined || dr === undefined) {","\t\t\tsendChat('', \"/direct <B><I>bad macro!\");","\t\t\treturn;","\t\t}","\t\tmsgFormula = msgTxt.split(\" --\");","\t\tvar Saycolor = \"#964141\";","\t\tvar Lucky = 20;","\t\tvar failRange = 1;","\t\tvar dParts = \"\";","\t\tvar dRoll = \"\";","\t\tvar DD = \"\";","\t\tvar bText = \"\";","\t\tvar DDtext = \"\";","\t\tvar bg_crit = \"\";","\t\tvar fumble = 0;","\t\tvar boxcolor = getObj(\"player\", msg.playerid).get(\"color\");","\t\tvar crit_img = \"http:\\\\//media.giphy.com/media/3KqZp8MBaf1Ty/giphy.gif\";","\t\tvar fail_img = \"http:\\\\//fc06.deviantart.net/fs70/f/2013/076/5/2/_tutorial__creating_an_animated_light_pulse_in_ps_by_d_k0d3-d5ybir4.gif\";","\t\tif (msg.who == \"GM (GM)\") {","\t\t\tboxcolor = '#831F29';","\t\t\twho = \"NPC\";","\t\t}","/*-----------BOXES-----------*/","\t\tvar topimg = \"https://s3.amazonaws.com/files.staging.d20.io/images/181118/cN5ui3MXx87UBgVUgzwYTQ/med.jpg?141868063\";","\t\tvar tshadow2 = \"-1px -1px #444, 1px -1px #444, -1px 1px #444, 1px 1px #444\";","\t\tvar SayParts = \"<div style='text-shadow: 1px 1px #000, -1px -1px #000, -1px 1px #000, 1px -1px #000; margin: 0em 0em 0em 0em;; font-size:8pt; display:inline-block; text-align: center; vertical-align:middle; padding: 0px 6px 0px 6px; border: 1px solid #000; border-radius: 3px; color: #FFF; background-image: url(\" + topimg + \");'>\";","\t\tvar MainSay = \"<div style='box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family:\" + font + \"; font-size: x-small; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color:#CEC7B6; color: #000;'>\";","\t\tvar MainEven = \"<div style='box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #CEC7B6; color: #000;'>\";","\t\tvar MainOdd = \"<div style='box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #C0B9A8; color: #000;'>\";","\t\tvar RollParts = \"<div style='margin: 0em 0.1em 0.1em 0em; font-size: 10pt; text-shadow: \" + tshadow2 + \"; width: 15px; height: 15px; line-height: 15px; display:inline-block; text-align:center; padding: 0px 1px 0px 0px; border: 1px solid #000; border-radius: 3px; color: #FFF;\";","\t\tPlaySound('dice', 9000);","/*-----------START2-----------*/","","//set motto","\t\tif (msgFormula[3] !== undefined) {","\t\t\tvar ammoleng = msgFormula[3].length - 1;","\t\t\tvar sayingCheck = parseInt(msgFormula[3].substr(ammoleng));","\t\t\tif (isNaN(sayingCheck)) {","\t\t\t\tCustom = msgFormula[3].toUpperCase();","\t\t\t}","\t\t\telse if (msgFormula[3] !== undefined && msgFormula[4] == undefined) {","\t\t\t\tCustom = msgFormula[3].toUpperCase();","\t\t\t\tvar gunleng = msgFormula[3].length - 2;","\t\t\t\tvar Custom = msgFormula[3].substr(0, gunleng).toUpperCase();","\t\t\t}","\t\t}","\t\telse {","\t\t\tCustom = \"ATTACK:\";","\t\t}","//Check for GUN","\t\tif (msgFormula[4] === undefined) msgFormula[4] = msgFormula[3];","\t\tif (msgFormula[4] !== undefined && who !== \"NPC\") {","\t\t\tvar ammoleng = msgFormula[4].length - 1;","\t\t\tvar ammo = parseInt(msgFormula[4].substr(ammoleng));","\t\t\tif (!isNaN(ammo)) {","\t\t\t\tvar gunleng = msgFormula[4].length - 2;","\t\t\t\tvar gun = msgFormula[4].substr(0, gunleng);","\t\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\tif (FindGun == undefined) {","\t\t\t\t\tFindGun = findObjs({name: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t}","\t\t\t\tif (FindGun == undefined) {","\t\t\t\t\tsendChat('Error', \"/desc \" + msg.who + \" You do not own a  \" + gun);","\t\t\t\t\treturn;","\t\t\t\t}","\t\t\t\tvar attName = FindGun.get(\"name\");","\t\t\t\tvar leng = attName.length - 5;","\t\t\t\tvar res = attName.substr(leng, 5);","\t\t\t\tleng = attName.substr(0, leng);","\t\t\t\tvar ammo0 = findObjs({name: leng + \"_WEAPpay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\tif (ammo0 == undefined) {","\t\t\t\t\tammo0 = FindGun","\t\t\t\t}","\t\t\t}","\t\t}","/*-----------ATTACK PARTS-----------*/","//--Attack Modifier","\t\tvar mod;","\t\tif (ar.results.rolls[1] === undefined) mod = \"\";","\t\telse mod = (ar.results.rolls[1].expr);","\t\tvar aRollraw = ar.results.rolls[0].results[0]['v'];","\t\t//Attack total and type","\t\tvar Atotal = (ar.results.total);","\t\tvar Atype = \"<a style='color:RED'>\" + ar.expression + \"</a>\";","","//DAMAGE PARTS-----------------","//--Damage modifier","\t\tvar dMod;","\t\tif (dr.results.rolls[1] === undefined) dMod = \"\";","\t\telse dMod = (dr.results.rolls[1].expr);","//--Set damage total","\t\tvar Dtotal = dr.results.total;","//--Make damage text for all rolls","\t\tvar dam = dr.results.rolls[0];","\t\tvar damsort = dam.results;","\t\tvar i = 0;","\t\t//damsort.sort(function(a, b){return a.v < b.v;});","\t\twhile (dam.results[i] !== undefined) {","\t\t\tvar dNum = dam.results[i]['v'];","\t\t\tvar ddimg = \"http://image.blingee.com.s3.amazonaws.com/images19/content/output/000/000/000/061/788808721_1076628.gif?4\";","\t\t\tvar bg_max = \"background-position:center; background-image: url(\" + ddimg + \");\";","\t\t\tif (dNum == 1) num = RollParts + \"background-color:#A80000;'>\" + dNum + \"</div></b></a>\";","\t\t\telse if (dNum == dr.results.rolls[0].sides) num = RollParts + \"background-color:#00A120;\" + bg_max + \"'><b>\" + dNum + \"</b></div></b></a>\";","\t\t\telse num = RollParts + \"background-color:#696969;'>\" + dNum + \"</div>\";","\t\t\tdRoll = dRoll + \"\" + (num);","\t\t\ti++;","\t\t}","\t\tvar Dtype = \"<a style='color:RED;'>\" + dr.expression + \"</a>\";","\t\tdRoll = dRoll + \"<b>\" + dMod + \"</b>\";","//--Set Double Damage","\t\tif (aRollraw >= 20) {","\t\t\tDtotal = \"<a style='color:RED'><strong style='font-size: 110%;'>\" + Dtotal * 2 + \"!</strong></a>\";","\t\t\tAtotal = \"<a style='color:RED'><strong style='font-size: 110%;'>\" + Atotal + \"!</strong></a>\";","\t\t\tbText = bText + \" \" + '<b>DOUBLE DAMAGE!</b><BR><b>(NATURAL 20!)</b>';","\t\t\tbg_crit = \"background-position:center; background-image: url(\" + crit_img + \");\";","\t\t\tPlaySound('Critical', 9000);","\t\t}","//--Set Miss","\t\tif (aRollraw <= 3) {","\t\t\tnum = RollParts + \"background-color:#A80000;'>\" + aRollraw + \"</div>\";","\t\t\tDtotal = \"<a style='color:#000'>\" + Dtotal + \"!</a>\";","\t\t\tAtotal = \"<a style='color:#000'>\" + Atotal + \"!</a>\";","\t\t\tbText = bText + \" \" + 'MISS';","\t\t\tboxcolor = \"#bbb\";","\t\t\tSaycolor = \"#555\";","\t\t}","\t\telse num = RollParts + \"background-color:#696969;'>\" + aRollraw + \"</div>\";","\t\taRoll = num;","//CHATBOX PARTS----------------","\t\tMain = MainSay + SayParts + \"<b><i>●\" + Custom + \"●</i></b></div></div>\";","\t\tMain = Main + MainOdd + Atype + \" <b>To Hit: </b>\" + aRoll + \"<b>\" + mod + \" = <a style='color:BLUE'>\" + Atotal + \"</b></a></div>\";","\t\tMain = Main + MainEven + Dtype + \"<b> Damage:<br></b>\" + dRoll + \"<b> = <a style='color:BLUE'>\" + Dtotal + \"</b></a></div>\";","//CRIT_FUMBLE PARTS----------------","//--CRIT roll","\t\taRollraw1 = randomInteger(Lucky);","\t\tif (aRollraw1 >= Lucky && aRollraw > 4) {","\t\t\tMain = Main + MainOdd + \"<a style = 'color:PURPLE'><b>Lucky Shot!: \" + aLoc[Math.floor(Math.random() * aLoc.length)] + \"</b></div>\";","\t\t\tbg_crit = \"background-position:50% 54%; background-image: url(http:\\\\//i.imgur.com/cFiEs5R.gif);\";","\t\t\tbText = bText + \" \" + SayParts + \"<b><i>●LUCKY SHOT●</i></b></div></div>\";","//PlaySound('Money', 5000);","\t\t\t//\t\t--FAIL roll","\t\t}","\t\tif (aRollraw <= failRange) {","\t\t\tMain = Main + MainOdd + \"<a style = 'color:PURPLE'><b>Fumble!: \" + aFum[Math.floor(Math.random() * aFum.length)] + \"</div>\";","\t\t\tbg_crit = \"background-position:50% 54%; background-image: url(\" + fail_img + \");\";","\t\t\tbText = bText + \" \" + 'FUMBLE';","\t\t\t//PlaySound('FuckThisShit', 50000);","\t\t\tfumble = 1;","\t\t}","\t\t/*-----------","AMMO PARTS","-----------*/","\t\tif (FindGun !== undefined && who !== \"NPC\" && ammo0 !== undefined) {","\t\t\tvar ammoleng = msgFormula[4].length - 1;","\t\t\tvar ammo = parseInt(msgFormula[4].substr(ammoleng));","\t\t\tvar ammoC = parseInt(ammo);","\t\t\tif (ammoC === undefined || isNaN(ammoC)) ammoC = 1;","\t\t\tvar cAmmo = parseInt(ammo0.get(\"current\"));","\t\t\tvar mAmmo = parseInt(ammo0.get(\"max\"));","\t\t\tif (isNaN(cAmmo) || isNaN(mAmmo)) {","\t\t\t\tsendChat('Error', \"/desc Set ammo for  \" + gun);","\t\t\t\treturn;","\t\t\t}","\t\t\tvar curPageID = findObjs({_type: \"campaign\"})[0].get(\"playerpageid\");","\t\t\tvar curPage = findObjs({_type: \"page\",_id: curPageID})[0];","\t\t\tvar charObj = findObjs({type: 'character',controlledby: msg.playerid})[0];","\t\t\tvar tokens = findObjs({_type: \"graphic\",layer: \"objects\",_pageid: curPageID,represents: charObj.id});","\t\t\t_.each(tokens, function(id) {","\t\t\t\tvar who = getObj('character', id.get(\"represents\"));","\t\t\t\tvar aSet = findObjs({_type: \"attribute\",name: leng + \"_WEAPpay\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\tif (aSet == undefined) {","\t\t\t\t\taSet = FindGun;","\t\t\t\t}","\t\t\t\taSet = aSet.id;","\t\t\t\tid.set(\"bar3_link\", aSet);","\t\t\t\tid.set('bar3_value', cAmmo);","\t\t\t\tid.set('bar3_max', mAmmo);","\t\t\t});","\t\t\tvar aPart = \"<div style='box-shadow: \" + bShadow + \"; font-family: \" + font + \"; font-size: 8pt; text-align: center; margin:0px; padding:0px 0px 0px 0px; border-left: 1px solid #000; border-right: 1px solid #000; border-top: 1px solid #000; border-radius: 0px; color: #000;\";","\t\t\tif (mAmmo == 0) {}","\t\t\telse if (cAmmo <= 0 || cAmmo < ammoC) {","\t\t\t\tcAmmo = \"0\";","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tMain = aPart + \"background-color:RED;'><b><i>Not Enough \" + gun + \" ammo left in clip.</div>\";","\t\t\t}","\t\t\telse if (cAmmo <= 3 || cAmmo < ammoC) {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar per = (cAmmo / mAmmo) * 100;","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 3px;\"><div style=\"background-color: red; width: ' + per + '%; height: 5px; border-radius: 10px;\"></div></div>';","\t\t\t\tMain = Main + aPart + \"background-color:RED;'><b><i>\" + cAmmo + \" \" + gun + \" ammo left in clip.</b></i>\" + ammoT + \"</div>\";","\t\t\t}","\t\t\telse {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar per = (cAmmo / mAmmo) * 100;","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 1px;\"><div style=\"background-color: orange; width: ' + per + '%; height: 3px; border-radius: 10px; margins: 0px;\"></div></div>';","\t\t\t\tMain = Main + aPart + \"background-color:#A8A191;'><b><i>\" + cAmmo + \" of \" + mAmmo + \" \" + gun + \" ammo left</b></i>\" + ammoT + \"</div>\";","\t\t\t}","\t\t}","","/*-----------SEND CHAT-----------*/","\t\tvar pad = \"6px;\";","\t\tif (bText != \"\") pad = \"2px;\";","\t\tvar top = \"<div style='\" + bg_crit + \" box-shadow: \" + bShadow + \"; text-shadow: -1px -1px #000, 1px -1px #000, -1px 1px #000, 2px 2px #000; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 0px 0px; margin-top: 0.2em; border: 1px solid #000; border-radius: 10px 10px 0px 0px; color: #FFFFFF; background-color:\" + boxcolor + \";'><b>\" + who + \"  Attacks</b></div>\";","\t\tEnd = \"<div style='\" + bg_crit + \" box-shadow: \" + bShadow + \"; text-shadow: -1px -1px #000, 1px -1px #000, -1px 1px #000, 2px 2px #000; font-family: \" + font + \"; font-size: 16px ;text-align: center; padding: \" + pad + \" vertical-align: middle; border: 1px solid #000; border-radius: 0px 0px 8px 8px; color: #FFFFFF; background-color:\" + boxcolor + \";'><b>\" + bText + \"</div>\";","\t\tvar SendT = top + Main + End;","\t\tif (aRollraw <= 3 && fumble != 1) {","\t\t\tSendT = \"<div style='opacity: 0.5;'><strong style='font-size: 70%;'>\" + SendT + \"</strong></div>\";","\t\t}","\t\tif (aRollraw >= 20) {","\t\t\tSendT = \"<strong style='font-size: 120%;'>\" + SendT + \"</strong>\";","\t\t}","\t\tsendChat(who, '/direct ' + SendT);","\t\treturn;","\t}","","//----------------------------","//RELOAD----------------","//----------------------------","\tif (command == \"!reload\") {","\t\tif (cWho !== undefined) {","\t\t\tvar msgFormula = msgTxt.split(\" --\");","\t\t\tvar gun = msgFormula[1];","\t\t\tvar FindGun = findObjs({","\t\t\t\tcurrent: gun,","\t\t\t\ttype: \"attribute\",","\t\t\t\t_characterid: cWho.id","\t\t\t}, {","\t\t\t\tcaseInsensitive: true","\t\t\t})[0];","\t\t\tif (FindGun == undefined) {","\t\t\t\tsendChat('', '/desc ' + msg.who + ': <b>ammo not found</b>');","\t\t\t\treturn","\t\t\t}","\t\t\tClips = 0;","\t\t\tvar attName = FindGun.get(\"name\");","\t\t\tvar Ammo0 = findObjs({","\t\t\t\tname: attName + \"pay\",","\t\t\t\ttype: \"attribute\",","\t\t\t\t_characterid: cWho.id","\t\t\t}, {","\t\t\t\tcaseInsensitive: true","\t\t\t})[0];","\t\t\tvar Ammo1 = findObjs({","\t\t\t\tname: attName + \"Rounds\",","\t\t\t\ttype: \"attribute\",","\t\t\t\t_characterid: cWho.id","\t\t\t}, {","\t\t\t\tcaseInsensitive: true","\t\t\t})[0];","\t\t\tvar Clipsc = findObjs({","\t\t\t\tname: attName + \"clip\",","\t\t\t\ttype: \"attribute\",","\t\t\t\t_characterid: cWho.id","\t\t\t}, {","\t\t\t\tcaseInsensitive: true","\t\t\t})[0];","\t\t\tif (Clipsc != undefined) {","\t\t\t\tvar Clips = parseInt(Clipsc.get(\"current\"));","\t\t\t}","\t\t\tvar cWep = parseInt(Ammo0.get(\"current\"));","\t\t\tvar mWep = parseInt(Ammo0.get(\"max\"));","\t\t\tvar cAmmo = parseInt(Ammo1.get(\"current\"));","\t\t\tif (cAmmo <= 0) {","\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' NO AMMO TO RELOAD!</div>';","\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t}","\t\t\telse {","\t\t\t\tvar needed = mWep - cWep;","\t\t\t\tif (needed >= cAmmo) {","\t\t\t\t\tneeded = cAmmo;","\t\t\t\t}","\t\t\t\tif (Clips == 10) {","\t\t\t\t\tneeded = 1;","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = cAmmo;","\t\t\t\t\tAmmo0.set('current', mWep);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' is reloading: ' + needed + \" clips on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + 'Clips)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t\telse {","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = Math.round((cAmmo / mWep) * 10) / 10;","\t\t\t\t\tAmmo0.set('current', cWep + needed);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>\" + msg.who + ' is reloading ' + needed + \" Ammo on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + ' reloads)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t}","\t\t}","\t}","});","//---AUTO LOCATION ROLLS","var aLoc = [\"Head\",\"Left Arm\",\"Right Arm\",\"Left Leg\",\"Right Leg\",\"..Dangly Bits! (Main Body)\",\"FREE ATTACK!\"];","//---FUMBLE ROLLS","var aFum =","\t[","\t \"Hit a totally different friendly target in general direction of aimed target (if possible)\",","\t \"Ungracefully fumbled the attack!, lose next attack\",","\t \"Got something in eye, lose this attack\",","\t \"Missed so badly, it makes the enemy question if you know what you are doing!\",","\t \"Total gun jam/broke weapon(or limb!).. useless this fight. Must get fixed.\",","\t \"Tripped!, next attack to get up\",","\t \"Miss and weapon jam! (GUN) jams, (MELEE) Missed and stuck in wall/floor/Tree/etc loose next attack\",","\t \"Missed, and draws sole aggression of the target\",","\t \"Somehow hit a Flying Squirrel!\",","     \"Failed so badly nearest ally falls back to help.\"","\t ];",""],"id":578},{"start":{"row":0,"column":0},"end":{"row":331,"column":0},"action":"insert","lines":["//!attack --[[1d20]] --[[3d6]] --saying! --ammotype","/*global PlaySound MakeRollNum on findObjs RollRight _ sendChat bShadow font getObj"," */","on('chat:message', function(msg) {","\tif (msg.type != \"api\") return;","\tvar msgTxt = msg.content;","\tvar command = msg.content.split(\" \", 1);","\tvar cWho = findObjs({_type: 'character',name: msg.who})[0];","\tif (cWho == undefined && msg.who.indexOf(\"(GM)\") == -1) {","\t\tcWho = RollRight(msg.playerid);","\t\tmsg.who = cWho.get(\"name\");","\t}","/*-----------START-----------*/","\tif (command == \"!attack\") {","\t\tPlaySound('dice', 9000);","\t\tvar who = msg.who;","\t\tmsg.content = MakeRollNum(msg.content, msg.inlinerolls);","//check rolls---------------------","\t\tvar ar = msg.inlinerolls[0];","\t\tvar dr = msg.inlinerolls[1];","//define var----------------------","\t\tif (ar === undefined || dr === undefined) {","\t\t\tsendChat('', \"/direct <B><I>bad macro!\");","\t\t\treturn;","\t\t}","\t\tmsgFormula = msgTxt.split(\" --\");","\t\tvar Saycolor = \"#964141\";","\t\tvar Lucky = 20;","\t\tvar failRange = 1;","\t\tvar dParts = \"\";","\t\tvar dRoll = \"\";","\t\tvar DD = \"\";","\t\tvar bText = \"\";","\t\tvar DDtext = \"\";","\t\tvar bg_crit = \"\";","\t\tvar fumble = 0;","\t\tvar boxcolor = getObj(\"player\", msg.playerid).get(\"color\");","\t\tvar crit_img = \"http:\\\\//media.giphy.com/media/3KqZp8MBaf1Ty/giphy.gif\";","\t\tvar fail_img = \"http:\\\\//fc06.deviantart.net/fs70/f/2013/076/5/2/_tutorial__creating_an_animated_light_pulse_in_ps_by_d_k0d3-d5ybir4.gif\";","\t\tif (msg.who == \"GM (GM)\") {","\t\t\tboxcolor = '#831F29';","\t\t\twho = \"NPC\";","\t\t}","/*-----------BOXES-----------*/","\t\tvar topimg = \"https://s3.amazonaws.com/files.staging.d20.io/images/181118/cN5ui3MXx87UBgVUgzwYTQ/med.jpg?141868063\";","\t\tvar tshadow2 = \"-1px -1px #444, 1px -1px #444, -1px 1px #444, 1px 1px #444\";","\t\tvar SayParts = \"<div style='text-shadow: 1px 1px #000, -1px -1px #000, -1px 1px #000, 1px -1px #000; margin: 0em 0em 0em 0em;; font-size:8pt; display:inline-block; text-align: center; vertical-align:middle; padding: 0px 6px 0px 6px; border: 1px solid #000; border-radius: 3px; color: #FFF; background-image: url(\" + topimg + \");'>\";","\t\tvar MainSay = \"<div style='box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family:\" + font + \"; font-size: x-small; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color:#CEC7B6; color: #000;'>\";","\t\tvar MainEven = \"<div style='box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #CEC7B6; color: #000;'>\";","\t\tvar MainOdd = \"<div style='box-shadow: \" + bShadow + \"; text-shadow: 1px 1px #878787; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 1px; border-left: 1px solid #000; border-right: 1px solid #000; border-radius: 0px; background-color: #C0B9A8; color: #000;'>\";","\t\tvar RollParts = \"<div style='margin: 0em 0.1em 0.1em 0em; font-size: 10pt; text-shadow: \" + tshadow2 + \"; width: 15px; height: 15px; line-height: 15px; display:inline-block; text-align:center; padding: 0px 1px 0px 0px; border: 1px solid #000; border-radius: 3px; color: #FFF;\";","\t\tPlaySound('dice', 9000);","/*-----------START2-----------*/","","//set motto","\t\tif (msgFormula[3] !== undefined) {","\t\t\tvar ammoleng = msgFormula[3].length - 1;","\t\t\tvar sayingCheck = parseInt(msgFormula[3].substr(ammoleng));","\t\t\tif (isNaN(sayingCheck)) {","\t\t\t\tCustom = msgFormula[3].toUpperCase();","\t\t\t}","\t\t\telse if (msgFormula[3] !== undefined && msgFormula[4] == undefined) {","\t\t\t\tCustom = msgFormula[3].toUpperCase();","\t\t\t\tvar gunleng = msgFormula[3].length - 2;","\t\t\t\tvar Custom = msgFormula[3].substr(0, gunleng).toUpperCase();","\t\t\t}","\t\t}","\t\telse {","\t\t\tCustom = \"ATTACK:\";","\t\t}","//Check for GUN","\t\tif (msgFormula[4] === undefined) msgFormula[4] = msgFormula[3];","\t\tif (msgFormula[4] !== undefined && who !== \"NPC\") {","\t\t\tvar ammoleng = msgFormula[4].length - 1;","\t\t\tvar ammo = parseInt(msgFormula[4].substr(ammoleng));","\t\t\tif (!isNaN(ammo)) {","\t\t\t\tvar gunleng = msgFormula[4].length - 2;","\t\t\t\tvar gun = msgFormula[4].substr(0, gunleng);","\t\t\t\tvar FindGun = findObjs({current: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\tif (FindGun == undefined) {","\t\t\t\t\tFindGun = findObjs({name: gun,type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\t}","\t\t\t\tif (FindGun == undefined) {","\t\t\t\t\tsendChat('Error', \"/desc \" + msg.who + \" You do not own a  \" + gun);","\t\t\t\t\treturn;","\t\t\t\t}","\t\t\t\tvar attName = FindGun.get(\"name\");","\t\t\t\tvar leng = attName.length - 5;","\t\t\t\tvar res = attName.substr(leng, 5);","\t\t\t\tleng = attName.substr(0, leng);","\t\t\t\tvar ammo0 = findObjs({name: leng + \"_WEAPpay\",type: \"attribute\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\tif (ammo0 == undefined) {","\t\t\t\t\tammo0 = FindGun","\t\t\t\t}","\t\t\t}","\t\t}","/*-----------ATTACK PARTS-----------*/","//--Attack Modifier","\t\tvar mod;","\t\tif (ar.results.rolls[1] === undefined) mod = \"\";","\t\telse mod = (ar.results.rolls[1].expr);","\t\tvar aRollraw = ar.results.rolls[0].results[0]['v'];","\t\t//Attack total and type","\t\tvar Atotal = (ar.results.total);","\t\tvar Atype = \"<a style='color:RED'>\" + ar.expression + \"</a>\";","","//DAMAGE PARTS-----------------","//--Damage modifier","\t\tvar dMod;","\t\tif (dr.results.rolls[1] === undefined) dMod = \"\";","\t\telse dMod = (dr.results.rolls[1].expr);","//--Set damage total","\t\tvar Dtotal = dr.results.total;","//--Make damage text for all rolls","\t\tvar dam = dr.results.rolls[0];","\t\tvar damsort = dam.results;","\t\tvar i = 0;","\t\t//damsort.sort(function(a, b){return a.v < b.v;});","\t\twhile (dam.results[i] !== undefined) {","\t\t\tvar dNum = dam.results[i]['v'];","\t\t\tvar ddimg = \"http://image.blingee.com.s3.amazonaws.com/images19/content/output/000/000/000/061/788808721_1076628.gif?4\";","\t\t\tvar bg_max = \"background-position:center; background-image: url(\" + ddimg + \");\";","\t\t\tif (dNum == 1) num = RollParts + \"background-color:#A80000;'>\" + dNum + \"</div></b></a>\";","\t\t\telse if (dNum == dr.results.rolls[0].sides) num = RollParts + \"background-color:#00A120;\" + bg_max + \"'><b>\" + dNum + \"</b></div></b></a>\";","\t\t\telse num = RollParts + \"background-color:#696969;'>\" + dNum + \"</div>\";","\t\t\tdRoll = dRoll + \"\" + (num);","\t\t\ti++;","\t\t}","\t\tvar Dtype = \"<a style='color:RED;'>\" + dr.expression + \"</a>\";","\t\tdRoll = dRoll + \"<b>\" + dMod + \"</b>\";","//--Set Double Damage","\t\tif (aRollraw >= 20) {","\t\t\tDtotal = \"<a style='color:RED'><strong style='font-size: 110%;'>\" + Dtotal * 2 + \"!</strong></a>\";","\t\t\tAtotal = \"<a style='color:RED'><strong style='font-size: 110%;'>\" + Atotal + \"!</strong></a>\";","\t\t\tbText = bText + \" \" + '<b>DOUBLE DAMAGE!</b><BR><b>(NATURAL 20!)</b>';","\t\t\tbg_crit = \"background-position:center; background-image: url(\" + crit_img + \");\";","\t\t\tPlaySound('Critical', 9000);","\t\t}","//--Set Miss","\t\tif (aRollraw <= 3) {","\t\t\tnum = RollParts + \"background-color:#A80000;'>\" + aRollraw + \"</div>\";","\t\t\tDtotal = \"<a style='color:#000'>\" + Dtotal + \"!</a>\";","\t\t\tAtotal = \"<a style='color:#000'>\" + Atotal + \"!</a>\";","\t\t\tbText = bText + \" \" + 'MISS';","\t\t\tboxcolor = \"#bbb\";","\t\t\tSaycolor = \"#555\";","\t\t}","\t\telse num = RollParts + \"background-color:#696969;'>\" + aRollraw + \"</div>\";","\t\taRoll = num;","//CHATBOX PARTS----------------","\t\tMain = MainSay + SayParts + \"<b><i>●\" + Custom + \"●</i></b></div></div>\";","\t\tMain = Main + MainOdd + Atype + \" <b>To Hit: </b>\" + aRoll + \"<b>\" + mod + \" = <a style='color:BLUE'>\" + Atotal + \"</b></a></div>\";","\t\tMain = Main + MainEven + Dtype + \"<b> Damage:<br></b>\" + dRoll + \"<b> = <a style='color:BLUE'>\" + Dtotal + \"</b></a></div>\";","//CRIT_FUMBLE PARTS----------------","//--CRIT roll","\t\taRollraw1 = randomInteger(Lucky);","\t\tif (aRollraw1 >= Lucky && aRollraw > 4) {","\t\t\tMain = Main + MainOdd + \"<a style = 'color:PURPLE'><b>Lucky Shot!: \" + aLoc[Math.floor(Math.random() * aLoc.length)] + \"</b></div>\";","\t\t\tbg_crit = \"background-position:50% 54%; background-image: url(http:\\\\//i.imgur.com/cFiEs5R.gif);\";","\t\t\tbText = bText + \" \" + SayParts + \"<b><i>●LUCKY SHOT●</i></b></div></div>\";","//PlaySound('Money', 5000);","\t\t\t//\t\t--FAIL roll","\t\t}","\t\tif (aRollraw <= failRange) {","\t\t\tMain = Main + MainOdd + \"<a style = 'color:PURPLE'><b>Fumble!: \" + aFum[Math.floor(Math.random() * aFum.length)] + \"</div>\";","\t\t\tbg_crit = \"background-position:50% 54%; background-image: url(\" + fail_img + \");\";","\t\t\tbText = bText + \" \" + 'FUMBLE';","\t\t\t//PlaySound('FuckThisShit', 50000);","\t\t\tfumble = 1;","\t\t}","\t\t/*-----------","AMMO PARTS","-----------*/","\t\tif (FindGun !== undefined && who !== \"NPC\" && ammo0 !== undefined) {","\t\t\tvar ammoleng = msgFormula[4].length - 1;","\t\t\tvar ammo = parseInt(msgFormula[4].substr(ammoleng));","\t\t\tvar ammoC = parseInt(ammo);","\t\t\tif (ammoC === undefined || isNaN(ammoC)) ammoC = 1;","\t\t\tvar cAmmo = parseInt(ammo0.get(\"current\"));","\t\t\tvar mAmmo = parseInt(ammo0.get(\"max\"));","\t\t\tif (isNaN(cAmmo) || isNaN(mAmmo)) {","\t\t\t\tsendChat('Error', \"/desc Set ammo for  \" + gun);","\t\t\t\treturn;","\t\t\t}","\t\t\tvar curPageID = findObjs({_type: \"campaign\"})[0].get(\"playerpageid\");","\t\t\tvar curPage = findObjs({_type: \"page\",_id: curPageID})[0];","\t\t\tvar charObj = findObjs({type: 'character',controlledby: msg.playerid})[0];","\t\t\tvar tokens = findObjs({_type: \"graphic\",layer: \"objects\",_pageid: curPageID,represents: charObj.id});","\t\t\t_.each(tokens, function(id) {","\t\t\t\tvar who = getObj('character', id.get(\"represents\"));","\t\t\t\tvar aSet = findObjs({_type: \"attribute\",name: leng + \"_WEAPpay\",_characterid: cWho.id}, {caseInsensitive: true})[0];","\t\t\t\tif (aSet == undefined) {","\t\t\t\t\taSet = FindGun;","\t\t\t\t}","\t\t\t\taSet = aSet.id;","\t\t\t\tid.set(\"bar3_link\", aSet);","\t\t\t\tid.set('bar3_value', cAmmo);","\t\t\t\tid.set('bar3_max', mAmmo);","\t\t\t});","\t\t\tvar aPart = \"<div style='box-shadow: \" + bShadow + \"; font-family: \" + font + \"; font-size: 8pt; text-align: center; margin:0px; padding:0px 0px 0px 0px; border-left: 1px solid #000; border-right: 1px solid #000; border-top: 1px solid #000; border-radius: 0px; color: #000;\";","\t\t\tif (mAmmo == 0) {}","\t\t\telse if (cAmmo <= 0 || cAmmo < ammoC) {","\t\t\t\tcAmmo = \"0\";","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tMain = aPart + \"background-color:RED;'><b><i>Not Enough \" + gun + \" ammo left in clip.</div>\";","\t\t\t}","\t\t\telse if (cAmmo <= 3 || cAmmo < ammoC) {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar per = (cAmmo / mAmmo) * 100;","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 3px;\"><div style=\"background-color: red; width: ' + per + '%; height: 5px; border-radius: 10px;\"></div></div>';","\t\t\t\tMain = Main + aPart + \"background-color:RED;'><b><i>\" + cAmmo + \" \" + gun + \" ammo left in clip.</b></i>\" + ammoT + \"</div>\";","\t\t\t}","\t\t\telse {","\t\t\t\tcAmmo = cAmmo - ammoC;","\t\t\t\tammo0.set('current', cAmmo);","\t\t\t\tvar per = (cAmmo / mAmmo) * 100;","\t\t\t\tvar ammoT = '<div style=\"border: 2px solid #333; background-color: #0D0D0D; border-radius: 13px; padding: 1px;\"><div style=\"background-color: orange; width: ' + per + '%; height: 3px; border-radius: 10px; margins: 0px;\"></div></div>';","\t\t\t\tMain = Main + aPart + \"background-color:#A8A191;'><b><i>\" + cAmmo + \" of \" + mAmmo + \" \" + gun + \" ammo left</b></i>\" + ammoT + \"</div>\";","\t\t\t}","\t\t}","","/*-----------SEND CHAT-----------*/","\t\tvar pad = \"6px;\";","\t\tif (bText != \"\") pad = \"2px;\";","\t\tvar top = \"<div style='\" + bg_crit + \" box-shadow: \" + bShadow + \"; text-shadow: -1px -1px #000, 1px -1px #000, -1px 1px #000, 2px 2px #000; font-family: \" + font + \"; text-align: center; vertical-align: middle; padding: 0px 0px; margin-top: 0.2em; border: 1px solid #000; border-radius: 10px 10px 0px 0px; color: #FFFFFF; background-color:\" + boxcolor + \";'><b>\" + who + \"  Attacks</b></div>\";","\t\tEnd = \"<div style='\" + bg_crit + \" box-shadow: \" + bShadow + \"; text-shadow: -1px -1px #000, 1px -1px #000, -1px 1px #000, 2px 2px #000; font-family: \" + font + \"; font-size: 16px ;text-align: center; padding: \" + pad + \" vertical-align: middle; border: 1px solid #000; border-radius: 0px 0px 8px 8px; color: #FFFFFF; background-color:\" + boxcolor + \";'><b>\" + bText + \"</div>\";","\t\tvar SendT = top + Main + End;","\t\tif (aRollraw <= 3 && fumble != 1) {","\t\t\tSendT = \"<div style='opacity: 0.5;'><strong style='font-size: 70%;'>\" + SendT + \"</strong></div>\";","\t\t}","\t\tif (aRollraw >= 20) {","\t\t\tSendT = \"<strong style='font-size: 120%;'>\" + SendT + \"</strong>\";","\t\t}","\t\tsendChat(who, '/direct ' + SendT);","\t\treturn;","\t}","","//----------------------------","//RELOAD----------------","//----------------------------","\tif (command == \"!reload\") {","\t\tif (cWho !== undefined) {","\t\t\tvar msgFormula = msgTxt.split(\" --\");","\t\t\tvar gun = msgFormula[1];","\t\t\tvar FindGun = findObjs({","\t\t\t\tcurrent: gun,","\t\t\t\ttype: \"attribute\",","\t\t\t\t_characterid: cWho.id","\t\t\t}, {","\t\t\t\tcaseInsensitive: true","\t\t\t})[0];","\t\t\tif (FindGun == undefined) {","\t\t\t\tsendChat('', '/desc ' + msg.who + ': <b>ammo not found</b>');","\t\t\t\treturn","\t\t\t}","\t\t\tClips = 0;","\t\t\tvar attName = FindGun.get(\"name\");","\t\t\tvar Ammo0 = findObjs({","\t\t\t\tname: attName + \"pay\",","\t\t\t\ttype: \"attribute\",","\t\t\t\t_characterid: cWho.id","\t\t\t}, {","\t\t\t\tcaseInsensitive: true","\t\t\t})[0];","\t\t\tvar Ammo1 = findObjs({","\t\t\t\tname: attName + \"Rounds\",","\t\t\t\ttype: \"attribute\",","\t\t\t\t_characterid: cWho.id","\t\t\t}, {","\t\t\t\tcaseInsensitive: true","\t\t\t})[0];","\t\t\tvar Clipsc = findObjs({","\t\t\t\tname: attName + \"clip\",","\t\t\t\ttype: \"attribute\",","\t\t\t\t_characterid: cWho.id","\t\t\t}, {","\t\t\t\tcaseInsensitive: true","\t\t\t})[0];","\t\t\tif (Clipsc != undefined) {","\t\t\t\tvar Clips = parseInt(Clipsc.get(\"current\"));","\t\t\t}","\t\t\tvar cWep = parseInt(Ammo0.get(\"current\"));","\t\t\tvar mWep = parseInt(Ammo0.get(\"max\"));","\t\t\tvar cAmmo = parseInt(Ammo1.get(\"current\"));","\t\t\tif (cAmmo <= 0) {","\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' NO AMMO TO RELOAD!</div>';","\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t}","\t\t\telse {","\t\t\t\tvar needed = mWep - cWep;","\t\t\t\tif (needed >= cAmmo) {","\t\t\t\t\tneeded = cAmmo;","\t\t\t\t}","\t\t\t\tif (Clips == 10) {","\t\t\t\t\tneeded = 1;","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = cAmmo;","\t\t\t\t\tAmmo0.set('current', mWep);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>● \" + msg.who + ' is reloading: ' + needed + \" clips on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + 'Clips)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t\telse {","\t\t\t\t\tcAmmo = cAmmo - needed;","\t\t\t\t\tvar reloads = Math.round((cAmmo / mWep) * 10) / 10;","\t\t\t\t\tAmmo0.set('current', cWep + needed);","\t\t\t\t\tAmmo1.set('current', cAmmo);","\t\t\t\t\tvar help = OuterDiv + iPart + \"background-color:#A80000;'><b>\" + msg.who + ' is reloading ' + needed + \" Ammo on:<br>● \" + msgFormula[1] + ' ●<br>' + cAmmo + ' left(' + reloads + ' reloads)</div>';","\t\t\t\t\tsendChat('', '/direct ' + help);","\t\t\t\t}","\t\t\t}","\t\t}","\t}","});","//---AUTO LOCATION ROLLS","var aLoc = [\"Head\",\"Left Arm\",\"Right Arm\",\"Left Leg\",\"Right Leg\",\"..Dangly Bits! (Main Body)\",\"FREE ATTACK!\"];","//---FUMBLE ROLLS","var aFum =","\t[","\t \"Hit a totally different friendly target in general direction of aimed target (if possible)\",","\t \"Ungracefully fumbled the attack!, lose next attack\",","\t \"Got something in eye, lose this attack\",","\t \"Missed so badly, it makes the enemy question if you know what you are doing!\",","\t \"Total gun jam/broke weapon(or limb!).. useless this fight. Must get fixed.\",","\t \"Tripped!, next attack to get up\",","\t \"Miss and weapon jam! (GUN) jams, (MELEE) Missed and stuck in wall/floor/Tree/etc loose next attack\",","\t \"Missed, and draws sole aggression of the target\",","\t \"Somehow hit a Flying Squirrel!\",","     \"Failed so badly nearest ally falls back to help.\"","\t ];",""]}]]},"ace":{"folds":[],"scrolltop":3828,"scrollleft":0,"selection":{"start":{"row":331,"column":0},"end":{"row":331,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":272,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1487882174022,"hash":"1b7d8b88a4d45cdf985d2ca67ee0ea8204f9691a"}