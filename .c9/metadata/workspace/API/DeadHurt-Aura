{"filter":false,"title":"DeadHurt-Aura","tooltip":"/API/DeadHurt-Aura","undoManager":{"mark":1,"position":1,"stack":[[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":259,"column":2},"action":"remove","lines":["/*global log on obj _ state getObj sendChat CONFIG fPart findObjs OuterDiv Campaign randomFromTo createObj fixNO toFront randomInteger*/","on(\"ready\", function() {","    sendChat('API', \"/w GM API STARTED\");","    if(!state.bloodlist) state.bloodlist = [];","    log(state.bloodlist);","});","//CODE-----------------","on(\"change:token\", function(o) {","    var obj = getObj(o.get('type'), o.id);","    //log(obj);","    //SET ENEMY AURA----------","    var eBar1 = parseInt(obj.get(\"bar1_value\"), 10);","    var eBar2 = parseInt(obj.get(\"bar2_value\"), 10);","    if(obj.get('represents') === \"\" && !isNaN(eBar1) && !isNaN(eBar2)) {","        obj.set({","            'aura1_radius': -1.4,","            'aura2_radius': -1.4,","            'aura1_color': '#980000',","            'aura2_color': '#980000',","            'showplayers_aura1': true,","            'showplayers_aura2': true,","            'showplayers_name': false,","            'showname': false","        });","    }","    //SET PLAYER AURA------------","    if(obj.get(\"represents\") !== \"\") {","        var oCharacter = getObj('character', obj.get(\"_represents\"));","        var type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","        if(type == 'Player') {","            var cBy = oCharacter.get('controlledby');","            var cName = oCharacter.get('name').split(\" \");","            cName = cName[0];","            if(cBy.split(',').length == 1 && cBy != 'all') {","                var player = getObj('player', cBy);","                var pColor = player.get('color');","                obj.set({","                    'aura1_radius': -1.1,","                    'aura2_radius': -1.1,","                    'aura1_color': pColor,","                    'aura2_color': pColor,","                    'showplayers_aura1': true,","                    'showplayers_aura2': true,","                    'showplayers_name': false,","                    'showname': false","                });","            }","        }","    }","    //SET HURT ICONS-----------","    CONFIG.forEach(function(opts) {","        if(obj.get(\"bar\" + opts.barId + \"_max\") !== \"\" && obj.get(\"bar\" + opts.barId + \"_value\") !== \"\") {","            var maxValue = parseInt(obj.get(\"bar\" + opts.barId + \"_max\"));","            var curValue = parseInt(obj.get(\"bar\" + opts.barId + \"_value\"));","            if(!isNaN(maxValue) && !isNaN(curValue) && obj.get(\"controlledby\") != '-J54-6mE5Q1BnpKxGOrZ') {","                var markerName = \"status_\" + opts.status;","                if(curValue <= (maxValue * opts.barRatioMax) && curValue > (maxValue * opts.barRatioMin)) {","                    obj.set(markerName, opts.whenLow);","                } else {","                    obj.set(markerName, !opts.whenLow);","                }","            }","        }","    });","});","/*-----------","ARMOR WARNINGS","-----------*/","on('change:attribute', function(obj) {","    var name = obj.get(\"name\").toUpperCase();","    if(name !== \"A-BODY\" && name !== \"PA-BODY\" && name !== \"HP\") return;","    var ID = obj.get(\"_characterid\");","    var ch = getObj('character', ID);","    var char = ch.get(\"name\");","    var cur = obj.get(\"current\");","    var max = obj.get(\"max\");","    var per = (cur / max) * 100;","    var numb1 = Math.round(per);","    var numb = \"\";","    var t = \"\";","    var perLeft = numb1 + \"% left [\" + cur + \" of \" + max + \"]\";","    if(name == \"A-BODY\" || name == \"PA-BODY\") {","        var gif = \"http://www.powerflare.com/graphics/products/PF200_pattern4.gif\";","        if(cur <= 0) {","            numb = \"<b>\" + char + \" HAS NO ARMOR! <br>\" + perLeft;","            t = fPart + \"background-position:center; background-image: url(\" + gif + \");'>\" + numb + \"</div>\";","            sendChat('Armor Warning', \"/direct \" + t);","            return;","        }","        if(cur < max / 4) {","            numb = \"<b>\" + char + \" is below 1/4 armor! <br>\" + perLeft;","            t = fPart + \"background-color:#A14242;'>\" + numb + \"</div>\";","            sendChat('Armor Warning', \"/direct \" + t);","            return;","        }","        if(cur < max / 2) {","            numb = \"<b>\" + char + \" is below 1/2 armor! <br>\" + perLeft;","            t = fPart + \"background-color:#262A33;'>\" + numb + \"</div>\";","            sendChat('Armor Warning', \"/direct \" + t);","            return;","        }","    }","    /*-----------","    Health WARNINGS","    -----------*/","    if(name == \"HP\") {","        if(cur < max / 4) {","            numb = \"<b>\" + char + \" is close to dying!<br>\" + perLeft;","            t = OuterDiv + fPart + \"background-color:#A14242;'>\" + numb + \"</div>\";","            sendChat('Health Warning', \"/direct \" + t);","            return;","        }","        if(cur < max / 2) {","            numb = \"<b>\" + char + \" is hurt!<br>\" + perLeft;","            t = OuterDiv + fPart + \"background-color:#262A33;'>\" + numb + \"</div>\";","            sendChat('Health Warning', \"/direct \" + t);","            return;","        }","    }","});","//DEAD CHAT","on('change:graphic:bar1_value', function(obj, prev) {","    if(Campaign().get(\"playerpageid\") != obj.get(\"_pageid\")) return;","    var name = obj.get(\"name\");","    if(name === \"\") name = \"NPC\";","    var bar1 = parseInt(obj.get(\"bar1_value\"));","    var bar1m = parseInt(obj.get(\"bar1_max\"));","    var bar1p = prev.bar1_value;","    var amount = 1;","    var numb = \"\";","    var t = \"\";","    if(obj.get(\"_represents\") === \"\") {","        if(bar1 === 0) {","            var ax = randomFromTo(50, 80);","            var ay = randomFromTo(50, 80);","            var bgp = \"background-position:\" + ax + \"% \" + ay + \"%;\";","            var img = \"https:\\\\//threeriversdeep.files.wordpress.com/2014/08/three-rivers-deep_blood.gif\";","            var saying = \"<b>\" + name + \" is DEAD!<br>\";","            t = OuterDiv + fPart + \"background-image: url(\" + img + \");\" + bgp + \"'>\" + saying + \"</div>\";","            sendChat('SYSTEM', \"/direct \" + t);","        } else if(bar1 <= bar1m / 4) {","            numb = name + \" is badly beaten and below 1/4 health!<br>\";","            t = OuterDiv + fPart + \"background-color:#262A33;'>\" + numb + \"</div>\";","            sendChat('Health Warning', \"/direct \" + t);","        } else if(bar1 <= bar1m / 2) {","            numb = name + \" is below 1/2 health!<br>\";","            t = OuterDiv + fPart + \"background-color:#262A33;'>\" + numb + \"</div>\";","            sendChat('Health Warning', \"/direct \" + t);","        }","    }","    if(bar1 < bar1p && bar1p !== \"\") {","        var amountHitfor = 1 - (bar1 / bar1p).toFixed(2);","        var amountLost = 1 - (bar1 / bar1m).toFixed(2);","        var amounthit2 = 1 + ((bar1p - bar1) / bar1m);","        var scale = (amountLost * (1 + amounthit2)).toFixed(2);","        if(bar1 <= 0) amount = 3;","        //var size= obj.get(\"height\") + (obj.get(\"height\") * amountLost) * (1 + amounthit2);","        var size = obj.get(\"height\") + (obj.get(\"height\") * scale);","        var size = Math.round(size);","        //sendChat('Health Warning', \"/direct <br>Hit for:\"+amountHitfor+ \"<br>Lost:\" +amountLost+ \"<br>\" +amounthit2+ \"<br>Scale:\"+scale);","        var color = \"#ff0000\";","        blood(obj, size, color);","    }","    if(bar1 > bar1p && bar1p !== \"\") {","        size = obj.get(\"height\") / 2;","        color = \"#00ff00\";","        HealIcon(obj, size, color);","    }","});","","function HealIcon(current_token, size, color) {","    if(current_token.get(\"layer\") != \"gmlayer\") {","        var tokenURL = \"https://s3.amazonaws.com/files.staging.d20.io/images/180724/qeNVGU6kgFv4K5hK2NeWWw/thumb.png?1418008052\";","        var healMark = createObj('graphic', {","            name: \"Heal\",","            pageid: Campaign().get(\"playerpageid\"),","            layer: 'objects',","            imgsrc: tokenURL,","            left: current_token.get(\"left\"),","            top: current_token.get(\"top\"),","            height: size,","            width: size","        });","        fixNO(healMark);","        current_token.set({","            'tint_color': color","        });","        setTimeout(function() {","            toFront(healMark);","        }, 5);","        removetoken(healMark, 1000);","        setTimeout(function() {","            current_token.set({","                'tint_color': \"transparent\"","            });","        }, 2000);","    }","};","","function blood(current_token, size, color) {","    if(current_token.get(\"layer\") != \"gmlayer\") {","        var urls = [];","        var rot = randomInteger(359);","        current_token.set({","            'tint_color': color","        });","        var BloodTokenTable = findObjs({","            _type: \"rollabletable\",","            name: \"bloodtable\"","        });","        BloodTokenTable = BloodTokenTable[0];","        var currentPageGraphics = findObjs({","            _type: \"tableitem\",","            _rollabletableid: BloodTokenTable.get(\"_id\")","        });","        _.each(currentPageGraphics, function(obj) {","            urls.push(obj.get(\"avatar\"));","        });","        var ret = urls[randomInteger(urls.length) - 1];","        var tokenURL = ret.replace(\"max.png\", \"thumb.png\").replace(\"med.png\", \"thumb.png\");","        var bloodmarker = createObj('graphic', {","            name: \"Damage\",","            pageid: current_token.get(\"_pageid\"),","            layer: 'map',","            imgsrc: tokenURL,","            left: current_token.get(\"left\"),","            top: current_token.get(\"top\"),","            height: size,","            width: size,","            rotation: rot","        });","        fixNO(bloodmarker);","        var BloodArrayPart = {","            id: bloodmarker.get(\"_id\")","        };","        state.bloodlist.push(BloodArrayPart);","        if(state.bloodlist.length >= 10) {","            var token = findObjs({","                _id: state.bloodlist[0].id,","                _type: \"graphic\"","            })[0];","            if(token !== undefined) token.remove();","            state.bloodlist.shift();","        }","        setTimeout(function() {","            current_token.set({","                'tint_color': \"transparent\"","            });","        }, 2000);","        setTimeout(function() {","            toFront(bloodmarker);","        }, 1);","    }","};","","function removetoken(token, time) {","    setTimeout(function() {","        token.remove();","    }, time);","};"]},{"start":{"row":0,"column":0},"end":{"row":258,"column":2},"action":"insert","lines":["/*global log on obj _ state getObj sendChat CONFIG fPart findObjs OuterDiv Campaign randomFromTo createObj fixNO toFront randomInteger*/","on(\"ready\", function() {","    sendChat('API', \"/w GM API STARTED\");","    if(!state.bloodlist) state.bloodlist = [];","    log(state.bloodlist);","});","//CODE-----------------","on(\"change:token\", function(o) {","    var obj = getObj(o.get('type'), o.id);","    //log(obj);","    //SET ENEMY AURA----------","    var eBar1 = parseInt(obj.get(\"bar1_value\"), 10);","    var eBar2 = parseInt(obj.get(\"bar2_value\"), 10);","    if(obj.get('represents') === \"\" && !isNaN(eBar1) && !isNaN(eBar2)) {","        obj.set({","            'aura1_radius': -1.4,","            'aura2_radius': -1.4,","            'aura1_color': '#980000',","            'aura2_color': '#980000',","            'showplayers_aura1': true,","            'showplayers_aura2': true,","            'showplayers_name': false,","            'showname': false","        });","    }","    //SET PLAYER AURA------------","    if(obj.get(\"represents\") !== \"\") {","        var oCharacter = getObj('character', obj.get(\"_represents\"));","        var type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","        if(type == 'Player') {","            var cBy = oCharacter.get('controlledby');","            var cName = oCharacter.get('name').split(\" \");","            cName = cName[0];","            if(cBy.split(',').length == 1 && cBy != 'all') {","                var player = getObj('player', cBy);","                var pColor = player.get('color');","                obj.set({","                    'aura1_radius': -1.1,","                    'aura2_radius': -1.1,","                    'aura1_color': pColor,","                    'aura2_color': pColor,","                    'showplayers_aura1': true,","                    'showplayers_aura2': true,","                    'showplayers_name': false,","                    'showname': false","                });","            }","        }","    }","    //SET HURT ICONS-----------","    CONFIG.forEach(function(opts) {","        if(obj.get(\"bar\" + opts.barId + \"_max\") !== \"\" && obj.get(\"bar\" + opts.barId + \"_value\") !== \"\") {","            var maxValue = parseInt(obj.get(\"bar\" + opts.barId + \"_max\"));","            var curValue = parseInt(obj.get(\"bar\" + opts.barId + \"_value\"));","            if(!isNaN(maxValue) && !isNaN(curValue) && obj.get(\"controlledby\") != '-J54-6mE5Q1BnpKxGOrZ') {","                var markerName = \"status_\" + opts.status;","                if(curValue <= (maxValue * opts.barRatioMax) && curValue > (maxValue * opts.barRatioMin)) {","                    obj.set(markerName, opts.whenLow);","                } else {","                    obj.set(markerName, !opts.whenLow);","                }","            }","        }","    });","});","/*-----------","ARMOR WARNINGS","-----------*/","on('change:attribute', function(obj) {","    var name = obj.get(\"name\").toUpperCase();","    if(name !== \"A-BODY\" && name !== \"PA-BODY\" && name !== \"HP\") return;","    var ID = obj.get(\"_characterid\");","    var ch = getObj('character', ID);","    var char = ch.get(\"name\");","    var cur = obj.get(\"current\");","    var max = obj.get(\"max\");","    var per = (cur / max) * 100;","    var numb1 = Math.round(per);","    var numb = \"\";","    var t = \"\";","    var perLeft = numb1 + \"% left [\" + cur + \" of \" + max + \"]\";","    if(name == \"A-BODY\" || name == \"PA-BODY\") {","        var gif = \"http://www.powerflare.com/graphics/products/PF200_pattern4.gif\";","        if(cur <= 0) {","            numb = \"<b>\" + char + \" HAS NO ARMOR! <br>\" + perLeft;","            t = fPart + \"background-position:center; background-image: url(\" + gif + \");'>\" + numb + \"</div>\";","            sendChat('Armor Warning', \"/direct \" + t);","            return;","        }","        if(cur < max / 4) {","            numb = \"<b>\" + char + \" is below 1/4 armor! <br>\" + perLeft;","            t = fPart + \"background-color:#A14242;'>\" + numb + \"</div>\";","            sendChat('Armor Warning', \"/direct \" + t);","            return;","        }","        if(cur < max / 2) {","            numb = \"<b>\" + char + \" is below 1/2 armor! <br>\" + perLeft;","            t = fPart + \"background-color:#262A33;'>\" + numb + \"</div>\";","            sendChat('Armor Warning', \"/direct \" + t);","            return;","        }","    }","    /*-----------","    Health WARNINGS","    -----------*/","    if(name == \"HP\") {","        if(cur < max / 4) {","            numb = \"<b>\" + char + \" is close to dying!<br>\" + perLeft;","            t = OuterDiv + fPart + \"background-color:#A14242;'>\" + numb + \"</div>\";","            sendChat('Health Warning', \"/direct \" + t);","            return;","        }","        if(cur < max / 2) {","            numb = \"<b>\" + char + \" is hurt!<br>\" + perLeft;","            t = OuterDiv + fPart + \"background-color:#262A33;'>\" + numb + \"</div>\";","            sendChat('Health Warning', \"/direct \" + t);","            return;","        }","    }","});","//DEAD CHAT","on('change:graphic:bar1_value', function(obj, prev) {","    if(Campaign().get(\"playerpageid\") != obj.get(\"_pageid\")) return;","    var name = obj.get(\"name\");","    if(name === \"\") name = \"NPC\";","    var bar1 = parseInt(obj.get(\"bar1_value\"));","    var bar1m = parseInt(obj.get(\"bar1_max\"));","    var bar1p = prev.bar1_value;","    var amount = 1;","    var numb = \"\";","    var t = \"\";","    if(obj.get(\"_represents\") === \"\") {","        if(bar1 === 0) {","            var ax = randomFromTo(50, 80);","            var ay = randomFromTo(50, 80);","            var bgp = \"background-position:\" + ax + \"% \" + ay + \"%;\";","            var img = \"https:\\\\//threeriversdeep.files.wordpress.com/2014/08/three-rivers-deep_blood.gif\";","            var saying = \"<b>\" + name + \" is DEAD!<br>\";","            t = OuterDiv + fPart + \"background-image: url(\" + img + \");\" + bgp + \"'>\" + saying + \"</div>\";","            sendChat('SYSTEM', \"/direct \" + t);","        } else if(bar1 <= bar1m / 4) {","            numb = name + \" is badly beaten and below 1/4 health!<br>\";","            t = OuterDiv + fPart + \"background-color:#262A33;'>\" + numb + \"</div>\";","            sendChat('Health Warning', \"/direct \" + t);","        } else if(bar1 <= bar1m / 2) {","            numb = name + \" is below 1/2 health!<br>\";","            t = OuterDiv + fPart + \"background-color:#262A33;'>\" + numb + \"</div>\";","            sendChat('Health Warning', \"/direct \" + t);","        }","    }","    if(bar1 < bar1p && bar1p !== \"\") {","        var amountHitfor = 1 - (bar1 / bar1p).toFixed(2);","        var amountLost = 1 - (bar1 / bar1m).toFixed(2);","        var amounthit2 = 1 + ((bar1p - bar1) / bar1m);","        var scale = (amountLost * (1 + amounthit2)).toFixed(2);","        if(bar1 <= 0) amount = 3;","        var size = obj.get(\"height\") + (obj.get(\"height\") * scale);","        var size = Math.round(size);","        //sendChat('Health Warning', \"/direct <br>Hit for:\"+amountHitfor+ \"<br>Lost:\" +amountLost+ \"<br>\" +amounthit2+ \"<br>Scale:\"+scale);","        var color = \"#ff0000\";","        blood(obj, size, color);","    }","    if(bar1 > bar1p && bar1p !== \"\") {","        size = obj.get(\"height\") / 2;","        color = \"#00ff00\";","        HealIcon(obj, size, color);","    }","});","","function HealIcon(current_token, size, color) {","    if(current_token.get(\"layer\") != \"gmlayer\") {","        var tokenURL = \"https://s3.amazonaws.com/files.staging.d20.io/images/180724/qeNVGU6kgFv4K5hK2NeWWw/thumb.png?1418008052\";","        var healMark = createObj('graphic', {","            name: \"Heal\",","            pageid: Campaign().get(\"playerpageid\"),","            layer: 'objects',","            imgsrc: tokenURL,","            left: current_token.get(\"left\"),","            top: current_token.get(\"top\"),","            height: size,","            width: size","        });","        fixNO(healMark);","        current_token.set({","            'tint_color': color","        });","        setTimeout(function() {","            toFront(healMark);","        }, 5);","        removetoken(healMark, 1000);","        setTimeout(function() {","            current_token.set({","                'tint_color': \"transparent\"","            });","        }, 2000);","    }","};","","function blood(current_token, size, color) {","    if(current_token.get(\"layer\") != \"gmlayer\") {","        var urls = [];","        var rot = randomInteger(359);","        current_token.set({","            'tint_color': color","        });","        var BloodTokenTable = findObjs({","            _type: \"rollabletable\",","            name: \"bloodtable\"","        });","        BloodTokenTable = BloodTokenTable[0];","        var currentPageGraphics = findObjs({","            _type: \"tableitem\",","            _rollabletableid: BloodTokenTable.get(\"_id\")","        });","        _.each(currentPageGraphics, function(obj) {","            urls.push(obj.get(\"avatar\"));","        });","        var ret = urls[randomInteger(urls.length) - 1];","        var tokenURL = ret.replace(\"max.png\", \"thumb.png\").replace(\"med.png\", \"thumb.png\");","        var bloodmarker = createObj('graphic', {","            name: \"Damage\",","            pageid: current_token.get(\"_pageid\"),","            layer: 'map',","            imgsrc: tokenURL,","            left: current_token.get(\"left\"),","            top: current_token.get(\"top\"),","            height: size,","            width: size,","            rotation: rot","        });","        fixNO(bloodmarker);","        var BloodArrayPart = {","            id: bloodmarker.get(\"_id\")","        };","        state.bloodlist.push(BloodArrayPart);","        if(state.bloodlist.length >= 10) {","            var token = findObjs({","                _id: state.bloodlist[0].id,","                _type: \"graphic\"","            })[0];","            if(token !== undefined) token.remove();","            state.bloodlist.shift();","        }","        setTimeout(function() {","            current_token.set({","                'tint_color': \"transparent\"","            });","        }, 2000);","        setTimeout(function() {","            toFront(bloodmarker);","        }, 1);","    }","};","","function removetoken(token, time) {","    setTimeout(function() {","        token.remove();","    }, time);","};"]}]}],[{"group":"doc","deltas":[{"start":{"row":157,"column":8},"end":{"row":157,"column":12},"action":"remove","lines":["var "]}]}]]},"ace":{"folds":[],"scrolltop":734,"scrollleft":0,"selection":{"start":{"row":218,"column":24},"end":{"row":218,"column":24},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":51,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1421663807737,"hash":"d707aea4cc6dbe2da29fd93a52e9850d3927542e"}