{"filter":false,"title":"TurnsNew","tooltip":"/TurnsNew","undoManager":{"mark":100,"position":100,"stack":[[{"start":{"row":163,"column":38},"end":{"row":163,"column":39},"action":"remove","lines":["\t"],"id":766}],[{"start":{"row":163,"column":76},"end":{"row":164,"column":0},"action":"remove","lines":["",""],"id":767}],[{"start":{"row":163,"column":76},"end":{"row":163,"column":77},"action":"remove","lines":["\t"],"id":768}],[{"start":{"row":163,"column":76},"end":{"row":163,"column":77},"action":"remove","lines":["\t"],"id":769}],[{"start":{"row":163,"column":76},"end":{"row":163,"column":77},"action":"remove","lines":["\t"],"id":770}],[{"start":{"row":163,"column":76},"end":{"row":163,"column":77},"action":"remove","lines":["\t"],"id":771}],[{"start":{"row":10,"column":0},"end":{"row":51,"column":2},"action":"remove","lines":["    /*--NPC INT COMMAND--*/","    if(msg.type == 'api' && msg.content.indexOf('!int') !== -1) {","\t\tvar selected = msg.selected;","\t\tif(Campaign().get(\"turnorder\") == \"\") order = [];","\t\telse order = JSON.parse(Campaign().get(\"turnorder\"));","\t\ti = 0;","\t\t_.each(selected, function(obj) {","\t\t\tsendChat('', \"/roll [[1d20+3]]\", function(ops) {","\t\t\t\tvar token = getObj('graphic', msg.selected[i]._id);","\t\t\t\tvar rollresult = ops[0];","\t\t\t\tresult = rollresult.inlinerolls[0].results.total;","\t\t\t\tif(result > 20) result = 20;","\t\t\t\tfound = false;","\t\t\t\tfor(var y = 0; y < order.length; ++y) {","\t\t\t\t\tif(token.id === order[y].id) {","\t\t\t\t\t\torder[y].pr = result;","\t\t\t\t\t\tfound = true;","\t\t\t\t\t\tbreak;","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\tif(!found) {","\t\t\t\t\torder.push({","\t\t\t\t\t\tid: msg.selected[i]._id,","\t\t\t\t\t\tpr: result","\t\t\t\t\t});","\t\t\t\t}","\t\t\t\toCharacter = getObj(\"character\", token.get(\"represents\"));","\t\t\t\tif(oCharacter == undefined && token.get(\"name\") == \"\") {","\t\t\t\t\ttoken.set({","\t\t\t\t\t\t\"name\": \"[NPC]\" + (i + 1)","\t\t\t\t\t});","\t\t\t\t}","\t\t\t\tname = token.get(\"name\");","\t\t\t\tif(token.get(\"layer\") == \"gmlayer\") {","\t\t\t\t\tname = \"UNKNOWN\";","\t\t\t\t\tsendChat('', \"/w GM Rolled a \" + result + \" for Int\");","\t\t\t\t} else sendChat('', \"/me \" + name + \" Rolled a \" + result + \" for Initiative!\");","\t\t\t\tsort(order); /*--SORT TURNS--*/","\t\t\t\ti++;","\t\t\t});","\t\t});","\t}"],"id":772}],[{"start":{"row":10,"column":0},"end":{"row":11,"column":0},"action":"remove","lines":["",""],"id":773}],[{"start":{"row":77,"column":23},"end":{"row":78,"column":0},"action":"remove","lines":["",""],"id":774}],[{"start":{"row":77,"column":23},"end":{"row":77,"column":24},"action":"remove","lines":["\t"],"id":775}],[{"start":{"row":77,"column":23},"end":{"row":77,"column":24},"action":"remove","lines":["\t"],"id":776}],[{"start":{"row":77,"column":23},"end":{"row":77,"column":24},"action":"remove","lines":["\t"],"id":777}],[{"start":{"row":77,"column":36},"end":{"row":78,"column":0},"action":"remove","lines":["",""],"id":778}],[{"start":{"row":77,"column":36},"end":{"row":77,"column":37},"action":"remove","lines":["\t"],"id":779}],[{"start":{"row":77,"column":36},"end":{"row":77,"column":37},"action":"remove","lines":["\t"],"id":780}],[{"start":{"row":77,"column":36},"end":{"row":77,"column":37},"action":"remove","lines":["\t"],"id":781}],[{"start":{"row":77,"column":74},"end":{"row":78,"column":0},"action":"remove","lines":["",""],"id":782}],[{"start":{"row":77,"column":74},"end":{"row":77,"column":75},"action":"remove","lines":["\t"],"id":783}],[{"start":{"row":77,"column":74},"end":{"row":77,"column":75},"action":"remove","lines":["\t"],"id":784}],[{"start":{"row":77,"column":0},"end":{"row":78,"column":47},"action":"remove","lines":["\t\ttmmarker = findObjs({name: \"Turn\",pageid: Campaign().get(\"playerpageid\")})[0];","\t\tif(tmmarker !== undefined) tmmarker.remove();"],"id":785}],[{"start":{"row":77,"column":0},"end":{"row":78,"column":0},"action":"remove","lines":["",""],"id":786}],[{"start":{"row":134,"column":14},"end":{"row":135,"column":0},"action":"remove","lines":["",""],"id":787}],[{"start":{"row":134,"column":14},"end":{"row":134,"column":15},"action":"remove","lines":["\t"],"id":788}],[{"start":{"row":134,"column":14},"end":{"row":134,"column":15},"action":"remove","lines":["\t"],"id":789}],[{"start":{"row":134,"column":14},"end":{"row":134,"column":15},"action":"remove","lines":["\t"],"id":790}],[{"start":{"row":134,"column":46},"end":{"row":135,"column":0},"action":"remove","lines":["",""],"id":791}],[{"start":{"row":134,"column":46},"end":{"row":134,"column":47},"action":"remove","lines":["\t"],"id":792}],[{"start":{"row":134,"column":46},"end":{"row":134,"column":47},"action":"remove","lines":["\t"],"id":793}],[{"start":{"row":134,"column":46},"end":{"row":134,"column":47},"action":"remove","lines":["\t"],"id":794}],[{"start":{"row":134,"column":80},"end":{"row":135,"column":0},"action":"remove","lines":["",""],"id":795}],[{"start":{"row":134,"column":80},"end":{"row":134,"column":81},"action":"remove","lines":["\t"],"id":796}],[{"start":{"row":134,"column":80},"end":{"row":134,"column":81},"action":"remove","lines":["\t"],"id":797}],[{"start":{"row":134,"column":80},"end":{"row":134,"column":81},"action":"remove","lines":["\t"],"id":798}],[{"start":{"row":134,"column":123},"end":{"row":135,"column":0},"action":"remove","lines":["",""],"id":799}],[{"start":{"row":134,"column":123},"end":{"row":134,"column":124},"action":"remove","lines":["\t"],"id":800}],[{"start":{"row":134,"column":123},"end":{"row":134,"column":124},"action":"remove","lines":["\t"],"id":801}],[{"start":{"row":134,"column":123},"end":{"row":134,"column":124},"action":"remove","lines":["\t"],"id":802}],[{"start":{"row":134,"column":163},"end":{"row":135,"column":0},"action":"remove","lines":["",""],"id":803}],[{"start":{"row":134,"column":163},"end":{"row":134,"column":164},"action":"remove","lines":["\t"],"id":804}],[{"start":{"row":134,"column":163},"end":{"row":134,"column":164},"action":"remove","lines":["\t"],"id":805}],[{"start":{"row":123,"column":0},"end":{"row":136,"column":3},"action":"remove","lines":["on(\"change:token\", function(obj) {","\tif(!Campaign().get(\"turnorder\")) return;","\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\tif(!turn_order.length) return;","\tvar current_token = getObj(\"graphic\", turn_order[0].id);","\tif(current_token == undefined) return;","\tturnname = current_token.get(\"name\");","\tvar tokens = findObjs({_type: \"graphic\",_pageid: Campaign().get('playerpageid'),name: turnname});","\tcurrent_token = tokens[0];","\tvar marker = findObjs({name: \"Turn\",pageid: Campaign().get(\"playerpageid\")})[0];","\tif(current_token.get(\"layer\") !== \"gmlayer\" && marker !== undefined) {","\t\tmarker.set({\"top\": current_token.get(\"top\"),\"left\": current_token.get(\"left\"),\"height\": current_token.get(\"height\") + 20,\"width\": current_token.get(\"width\") + 20});","\t}","});"],"id":806}],[{"start":{"row":123,"column":0},"end":{"row":124,"column":0},"action":"remove","lines":["",""],"id":807}],[{"start":{"row":128,"column":0},"end":{"row":130,"column":98},"action":"remove","lines":["\tvar tokenURL = 'https://s3.amazonaws.com/files.d20.io/images/5509346/yARWYF7LxyddmBMxjCFbUg/thumb.png?1410224858';","\tturnname = current_token.get(\"name\");","\tvar tokens = findObjs({_type: \"graphic\",_pageid: Campaign().get('playerpageid'),name: turnname});"],"id":808}],[{"start":{"row":128,"column":0},"end":{"row":129,"column":0},"action":"remove","lines":["",""],"id":809}],[{"start":{"row":116,"column":0},"end":{"row":117,"column":49},"action":"remove","lines":["\t\t\t\ttmmarker = findObjs({name: \"Turn\",pageid: Campaign().get(\"playerpageid\")})[0];","\t\t\t\tif(tmmarker !== undefined) tmmarker.remove();"],"id":810}],[{"start":{"row":116,"column":0},"end":{"row":117,"column":0},"action":"remove","lines":["",""],"id":811}],[{"start":{"row":82,"column":0},"end":{"row":82,"column":14},"action":"remove","lines":["tmmarker = {};"],"id":812}],[{"start":{"row":82,"column":0},"end":{"row":83,"column":0},"action":"remove","lines":["",""],"id":813}],[{"start":{"row":5,"column":0},"end":{"row":5,"column":114},"action":"remove","lines":["var tokenURL = 'https://s3.amazonaws.com/files.d20.io/images/5509346/yARWYF7LxyddmBMxjCFbUg/thumb.png?1410224858';"],"id":814}],[{"start":{"row":5,"column":0},"end":{"row":6,"column":0},"action":"remove","lines":["",""],"id":815}],[{"start":{"row":130,"column":0},"end":{"row":130,"column":20},"action":"remove","lines":["\t\t//return tmmarker;"],"id":816}],[{"start":{"row":130,"column":0},"end":{"row":131,"column":0},"action":"remove","lines":["",""],"id":817}],[{"start":{"row":126,"column":0},"end":{"row":129,"column":31},"action":"remove","lines":["\t\tvar picbox = \"<div style= 'background-color:#ffffff; display: inline-block; border: 1px solid #000; margin: 0.2em; border-radius: 10px 10px 10px 10px; align:'center''><img src=\" + piclink + \" style=height:30px; width:30px;'></div>\";","\t\tvar table = '<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"20%\">' + picbox + '</td><td width=\"90%\"><b>Turn: ' + iName2 + '</b></td></tr></table>';","\t\tvar R = iPart2 + \" background-color:#\" + pColor + \";'>\" + table + \"</div>\";","\t\tsendChat('', \"/direct \" + R);"],"id":819}],[{"start":{"row":126,"column":0},"end":{"row":127,"column":0},"action":"remove","lines":["",""],"id":820}],[{"start":{"row":132,"column":2},"end":{"row":133,"column":0},"action":"insert","lines":["",""],"id":821},{"start":{"row":133,"column":0},"end":{"row":133,"column":1},"action":"insert","lines":["\t"]}],[{"start":{"row":133,"column":1},"end":{"row":136,"column":31},"action":"insert","lines":["\t\tvar picbox = \"<div style= 'background-color:#ffffff; display: inline-block; border: 1px solid #000; margin: 0.2em; border-radius: 10px 10px 10px 10px; align:'center''><img src=\" + piclink + \" style=height:30px; width:30px;'></div>\";","\t\tvar table = '<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"20%\">' + picbox + '</td><td width=\"90%\"><b>Turn: ' + iName2 + '</b></td></tr></table>';","\t\tvar R = iPart2 + \" background-color:#\" + pColor + \";'>\" + table + \"</div>\";","\t\tsendChat('', \"/direct \" + R);"],"id":822}],[{"start":{"row":133,"column":2},"end":{"row":133,"column":3},"action":"remove","lines":["\t"],"id":823}],[{"start":{"row":133,"column":0},"end":{"row":133,"column":1},"action":"remove","lines":["\t"],"id":824},{"start":{"row":134,"column":0},"end":{"row":134,"column":1},"action":"remove","lines":["\t"]},{"start":{"row":135,"column":0},"end":{"row":135,"column":1},"action":"remove","lines":["\t"]},{"start":{"row":136,"column":0},"end":{"row":136,"column":1},"action":"remove","lines":["\t"]}],[{"start":{"row":128,"column":0},"end":{"row":131,"column":31},"action":"remove","lines":["\t\tvar picbox = \"<div style= 'background-color:#ffffff; display: inline-block; border: 1px solid #000; margin: 0.2em; border-radius: 10px 10px 10px 10px; align:'center''><img src=\" + piclink + \" style=height:30px;'></div>\";","\t\tvar table = '<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"20%\">' + picbox + '</td><td width=\"90%\"><b>Turn: UNKNOWN</b></td></tr></table>';","\t\tvar R = iPart2 + \" background-color:#\" + pColor + \";'>\" + table + \"</div>\";","\t\tsendChat('', \"/direct \" + R);"],"id":825}],[{"start":{"row":128,"column":0},"end":{"row":129,"column":0},"action":"remove","lines":["",""],"id":826}],[{"start":{"row":125,"column":44},"end":{"row":126,"column":0},"action":"insert","lines":["",""],"id":827},{"start":{"row":126,"column":0},"end":{"row":126,"column":2},"action":"insert","lines":["\t\t"]}],[{"start":{"row":126,"column":2},"end":{"row":126,"column":3},"action":"insert","lines":["i"],"id":828}],[{"start":{"row":126,"column":3},"end":{"row":126,"column":4},"action":"insert","lines":["N"],"id":829}],[{"start":{"row":126,"column":4},"end":{"row":126,"column":5},"action":"insert","lines":["a"],"id":830}],[{"start":{"row":126,"column":5},"end":{"row":126,"column":6},"action":"insert","lines":["m"],"id":831}],[{"start":{"row":126,"column":6},"end":{"row":126,"column":7},"action":"insert","lines":["e"],"id":832}],[{"start":{"row":126,"column":7},"end":{"row":126,"column":8},"action":"insert","lines":[" "],"id":833}],[{"start":{"row":126,"column":8},"end":{"row":126,"column":9},"action":"insert","lines":["="],"id":834}],[{"start":{"row":126,"column":9},"end":{"row":126,"column":10},"action":"insert","lines":[" "],"id":835}],[{"start":{"row":126,"column":10},"end":{"row":126,"column":12},"action":"insert","lines":["\"\""],"id":836}],[{"start":{"row":126,"column":11},"end":{"row":126,"column":12},"action":"insert","lines":["U"],"id":837}],[{"start":{"row":126,"column":12},"end":{"row":126,"column":13},"action":"insert","lines":["N"],"id":838}],[{"start":{"row":126,"column":13},"end":{"row":126,"column":14},"action":"insert","lines":[" "],"id":839}],[{"start":{"row":126,"column":13},"end":{"row":126,"column":14},"action":"remove","lines":[" "],"id":840}],[{"start":{"row":126,"column":11},"end":{"row":126,"column":13},"action":"remove","lines":["UN"],"id":841},{"start":{"row":126,"column":11},"end":{"row":126,"column":18},"action":"insert","lines":["UNKNOWN"]}],[{"start":{"row":126,"column":19},"end":{"row":126,"column":20},"action":"insert","lines":[";"],"id":842}],[{"start":{"row":126,"column":7},"end":{"row":126,"column":8},"action":"insert","lines":["2"],"id":843}],[{"start":{"row":0,"column":0},"end":{"row":207,"column":2},"action":"remove","lines":["/*global gmC state on obj getObj iPart _ playerIsGM brPart RollRight formatNumber findObjs sendChat CONFIG lPart fPart gm_img gPart greenC redC grayC OuterDiv Campaign randomFromTo createObj fixNO toFront randomInteger*/","var WillTurnOrder = {};","var TurnData = {};","var BestRoll = 0;","var intChat = '';","/*------------------","API CHAT COMMANDS","------------------*/","on('chat:message', function(msg) {","\t/*--TURNS-SET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Turns') !== -1) {","\t\tvar turnorder;","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tsort(turnorder); /*--SORT TURNS--*/","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tSetPurple(turnorder, false);","\t\tfor(var i in turnorder) {","\t\t\tcAttacks = 5; /*-DEFAULT ATTACKS-*/","\t\t\tname = turnorder[i].id; /*-TURN ORDER WHO-*/","\t\t\tid1 = getObj(\"graphic\", turnorder[i].id); /*-GET TOKEN-*/","\t\t\tpColor = '#636363';","\t\t\tif(id1 != undefined) {","\t\t\t\toCharacter = getObj(\"character\", id1.get(\"represents\"));","\t\t\t\tiName = id1.get(\"name\");","\t\t\t\tif(id1.get(\"layer\") == 'gmlayer') {","\t\t\t\t\tiName = \"UNKNOWN\";","\t\t\t\t\tpColor = '#3D3D3D';","\t\t\t\t}","\t\t\t\tif(oCharacter != undefined) {","\t\t\t\t\tiName = oCharacter.get(\"name\");","\t\t\t\t\toAttacks = findObjs({","\t\t\t\t\t\t_type: \"attribute\",","\t\t\t\t\t\tname: \"ATT\",","\t\t\t\t\t\t_characterid: oCharacter.id","\t\t\t\t\t})[0];","\t\t\t\t\tif(oAttacks != undefined) cAttacks = parseInt(oAttacks.get(\"current\"));","\t\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\t\tif(type == 'Player') {","\t\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t\t}","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined && id1.get(\"gmnotes\") != \"\") {","\t\t\t\t\tcAttacks = id1.get(\"gmnotes\");","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined) {","\t\t\t\t\tsetbars(id1);","\t\t\t\t}","\t\t\t\tvar init = parseInt(turnorder[i].pr);","\t\t\t\tif(init < cAttacks) {","\t\t\t\t\tinit = cAttacks;","\t\t\t\t\tturnorder[i].pr = cAttacks;","\t\t\t\t}","\t\t\t\taddPlayer(name, parseInt(init), parseInt(cAttacks));","\t\t\t}","\t\t}","\t\tvar sTurns = createOrder();","\t\tsort(sTurns); /*--SORT TURNS--*/","\t\tvar aFirst = JSON.parse(Campaign().get(\"turnorder\"));","\t\tvar iName2 = getObj(\"graphic\", aFirst[1].id).get(\"name\");","\t\tif(getObj(\"graphic\", aFirst[1].id).get(\"layer\") == 'gmlayer') iName2 = \"UNKNOWN\";","\t\tvar C = fPart + \" background-color:#A80000;'><b>● ROUND STARTS ●</b></div>\";","\t\tvar R = fPart + \" background-color:#A80000;'><b>\" + iName2 + \"</b> goes first!</div>\";","\t\tsendChat('TurnTracker', \"/direct \" + C + R + \"<br>\" + intChat);","\t\treset();","\t}","\t/*--RESET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Reset') !== -1) {","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\t\tCampaign().set(\"turnorder\", '');","\t\tsendChat('', '/desc Turns Reset!');","\t}","});","/*------------------","HIGHLIGHT TURNS","------------------*/","on(\"change:campaign:turnorder\", function(obj, prev) {","\tif(!Campaign().get(\"turnorder\")) return;","\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\tif(!turn_order.length) return;","\tif(!turn_order[0].id == -1) {","\t\tSetPurple(turn_order, true);","\t\treturn;","\t}","\tvar current_token = getObj(\"graphic\", turn_order[0].id);","\tvar R = fPart + \" background-color:#A80000;'><b>-=-<br>NEW ROUND:</b> roll initiative!<br>-=-</div>\";","\tif(current_token == undefined) sendChat('', '/direct ' + R);","\tif(current_token != undefined) {","\t\tif(turn_order[0].pr == turn_order[0].pr) {","\t\t\tvar iName2 = getObj(\"graphic\", current_token.id).get(\"name\");","\t\t\toCharacter = getObj(\"character\", current_token.get(\"represents\"));","\t\t\tpColor = '#ff0000';","\t\t\tif(getObj(\"graphic\", current_token.id).get(\"layer\") == 'gmlayer') pColor = '#3D3D3D';","\t\t\tif(oCharacter != undefined) {","\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\tif(type == 'Player') {","\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t\tdieName = 'StartRound';","\t\t\tvar to = JSON.parse(obj.get('turnorder'));","\t\t\tloc = _.find(to, function(e) {","\t\t\t\treturn dieName === e.custom;","\t\t\t});","\t\t\tif(loc !== undefined) {","\t\t\t\tmovemarker(current_token, pColor, iName2);","\t\t\t} else SetPurple(turn_order, 1);","\t\t}","\t}","});","/*------------------","FUNCTIONS","------------------*/","//--MOVE TURN MARKER","function movemarker(current_token, pColor, iName2) {","\tif(current_token.get(\"layer\") !== \"gmlayer\") {","\t\tvar piclink = current_token.get(\"imgsrc\");","\t\tiName2 = \"UNKNOWN\";","\t} else {","\t\tpiclink = 'http://www.clker.com/cliparts/i/X/D/N/j/p/icon-with-question-mark-hi.png';","\t}","\tvar picbox = \"<div style= 'background-color:#ffffff; display: inline-block; border: 1px solid #000; margin: 0.2em; border-radius: 10px 10px 10px 10px; align:'center''><img src=\" + piclink + \" style=height:30px; width:30px;'></div>\";","\tvar table = '<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"20%\">' + picbox + '</td><td width=\"90%\"><b>Turn: ' + iName2 + '</b></td></tr></table>';","\tvar R = iPart2 + \" background-color:#\" + pColor + \";'>\" + table + \"</div>\";","\tsendChat('', \"/direct \" + R);","};","//--SET BARS","function setbars(id1) {","\tif(id1.get(\"bar1_value\") == \"\" || id1.get(\"bar2_value\") == \"\") {","\t\tid1.set('bar1_value', 100);","\t\tid1.set('bar1_max', 100);","\t\tid1.set('bar2_value', 100);","\t\tid1.set('bar2_max', 100);","\t}","};","","function SetPurple(turn_order, toggle) {","\ti = 0;","\t_.each(turn_order, function(obj) {","\t\tvar tokens = getObj('graphic', turn_order[i].id);","\t\tif(tokens == undefined) return;","\t\ttokens.set(\"status_purple\", toggle);","\t\ti++;","\t});","};","//--SORT LIST","function sort(order) {","\tvar nOrd = order.sortByProp('pr');","\tCampaign().set(\"turnorder\", JSON.stringify(nOrd));","};","Array.prototype.sortByProp = function(p) {","\treturn this.sort(function(a, b) {","\t\treturn(parseInt(a[p], 10) < parseInt(b[p], 10)) ? 1 : (parseInt(a[p], 10) > parseInt(b[p], 10)) ? -1 : 0;","\t});","};","//--ADDPLAYER","function addPlayer(id, Roll, Attack) {","\tvar inc = Roll / Attack;","\tinc = Math.round(inc * 100) / 100;","\tvar init = Roll;","\tif(Roll > BestRoll) {","\t\tBestRoll = Roll;","\t}","\tvar table = [];","\tfor(var i = 0; i < Attack; i++) {","\t\tif(init >= 0) {","\t\t\tif(init == 0) init = 1;","\t\t\ttable.push(parseInt(init));","\t\t\tinit = (init - inc);","\t\t}","\t}","\toutput = pColor;","\tiName = iName.toUpperCase();","\tturnNums = table.toString();","\tChatSay = iPart + \"background-color:\" + output + \";'>\" + \"<b>\" + iName + \"</b> (Att:\" + Attack + \") (Roll:\" + Roll + \")<br></b><b>\" + turnNums + \"</b></div>\";","\tif(iName == \"UNKNOWN\") ChatSay = \"\";","\tintChat1 = ChatSay;","\tintChat += intChat1;","\tTurnData[id] = {\"Roll\": Roll,\"Attack\": Attack,\"Table\": table};","};","//--CREATE ORDER","function createOrder() {","\tvar order = [];","\tfor(i = (BestRoll + 1); i > 0; i--) {","\t\t_.each(TurnData, function(value, key) {","\t\t\tif(value.Table.indexOf(i) != -1) {","\t\t\t\torder.push({\"id\": key,\"pr\": i,\"custom\": \"\"});","\t\t\t}","\t\t});","\t}","\torder.unshift({\"id\": '-1',\"pr\": 100,\"custom\": \"StartRound\"});","\treturn order;","};","//--RESET TURNS","function reset() {","\tTurnData = {};","\tBestRoll = 0;","\tintChat = '';","};"],"id":844},{"start":{"row":0,"column":0},"end":{"row":205,"column":2},"action":"insert","lines":["/*global gmC state on obj getObj iPart _ playerIsGM brPart RollRight formatNumber findObjs sendChat CONFIG lPart fPart gm_img gPart greenC redC grayC OuterDiv Campaign randomFromTo createObj fixNO toFront randomInteger*/","var WillTurnOrder = {};","var TurnData = {};","var BestRoll = 0;","var intChat = '';","/*------------------","API CHAT COMMANDS","------------------*/","on('chat:message', function(msg) {","    /*--TURNS-SET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Turns') !== -1) {","\t\tvar turnorder;","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tsort(turnorder); /*--SORT TURNS--*/","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tSetPurple(turnorder, false);","\t\tfor(var i in turnorder) {","\t\t\tcAttacks = 5; /*-DEFAULT ATTACKS-*/","\t\t\tname = turnorder[i].id; /*-TURN ORDER WHO-*/","\t\t\tid1 = getObj(\"graphic\", turnorder[i].id); /*-GET TOKEN-*/","\t\t\tpColor = '#636363';","\t\t\tif(id1 != undefined) {","\t\t\t\toCharacter = getObj(\"character\", id1.get(\"represents\"));","\t\t\t\tiName = id1.get(\"name\");","\t\t\t\tif(id1.get(\"layer\") == 'gmlayer') {","\t\t\t\t\tiName = \"UNKNOWN\";","\t\t\t\t\tpColor = '#3D3D3D';","\t\t\t\t}","\t\t\t\tif(oCharacter != undefined) {","\t\t\t\t\tiName = oCharacter.get(\"name\");","\t\t\t\t\toAttacks = findObjs({","\t\t\t\t\t\t_type: \"attribute\",","\t\t\t\t\t\tname: \"ATT\",","\t\t\t\t\t\t_characterid: oCharacter.id","\t\t\t\t\t})[0];","\t\t\t\t\tif(oAttacks != undefined) cAttacks = parseInt(oAttacks.get(\"current\"));","\t\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\t\tif(type == 'Player') {","\t\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t\t}","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined && id1.get(\"gmnotes\") != \"\") {","\t\t\t\t\tcAttacks = id1.get(\"gmnotes\");","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined) {","\t\t\t\t\tsetbars(id1);","\t\t\t\t}","\t\t\t\tvar init = parseInt(turnorder[i].pr);","\t\t\t\tif(init < cAttacks) {","\t\t\t\t\tinit = cAttacks;","\t\t\t\t\tturnorder[i].pr = cAttacks;","\t\t\t\t}","\t\t\t\taddPlayer(name, parseInt(init), parseInt(cAttacks));","\t\t\t}","\t\t}","\t\tvar sTurns = createOrder();","\t\tsort(sTurns); /*--SORT TURNS--*/","\t\tvar aFirst = JSON.parse(Campaign().get(\"turnorder\"));","\t\tvar iName2 = getObj(\"graphic\", aFirst[1].id).get(\"name\");","\t\tif(getObj(\"graphic\", aFirst[1].id).get(\"layer\") == 'gmlayer') iName2 = \"UNKNOWN\";","\t\tvar C = fPart + \" background-color:#A80000;'><b>● ROUND STARTS ●</b></div>\";","\t\tvar R = fPart + \" background-color:#A80000;'><b>\" + iName2 + \"</b> goes first!</div>\";","\t\tsendChat('TurnTracker', \"/direct \" + C + R + \"<br>\" + intChat);","\t\treset();","\t}","\t/*--RESET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Reset') !== -1) {","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\t\tCampaign().set(\"turnorder\", '');","\t\tsendChat('', '/desc Turns Reset!');","\t}","});","/*------------------","HIGHLIGHT TURNS","------------------*/","on(\"change:campaign:turnorder\", function(obj, prev) {","\tif(!Campaign().get(\"turnorder\")) return;","\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\tif(!turn_order.length) return;","\tif(!turn_order[0].id == -1) {","\t\tSetPurple(turn_order, true);","\t\treturn;","\t}","\tvar current_token = getObj(\"graphic\", turn_order[0].id);","\tif(current_token != undefined) {","\t\tif(turn_order[0].pr == turn_order[0].pr) {","\t\t\tvar iName2 = getObj(\"graphic\", current_token.id).get(\"name\");","\t\t\toCharacter = getObj(\"character\", current_token.get(\"represents\"));","\t\t\tpColor = '#ff0000';","\t\t\tif(getObj(\"graphic\", current_token.id).get(\"layer\") == 'gmlayer') pColor = '#3D3D3D';","\t\t\tif(oCharacter != undefined) {","\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\tif(type == 'Player') {","\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t\tdieName = 'StartRound';","\t\t\tvar to = JSON.parse(obj.get('turnorder'));","\t\t\tloc = _.find(to, function(e) {","\t\t\t\treturn dieName === e.custom;","\t\t\t});","\t\t\tif(loc !== undefined) {","\t\t\t\tmovemarker(current_token, pColor, iName2);","\t\t\t} else SetPurple(turn_order, 1);","\t\t}","\t}","});","/*------------------","FUNCTIONS","------------------*/","//--MOVE TURN MARKER","function movemarker(current_token, pColor, iName2) {","\tif(current_token.get(\"layer\") !== \"gmlayer\") {","\t\tvar piclink = current_token.get(\"imgsrc\");","\t\tiName2 = \"UNKNOWN\";","\t} else {","\t\tpiclink = 'http://www.clker.com/cliparts/i/X/D/N/j/p/icon-with-question-mark-hi.png';","\t}","\tvar picbox = \"<div style= 'background-color:#ffffff; display: inline-block; border: 1px solid #000; margin: 0.2em; border-radius: 10px 10px 10px 10px; align:'center''><img src=\" + piclink + \" style=height:30px; width:30px;'></div>\";","\tvar table = '<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"20%\">' + picbox + '</td><td width=\"90%\"><b>Turn: ' + iName2 + '</b></td></tr></table>';","\tvar R = iPart2 + \" background-color:#\" + pColor + \";'>\" + table + \"</div>\";","\tsendChat('', \"/direct \" + R);","};","//--SET BARS","function setbars(id1) {","\tif(id1.get(\"bar1_value\") == \"\" || id1.get(\"bar2_value\") == \"\") {","\t\tid1.set('bar1_value', 100);","\t\tid1.set('bar1_max', 100);","\t\tid1.set('bar2_value', 100);","\t\tid1.set('bar2_max', 100);","\t}","};","","function SetPurple(turn_order, toggle) {","\ti = 0;","\t_.each(turn_order, function(obj) {","\t\tvar tokens = getObj('graphic', turn_order[i].id);","\t\tif(tokens == undefined) return;","\t\ttokens.set(\"status_purple\", toggle);","\t\ti++;","\t});","};","//--SORT LIST","function sort(order) {","\tvar nOrd = order.sortByProp('pr');","\tCampaign().set(\"turnorder\", JSON.stringify(nOrd));","};","Array.prototype.sortByProp = function(p) {","\treturn this.sort(function(a, b) {","\t\treturn(parseInt(a[p], 10) < parseInt(b[p], 10)) ? 1 : (parseInt(a[p], 10) > parseInt(b[p], 10)) ? -1 : 0;","\t});","};","//--ADDPLAYER","function addPlayer(id, Roll, Attack) {","\tvar inc = Roll / Attack;","\tinc = Math.round(inc * 100) / 100;","\tvar init = Roll;","\tif(Roll > BestRoll) {","\t\tBestRoll = Roll;","\t}","\tvar table = [];","\tfor(var i = 0; i < Attack; i++) {","\t\tif(init >= 0) {","\t\t\tif(init == 0) init = 1;","\t\t\ttable.push(parseInt(init));","\t\t\tinit = (init - inc);","\t\t}","\t}","\toutput = pColor;","\tiName = iName.toUpperCase();","\tturnNums = table.toString();","\tChatSay = iPart + \"background-color:\" + output + \";'>\" + \"<b>\" + iName + \"</b> (Att:\" + Attack + \") (Roll:\" + Roll + \")<br></b><b>\" + turnNums + \"</b></div>\";","\tif(iName == \"UNKNOWN\") ChatSay = \"\";","\tintChat1 = ChatSay;","\tintChat += intChat1;","\tTurnData[id] = {\"Roll\": Roll,\"Attack\": Attack,\"Table\": table};","};","//--CREATE ORDER","function createOrder() {","\tvar order = [];","\tfor(i = (BestRoll + 1); i > 0; i--) {","\t\t_.each(TurnData, function(value, key) {","\t\t\tif(value.Table.indexOf(i) != -1) {","\t\t\t\torder.push({\"id\": key,\"pr\": i,\"custom\": \"\"});","\t\t\t}","\t\t});","\t}","\torder.unshift({\"id\": '-1',\"pr\": 100,\"custom\": \"StartRound\"});","\treturn order;","};","//--RESET TURNS","function reset() {","\tTurnData = {};","\tBestRoll = 0;","\tintChat = '';","};"]}],[{"start":{"row":0,"column":0},"end":{"row":205,"column":2},"action":"remove","lines":["/*global gmC state on obj getObj iPart _ playerIsGM brPart RollRight formatNumber findObjs sendChat CONFIG lPart fPart gm_img gPart greenC redC grayC OuterDiv Campaign randomFromTo createObj fixNO toFront randomInteger*/","var WillTurnOrder = {};","var TurnData = {};","var BestRoll = 0;","var intChat = '';","/*------------------","API CHAT COMMANDS","------------------*/","on('chat:message', function(msg) {","    /*--TURNS-SET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Turns') !== -1) {","\t\tvar turnorder;","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tsort(turnorder); /*--SORT TURNS--*/","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tSetPurple(turnorder, false);","\t\tfor(var i in turnorder) {","\t\t\tcAttacks = 5; /*-DEFAULT ATTACKS-*/","\t\t\tname = turnorder[i].id; /*-TURN ORDER WHO-*/","\t\t\tid1 = getObj(\"graphic\", turnorder[i].id); /*-GET TOKEN-*/","\t\t\tpColor = '#636363';","\t\t\tif(id1 != undefined) {","\t\t\t\toCharacter = getObj(\"character\", id1.get(\"represents\"));","\t\t\t\tiName = id1.get(\"name\");","\t\t\t\tif(id1.get(\"layer\") == 'gmlayer') {","\t\t\t\t\tiName = \"UNKNOWN\";","\t\t\t\t\tpColor = '#3D3D3D';","\t\t\t\t}","\t\t\t\tif(oCharacter != undefined) {","\t\t\t\t\tiName = oCharacter.get(\"name\");","\t\t\t\t\toAttacks = findObjs({","\t\t\t\t\t\t_type: \"attribute\",","\t\t\t\t\t\tname: \"ATT\",","\t\t\t\t\t\t_characterid: oCharacter.id","\t\t\t\t\t})[0];","\t\t\t\t\tif(oAttacks != undefined) cAttacks = parseInt(oAttacks.get(\"current\"));","\t\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\t\tif(type == 'Player') {","\t\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t\t}","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined && id1.get(\"gmnotes\") != \"\") {","\t\t\t\t\tcAttacks = id1.get(\"gmnotes\");","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined) {","\t\t\t\t\tsetbars(id1);","\t\t\t\t}","\t\t\t\tvar init = parseInt(turnorder[i].pr);","\t\t\t\tif(init < cAttacks) {","\t\t\t\t\tinit = cAttacks;","\t\t\t\t\tturnorder[i].pr = cAttacks;","\t\t\t\t}","\t\t\t\taddPlayer(name, parseInt(init), parseInt(cAttacks));","\t\t\t}","\t\t}","\t\tvar sTurns = createOrder();","\t\tsort(sTurns); /*--SORT TURNS--*/","\t\tvar aFirst = JSON.parse(Campaign().get(\"turnorder\"));","\t\tvar iName2 = getObj(\"graphic\", aFirst[1].id).get(\"name\");","\t\tif(getObj(\"graphic\", aFirst[1].id).get(\"layer\") == 'gmlayer') iName2 = \"UNKNOWN\";","\t\tvar C = fPart + \" background-color:#A80000;'><b>● ROUND STARTS ●</b></div>\";","\t\tvar R = fPart + \" background-color:#A80000;'><b>\" + iName2 + \"</b> goes first!</div>\";","\t\tsendChat('TurnTracker', \"/direct \" + C + R + \"<br>\" + intChat);","\t\treset();","\t}","\t/*--RESET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Reset') !== -1) {","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\t\tCampaign().set(\"turnorder\", '');","\t\tsendChat('', '/desc Turns Reset!');","\t}","});","/*------------------","HIGHLIGHT TURNS","------------------*/","on(\"change:campaign:turnorder\", function(obj, prev) {","\tif(!Campaign().get(\"turnorder\")) return;","\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\tif(!turn_order.length) return;","\tif(!turn_order[0].id == -1) {","\t\tSetPurple(turn_order, true);","\t\treturn;","\t}","\tvar current_token = getObj(\"graphic\", turn_order[0].id);","\tif(current_token != undefined) {","\t\tif(turn_order[0].pr == turn_order[0].pr) {","\t\t\tvar iName2 = getObj(\"graphic\", current_token.id).get(\"name\");","\t\t\toCharacter = getObj(\"character\", current_token.get(\"represents\"));","\t\t\tpColor = '#ff0000';","\t\t\tif(getObj(\"graphic\", current_token.id).get(\"layer\") == 'gmlayer') pColor = '#3D3D3D';","\t\t\tif(oCharacter != undefined) {","\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\tif(type == 'Player') {","\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t\tdieName = 'StartRound';","\t\t\tvar to = JSON.parse(obj.get('turnorder'));","\t\t\tloc = _.find(to, function(e) {","\t\t\t\treturn dieName === e.custom;","\t\t\t});","\t\t\tif(loc !== undefined) {","\t\t\t\tmovemarker(current_token, pColor, iName2);","\t\t\t} else SetPurple(turn_order, 1);","\t\t}","\t}","});","/*------------------","FUNCTIONS","------------------*/","//--MOVE TURN MARKER","function movemarker(current_token, pColor, iName2) {","\tif(current_token.get(\"layer\") !== \"gmlayer\") {","\t\tvar piclink = current_token.get(\"imgsrc\");","\t\tiName2 = \"UNKNOWN\";","\t} else {","\t\tpiclink = 'http://www.clker.com/cliparts/i/X/D/N/j/p/icon-with-question-mark-hi.png';","\t}","\tvar picbox = \"<div style= 'background-color:#ffffff; display: inline-block; border: 1px solid #000; margin: 0.2em; border-radius: 10px 10px 10px 10px; align:'center''><img src=\" + piclink + \" style=height:30px; width:30px;'></div>\";","\tvar table = '<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"20%\">' + picbox + '</td><td width=\"90%\"><b>Turn: ' + iName2 + '</b></td></tr></table>';","\tvar R = iPart2 + \" background-color:#\" + pColor + \";'>\" + table + \"</div>\";","\tsendChat('', \"/direct \" + R);","};","//--SET BARS","function setbars(id1) {","\tif(id1.get(\"bar1_value\") == \"\" || id1.get(\"bar2_value\") == \"\") {","\t\tid1.set('bar1_value', 100);","\t\tid1.set('bar1_max', 100);","\t\tid1.set('bar2_value', 100);","\t\tid1.set('bar2_max', 100);","\t}","};","","function SetPurple(turn_order, toggle) {","\ti = 0;","\t_.each(turn_order, function(obj) {","\t\tvar tokens = getObj('graphic', turn_order[i].id);","\t\tif(tokens == undefined) return;","\t\ttokens.set(\"status_purple\", toggle);","\t\ti++;","\t});","};","//--SORT LIST","function sort(order) {","\tvar nOrd = order.sortByProp('pr');","\tCampaign().set(\"turnorder\", JSON.stringify(nOrd));","};","Array.prototype.sortByProp = function(p) {","\treturn this.sort(function(a, b) {","\t\treturn(parseInt(a[p], 10) < parseInt(b[p], 10)) ? 1 : (parseInt(a[p], 10) > parseInt(b[p], 10)) ? -1 : 0;","\t});","};","//--ADDPLAYER","function addPlayer(id, Roll, Attack) {","\tvar inc = Roll / Attack;","\tinc = Math.round(inc * 100) / 100;","\tvar init = Roll;","\tif(Roll > BestRoll) {","\t\tBestRoll = Roll;","\t}","\tvar table = [];","\tfor(var i = 0; i < Attack; i++) {","\t\tif(init >= 0) {","\t\t\tif(init == 0) init = 1;","\t\t\ttable.push(parseInt(init));","\t\t\tinit = (init - inc);","\t\t}","\t}","\toutput = pColor;","\tiName = iName.toUpperCase();","\tturnNums = table.toString();","\tChatSay = iPart + \"background-color:\" + output + \";'>\" + \"<b>\" + iName + \"</b> (Att:\" + Attack + \") (Roll:\" + Roll + \")<br></b><b>\" + turnNums + \"</b></div>\";","\tif(iName == \"UNKNOWN\") ChatSay = \"\";","\tintChat1 = ChatSay;","\tintChat += intChat1;","\tTurnData[id] = {\"Roll\": Roll,\"Attack\": Attack,\"Table\": table};","};","//--CREATE ORDER","function createOrder() {","\tvar order = [];","\tfor(i = (BestRoll + 1); i > 0; i--) {","\t\t_.each(TurnData, function(value, key) {","\t\t\tif(value.Table.indexOf(i) != -1) {","\t\t\t\torder.push({\"id\": key,\"pr\": i,\"custom\": \"\"});","\t\t\t}","\t\t});","\t}","\torder.unshift({\"id\": '-1',\"pr\": 100,\"custom\": \"StartRound\"});","\treturn order;","};","//--RESET TURNS","function reset() {","\tTurnData = {};","\tBestRoll = 0;","\tintChat = '';","};"],"id":845},{"start":{"row":0,"column":0},"end":{"row":205,"column":2},"action":"insert","lines":["/*global gmC state on obj getObj iPart _ playerIsGM brPart RollRight formatNumber findObjs sendChat CONFIG lPart fPart gm_img gPart greenC redC grayC OuterDiv Campaign randomFromTo createObj fixNO toFront randomInteger*/","var WillTurnOrder = {};","var TurnData = {};","var BestRoll = 0;","var intChat = '';","/*------------------","API CHAT COMMANDS","------------------*/","on('chat:message', function(msg) {","    /*--TURNS-SET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Turns') !== -1) {","\t\tvar turnorder;","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tsort(turnorder); /*--SORT TURNS--*/","\t\tturnorder = JSON.parse(Campaign().get(\"turnorder\"));","\t\tSetPurple(turnorder, false);","\t\tfor(var i in turnorder) {","\t\t\tcAttacks = 5; /*-DEFAULT ATTACKS-*/","\t\t\tname = turnorder[i].id; /*-TURN ORDER WHO-*/","\t\t\tid1 = getObj(\"graphic\", turnorder[i].id); /*-GET TOKEN-*/","\t\t\tpColor = '#636363';","\t\t\tif(id1 != undefined) {","\t\t\t\toCharacter = getObj(\"character\", id1.get(\"represents\"));","\t\t\t\tiName = id1.get(\"name\");","\t\t\t\tif(id1.get(\"layer\") == 'gmlayer') {","\t\t\t\t\tiName = \"UNKNOWN\";","\t\t\t\t\tpColor = '#3D3D3D';","\t\t\t\t}","\t\t\t\tif(oCharacter != undefined) {","\t\t\t\t\tiName = oCharacter.get(\"name\");","\t\t\t\t\toAttacks = findObjs({","\t\t\t\t\t\t_type: \"attribute\",","\t\t\t\t\t\tname: \"ATT\",","\t\t\t\t\t\t_characterid: oCharacter.id","\t\t\t\t\t})[0];","\t\t\t\t\tif(oAttacks != undefined) cAttacks = parseInt(oAttacks.get(\"current\"));","\t\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\t\tif(type == 'Player') {","\t\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t\t}","\t\t\t\t\t}","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined && id1.get(\"gmnotes\") != \"\") {","\t\t\t\t\tcAttacks = id1.get(\"gmnotes\");","\t\t\t\t}","\t\t\t\tif(oCharacter == undefined) {","\t\t\t\t\tsetbars(id1);","\t\t\t\t}","\t\t\t\tvar init = parseInt(turnorder[i].pr);","\t\t\t\tif(init < cAttacks) {","\t\t\t\t\tinit = cAttacks;","\t\t\t\t\tturnorder[i].pr = cAttacks;","\t\t\t\t}","\t\t\t\taddPlayer(name, parseInt(init), parseInt(cAttacks));","\t\t\t}","\t\t}","\t\tvar sTurns = createOrder();","\t\tsort(sTurns); /*--SORT TURNS--*/","\t\tvar aFirst = JSON.parse(Campaign().get(\"turnorder\"));","\t\tvar iName2 = getObj(\"graphic\", aFirst[1].id).get(\"name\");","\t\tif(getObj(\"graphic\", aFirst[1].id).get(\"layer\") == 'gmlayer') iName2 = \"UNKNOWN\";","\t\tvar C = fPart + \" background-color:#A80000;'><b>● ROUND STARTS ●</b></div>\";","\t\tvar R = fPart + \" background-color:#A80000;'><b>\" + iName2 + \"</b> goes first!</div>\";","\t\tsendChat('TurnTracker', \"/direct \" + C + R + \"<br>\" + intChat);","\t\treset();","\t}","\t/*--RESET--*/","\tif(msg.type == 'api' && msg.content.indexOf('!Reset') !== -1) {","\t\tif(!Campaign().get(\"turnorder\")) return;","\t\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\t\tCampaign().set(\"turnorder\", '');","\t\tsendChat('', '/desc Turns Reset!');","\t}","});","/*------------------","HIGHLIGHT TURNS","------------------*/","on(\"change:campaign:turnorder\", function(obj, prev) {","\tif(!Campaign().get(\"turnorder\")) return;","\tvar turn_order = JSON.parse(Campaign().get(\"turnorder\"));","\tif(!turn_order.length) return;","\tif(!turn_order[0].id == -1) {","\t\tSetPurple(turn_order, true);","\t\treturn;","\t}","\tvar current_token = getObj(\"graphic\", turn_order[0].id);","\tif(current_token != undefined) {","\t\tif(turn_order[0].pr == turn_order[0].pr) {","\t\t\tvar iName2 = getObj(\"graphic\", current_token.id).get(\"name\");","\t\t\toCharacter = getObj(\"character\", current_token.get(\"represents\"));","\t\t\tpColor = '#ff0000';","\t\t\tif(getObj(\"graphic\", current_token.id).get(\"layer\") == 'gmlayer') pColor = '#3D3D3D';","\t\t\tif(oCharacter != undefined) {","\t\t\t\tvar type = (oCharacter.get(\"controlledby\") === \"\") ? 'Monster' : 'Player';","\t\t\t\tif(type == 'Player') {","\t\t\t\t\tvar cBy = oCharacter.get('controlledby');","\t\t\t\t\tif(cBy.split(',').length == 1 && cBy != 'all') {","\t\t\t\t\t\tplayer = getObj('player', cBy);","\t\t\t\t\t\tpColor = player.get('color');","\t\t\t\t\t}","\t\t\t\t}","\t\t\t}","\t\t\tdieName = 'StartRound';","\t\t\tvar to = JSON.parse(obj.get('turnorder'));","\t\t\tloc = _.find(to, function(e) {","\t\t\t\treturn dieName === e.custom;","\t\t\t});","\t\t\tif(loc !== undefined) {","\t\t\t\tmovemarker(current_token, pColor, iName2);","\t\t\t} else SetPurple(turn_order, 1);","\t\t}","\t}","});","/*------------------","FUNCTIONS","------------------*/","//--MOVE TURN MARKER","function movemarker(current_token, pColor, iName2) {","\tif(current_token.get(\"layer\") == \"gmlayer\") {","        piclink = 'http://www.clker.com/cliparts/i/X/D/N/j/p/icon-with-question-mark-hi.png';","\t\tiName2 = \"UNKNOWN\";","\t} else {","        var piclink = current_token.get(\"imgsrc\");","\t}","\tvar picbox = \"<div style= 'background-color:#ffffff; display: inline-block; border: 1px solid #000; margin: 0.2em; border-radius: 10px 10px 10px 10px; align:'center''><img src=\" + piclink + \" style=height:30px; width:30px;'></div>\";","\tvar table = '<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"20%\">' + picbox + '</td><td width=\"90%\"><b>Turn: ' + iName2 + '</b></td></tr></table>';","\tvar R = iPart2 + \" background-color:#\" + pColor + \";'>\" + table + \"</div>\";","\tsendChat('', \"/direct \" + R);","};","//--SET BARS","function setbars(id1) {","\tif(id1.get(\"bar1_value\") == \"\" || id1.get(\"bar2_value\") == \"\") {","\t\tid1.set('bar1_value', 100);","\t\tid1.set('bar1_max', 100);","\t\tid1.set('bar2_value', 100);","\t\tid1.set('bar2_max', 100);","\t}","};","","function SetPurple(turn_order, toggle) {","\ti = 0;","\t_.each(turn_order, function(obj) {","\t\tvar tokens = getObj('graphic', turn_order[i].id);","\t\tif(tokens == undefined) return;","\t\ttokens.set(\"status_purple\", toggle);","\t\ti++;","\t});","};","//--SORT LIST","function sort(order) {","\tvar nOrd = order.sortByProp('pr');","\tCampaign().set(\"turnorder\", JSON.stringify(nOrd));","};","Array.prototype.sortByProp = function(p) {","\treturn this.sort(function(a, b) {","\t\treturn(parseInt(a[p], 10) < parseInt(b[p], 10)) ? 1 : (parseInt(a[p], 10) > parseInt(b[p], 10)) ? -1 : 0;","\t});","};","//--ADDPLAYER","function addPlayer(id, Roll, Attack) {","\tvar inc = Roll / Attack;","\tinc = Math.round(inc * 100) / 100;","\tvar init = Roll;","\tif(Roll > BestRoll) {","\t\tBestRoll = Roll;","\t}","\tvar table = [];","\tfor(var i = 0; i < Attack; i++) {","\t\tif(init >= 0) {","\t\t\tif(init == 0) init = 1;","\t\t\ttable.push(parseInt(init));","\t\t\tinit = (init - inc);","\t\t}","\t}","\toutput = pColor;","\tiName = iName.toUpperCase();","\tturnNums = table.toString();","\tChatSay = iPart + \"background-color:\" + output + \";'>\" + \"<b>\" + iName + \"</b> (Att:\" + Attack + \") (Roll:\" + Roll + \")<br></b><b>\" + turnNums + \"</b></div>\";","\tif(iName == \"UNKNOWN\") ChatSay = \"\";","\tintChat1 = ChatSay;","\tintChat += intChat1;","\tTurnData[id] = {\"Roll\": Roll,\"Attack\": Attack,\"Table\": table};","};","//--CREATE ORDER","function createOrder() {","\tvar order = [];","\tfor(i = (BestRoll + 1); i > 0; i--) {","\t\t_.each(TurnData, function(value, key) {","\t\t\tif(value.Table.indexOf(i) != -1) {","\t\t\t\torder.push({\"id\": key,\"pr\": i,\"custom\": \"\"});","\t\t\t}","\t\t});","\t}","\torder.unshift({\"id\": '-1',\"pr\": 100,\"custom\": \"StartRound\"});","\treturn order;","};","//--RESET TURNS","function reset() {","\tTurnData = {};","\tBestRoll = 0;","\tintChat = '';","};"]}],[{"start":{"row":25,"column":0},"end":{"row":28,"column":5},"action":"remove","lines":["\t\t\t\tif(id1.get(\"layer\") == 'gmlayer') {","\t\t\t\t\tiName = \"UNKNOWN\";","\t\t\t\t\tpColor = '#3D3D3D';","\t\t\t\t}"],"id":846}],[{"start":{"row":25,"column":0},"end":{"row":26,"column":0},"action":"remove","lines":["",""],"id":847}],[{"start":{"row":176,"column":29},"end":{"row":177,"column":0},"action":"insert","lines":["",""],"id":848},{"start":{"row":177,"column":0},"end":{"row":177,"column":1},"action":"insert","lines":["\t"]}],[{"start":{"row":177,"column":1},"end":{"row":180,"column":5},"action":"insert","lines":["\t\t\t\tif(id1.get(\"layer\") == 'gmlayer') {","\t\t\t\t\tiName = \"UNKNOWN\";","\t\t\t\t\tpColor = '#3D3D3D';","\t\t\t\t}"],"id":849}],[{"start":{"row":177,"column":0},"end":{"row":177,"column":1},"action":"remove","lines":["\t"],"id":850},{"start":{"row":178,"column":0},"end":{"row":178,"column":1},"action":"remove","lines":["\t"]},{"start":{"row":179,"column":0},"end":{"row":179,"column":1},"action":"remove","lines":["\t"]}],[{"start":{"row":177,"column":0},"end":{"row":177,"column":1},"action":"remove","lines":["\t"],"id":851},{"start":{"row":178,"column":0},"end":{"row":178,"column":1},"action":"remove","lines":["\t"]},{"start":{"row":179,"column":0},"end":{"row":179,"column":1},"action":"remove","lines":["\t"]}],[{"start":{"row":177,"column":0},"end":{"row":177,"column":1},"action":"remove","lines":["\t"],"id":852},{"start":{"row":178,"column":0},"end":{"row":178,"column":1},"action":"remove","lines":["\t"]},{"start":{"row":179,"column":0},"end":{"row":179,"column":1},"action":"remove","lines":["\t"]}],[{"start":{"row":177,"column":0},"end":{"row":177,"column":1},"action":"remove","lines":["\t"],"id":853},{"start":{"row":178,"column":0},"end":{"row":178,"column":1},"action":"remove","lines":["\t"]},{"start":{"row":179,"column":0},"end":{"row":179,"column":1},"action":"remove","lines":["\t"]}],[{"start":{"row":178,"column":0},"end":{"row":178,"column":1},"action":"insert","lines":["\t"],"id":854},{"start":{"row":179,"column":0},"end":{"row":179,"column":1},"action":"insert","lines":["\t"]}],[{"start":{"row":179,"column":0},"end":{"row":179,"column":21},"action":"remove","lines":["\t\tpColor = '#3D3D3D';"],"id":855}],[{"start":{"row":179,"column":0},"end":{"row":180,"column":0},"action":"remove","lines":["",""],"id":856}],[{"start":{"row":177,"column":35},"end":{"row":177,"column":36},"action":"remove","lines":["{"],"id":857}],[{"start":{"row":177,"column":35},"end":{"row":178,"column":0},"action":"remove","lines":["",""],"id":858}],[{"start":{"row":177,"column":35},"end":{"row":177,"column":36},"action":"remove","lines":["\t"],"id":859}],[{"start":{"row":177,"column":35},"end":{"row":177,"column":36},"action":"remove","lines":["\t"],"id":860}],[{"start":{"row":177,"column":53},"end":{"row":178,"column":0},"action":"remove","lines":["",""],"id":861}],[{"start":{"row":177,"column":53},"end":{"row":177,"column":54},"action":"remove","lines":["\t"],"id":862}],[{"start":{"row":177,"column":53},"end":{"row":177,"column":54},"action":"remove","lines":["\t"],"id":863}],[{"start":{"row":177,"column":53},"end":{"row":177,"column":54},"action":"remove","lines":["\t"],"id":864}],[{"start":{"row":177,"column":53},"end":{"row":177,"column":54},"action":"remove","lines":["\t"],"id":865}],[{"start":{"row":177,"column":53},"end":{"row":177,"column":54},"action":"remove","lines":["}"],"id":866}],[{"start":{"row":25,"column":7},"end":{"row":29,"column":7},"action":"insert","lines":["id1.get(\"layer\") == 'gmlayer') {","\t\t\t\t\tiName = \"UNKNOWN\";","\t\t\t\t\tpColor = '#3D3D3D';","\t\t\t\t}","\t\t\t\tif("],"id":867},{"start":{"row":180,"column":28},"end":{"row":181,"column":52},"action":"remove","lines":[";","\tif(id1.get(\"layer\") == 'gmlayer') iName = \"UNKNOWN\""]}],[{"start":{"row":91,"column":22},"end":{"row":91,"column":24},"action":"remove","lines":["=="],"id":868},{"start":{"row":91,"column":22},"end":{"row":91,"column":23},"action":"insert","lines":["&"]}]]},"ace":{"folds":[],"scrolltop":14,"scrollleft":0,"selection":{"start":{"row":91,"column":22},"end":{"row":91,"column":24},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1463994991000,"hash":"3791483f13ff2267df3c096315a532c0cbdf7dda"}